- critical: false
  description: This policy checks if the extension required for Fleet Desktop is installed and enabled.
  name: Linux - Fleet Desktop extensions enabled
  platform: linux
  query: "SELECT 1 WHERE NOT EXISTS (\n  -- Policy succeeds on Linux distributions that are not Fedora, Debian, or OpenSUSE.\n  SELECT 1 FROM os_version WHERE \n    name = 'Fedora Linux' OR \n    platform = 'debian' OR \n    name LIKE '%openSUSE%' OR \n    platform = 'opensuse-leap' OR \n    platform = 'opensuse-tumbleweed'\n) OR NOT EXISTS (\n  -- Policy succeeds on Linux hosts that do not have Fleet Desktop enabled or\n  -- Fleet Desktop is not running (e.g. logged out from GUI).\n  SELECT 1 FROM processes WHERE name = 'fleet-desktop' LIMIT 1\n) OR EXISTS (\n  WITH fleet_desktop AS (SELECT TRIM(cwd, '/home/') AS username, cwd AS home FROM processes WHERE name = 'fleet-desktop' LIMIT 1)\n  SELECT 1 WHERE EXISTS (\n    -- Check if the extension is installed.\n    SELECT 1 FROM file WHERE path = CONCAT((SELECT home FROM fleet_desktop), '/.local/share/gnome-shell/extensions/appindicatorsupport@rgcjonas.gmail.com') AND type = 'directory'\n  ) AND EXISTS (\n    -- Check if the extension is enabled.\n    SELECT 1 FROM dconf_read WHERE \n      username = (SELECT fleet_desktop.username FROM fleet_desktop) AND \n      key = '/org/gnome/shell/enabled-extensions' AND \n      value like '%appindicatorsupport@rgcjonas.gmail.com%'\n  )\n);\n"
  resolution: |
    Install and enable the AppIndicator extension by running the following commands on a terminal (as user, not root):

    gdbus call --session \
      --dest org.gnome.Shell.Extensions \
      --object-path /org/gnome/Shell/Extensions \
      --method org.gnome.Shell.Extensions.InstallRemoteExtension \
      "appindicatorsupport@rgcjonas.gmail.com"
    gnome-extensions enable "appindicatorsupport@rgcjonas.gmail.com"
  run_script:
    path: ../scripts/install-fleet-desktop-required-extension.sh
