- critical: true
  description: 'Failing this policy indicates that Windows Defender service is not running, or one or more of the following features are disabled: real-time protection, behavior monitoring, cloud protection (MAPS), or script scanning. This could leave your device vulnerable to malware, spyware, and other security threats.'
  name: Windows - Windows Defender compliance check
  platform: windows
  query: "WITH defender_service AS (\n    SELECT \n        CASE \n            WHEN COUNT(CASE WHEN name = 'IsServiceRunning' AND data = 1 THEN 1 END) > 0 THEN 1\n            ELSE 0\n        END as service_running\n    FROM registry \n    WHERE key = 'HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows Defender'\n),\ndefender_realtime AS (\n    SELECT \n        CASE \n            WHEN COUNT(CASE WHEN name = 'DisableRealtimeMonitoring' THEN 1 END) = 0 THEN 1\n            WHEN MAX(CASE WHEN name = 'DisableRealtimeMonitoring' AND data = 0 THEN 1 ELSE 0 END) = 1 THEN 1\n            ELSE 0\n        END as realtime_enabled\n    FROM registry \n    WHERE key = 'HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows Defender\\Real-Time Protection'\n),\ndefender_behavior AS (\n    SELECT \n        CASE \n            WHEN COUNT(CASE WHEN name = 'DisableBehaviorMonitoring' THEN 1 END) = 0 THEN 1\n            WHEN MAX(CASE WHEN name = 'DisableBehaviorMonitoring' AND data = 0 THEN 1 ELSE 0 END) = 1 THEN 1\n            ELSE 0\n        END as behavior_enabled\n    FROM registry \n    WHERE key = 'HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows Defender\\Real-Time Protection'\n),\ndefender_cloud AS (\n    SELECT \n        CASE \n            WHEN COUNT(CASE WHEN name = 'SpyNetReporting' THEN 1 END) = 0 THEN 1\n            WHEN MAX(CASE WHEN name = 'SpyNetReporting' AND data > 0 THEN 1 ELSE 0 END) = 1 THEN 1\n            ELSE 0\n        END as cloud_enabled\n    FROM registry \n    WHERE key = 'HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows Defender\\Spynet'\n),\ndefender_script AS (\n    SELECT \n        CASE \n            WHEN COUNT(CASE WHEN name = 'DisableScriptScanning' THEN 1 END) = 0 THEN 1\n            WHEN MAX(CASE WHEN name = 'DisableScriptScanning' AND data = 0 THEN 1 ELSE 0 END) = 1 THEN 1\n            ELSE 0\n        END as script_enabled\n    FROM registry \n    WHERE key = 'HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows Defender\\Real-Time Protection'\n)\nSELECT \n    CASE \n        WHEN (SELECT service_running FROM defender_service) = 1 \n         AND (SELECT realtime_enabled FROM defender_realtime) = 1 \n         AND (SELECT behavior_enabled FROM defender_behavior) = 1 \n         AND (SELECT cloud_enabled FROM defender_cloud) = 1 \n         AND (SELECT script_enabled FROM defender_script) = 1 \n        THEN 1\n        ELSE 0\n    END as policy_compliance;\n"
  resolution: 'Corrective actions include ensuring the Windows Defender service is running and that real-time protection, behavior monitoring, cloud protection, and script scanning are all enabled. Check that the MDM configuration profile has been applied successfully. If these actions are not successful, try rebooting before sending a message to #help-dogfooding in Slack.'
