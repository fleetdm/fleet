/** software/vulnerabilities/:cve > Vulnerable software section */

import React, { useCallback, useMemo } from "react";

import { InjectedRouter } from "react-router";
import { Row } from "react-table";

import { IVulnerabilityResponse } from "services/entities/vulnerabilities";

import PATHS from "router/paths";
import { getPathWithQueryParams } from "utilities/url";

import Card from "components/Card";
import TableContainer from "components/TableContainer";
import TableCount from "components/TableContainer/TableCount";

import generateColumnConfigs from "./SwVulnSwTableConfig";

const baseClass = "software-vuln-software-versions";

interface IRowProps extends Row {
  original: {
    id?: number;
    software_title_id?: number;
  };
}

interface ISoftwareVulnSoftwareVersions {
  vulnSoftware: IVulnerabilityResponse["software"];
  isPremiumTier: boolean;
  router: InjectedRouter;
  teamIdForApi?: number;
}

const SoftwareVulnSoftwareVersions = ({
  vulnSoftware,
  isPremiumTier,
  router,
  teamIdForApi,
}: ISoftwareVulnSoftwareVersions) => {
  const columnConfigs = useMemo(
    () => generateColumnConfigs(isPremiumTier, router, teamIdForApi),
    [isPremiumTier, router, teamIdForApi]
  );

  const handleRowSelect = (row: IRowProps) => {
    const { software_title_id, id } = row.original;
    const targetId = software_title_id || id;
    if (targetId) {
      const path = getPathWithQueryParams(
        software_title_id
          ? PATHS.SOFTWARE_TITLE_DETAILS(software_title_id.toString())
          : PATHS.SOFTWARE_VERSION_DETAILS(id!.toString()),
        {
          team_id: teamIdForApi,
        }
      );

      router.push(path);
    }
  };

  const renderVulnerableSoftwareCount = useCallback(() => {
    return <TableCount name="items" count={vulnSoftware?.length} />;
  }, [vulnSoftware?.length]);

  const renderVulnerableSoftwareTable = () => {
    return (
      <TableContainer
        columnConfigs={columnConfigs}
        data={vulnSoftware}
        defaultSortHeader="hosts"
        defaultSortDirection="desc"
        isClientSidePagination
        isLoading={false} // not rendered otherwise
        emptyComponent={() => <></>}
        showMarkAllPages={false}
        isAllPagesSelected={false}
        disableMultiRowSelect
        onSelectSingleRow={handleRowSelect}
        renderCount={renderVulnerableSoftwareCount}
      />
    );
  };
  return (
    <Card borderRadiusSize="xxlarge" className={`${baseClass}`}>
      <h2>Vulnerable software</h2>
      {renderVulnerableSoftwareTable()}
    </Card>
  );
};

export default SoftwareVulnSoftwareVersions;
