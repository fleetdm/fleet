import React from "react";

import { CellProps, Column } from "react-table";

import { IVulnerabilityOSVersion } from "interfaces/operating_system";

import LinkCell from "components/TableContainer/DataTable/LinkCell";

import PATHS from "router/paths";
import SoftwareIcon from "pages/SoftwarePage/components/icons/SoftwareIcon";
import TextCell from "components/TableContainer/DataTable/TextCell";
import ViewAllHostsLink from "components/ViewAllHostsLink";
import { InjectedRouter } from "react-router";
import {
  INumberCellProps,
  IStringCellProps,
} from "interfaces/datatable_config";
import { getPathWithQueryParams } from "utilities/url";

type ISWVulnTableColumnConfig = Column<IVulnerabilityOSVersion>;

type ITableStringCellProps = IStringCellProps<IVulnerabilityOSVersion>;
type ITableNumberCellProps = INumberCellProps<IVulnerabilityOSVersion>;
type IViewAllHostsLinkProps = CellProps<IVulnerabilityOSVersion>;

const generateColumnConfigs = (
  isPremiumTier: boolean,
  router: InjectedRouter,
  teamIdForApi?: number
): ISWVulnTableColumnConfig[] => {
  const configs: ISWVulnTableColumnConfig[] = [
    {
      Header: "Name",
      disableSortBy: true,
      accessor: "name_only",
      Cell: ({ row }: ITableStringCellProps) => {
        const { name, os_version_id, platform } = row.original;
        // since No Teams not supported on this page, falsiness of 0 is okay
        const path = getPathWithQueryParams(
          PATHS.SOFTWARE_OS_DETAILS(os_version_id),
          { team_id: teamIdForApi }
        );

        return (
          <LinkCell
            path={path}
            tooltipTruncate
            prefix={<SoftwareIcon name={platform} />}
            value={name}
          />
        );
      },
    },
    {
      Header: "Version",
      disableSortBy: true,
      accessor: "version",
      Cell: ({ cell }: ITableStringCellProps) => (
        <TextCell value={cell.value} />
      ),
    },
    {
      Header: () => (
        <>
          Resolved in <div className="resolved-suffix">version</div>
        </>
      ),
      disableSortBy: true,
      accessor: "resolved_in_version",
      Cell: ({ cell }: ITableStringCellProps) => (
        <TextCell value={cell.value} />
      ),
    },
    {
      Header: "Hosts",
      disableSortBy: true,
      accessor: "hosts_count",
      Cell: ({ row }: ITableNumberCellProps) => {
        const { hosts_count } = row.original;
        return <TextCell value={hosts_count} />;
      },
    },
    {
      Header: "",
      id: "view-all-hosts",
      disableSortBy: true,
      Cell: (cellProps: IViewAllHostsLinkProps) => {
        return (
          <>
            {cellProps.row.original && (
              <ViewAllHostsLink
                queryParams={{
                  os_version_id: cellProps.row.original.os_version_id,
                }}
                responsive
                rowHover
              />
            )}
          </>
        );
      },
    },
  ];

  if (!isPremiumTier) {
    return configs.filter(
      (header) => header.accessor !== "resolved_in_version"
    );
  }

  return configs;
};

export default generateColumnConfigs;
