/**
 * Copyright (c) 2020-present, The kubequery authors
 *
 * This source code is licensed as defined by the LICENSE file found in the
 * root directory of this source tree.
 *
 * SPDX-License-Identifier: (Apache-2.0 OR GPL-2.0-only)
 */

package core

import (
	"context"
	"testing"

	"github.com/Uptycs/basequery-go/plugin/table"
	"github.com/stretchr/testify/assert"
)

func TestNodesGenerate(t *testing.T) {
	ns, err := NodesGenerate(context.TODO(), table.QueryContext{})
	assert.Nil(t, err)
	assert.Equal(t, []map[string]string{
		{
			"addresses":          "[{\"type\":\"InternalIP\",\"address\":\"192.168.0.28\"},{\"type\":\"Hostname\",\"address\":\"seshu\"}]",
			"allocatable":        "{\"cpu\":\"12\",\"ephemeral-storage\":\"958151776Ki\",\"hugepages-1Gi\":\"0\",\"hugepages-2Mi\":\"0\",\"memory\":\"32411744Ki\",\"pods\":\"110\"}",
			"annotations":        "{\"node.alpha.kubernetes.io/ttl\":\"0\",\"projectcalico.org/IPv4Address\":\"192.168.192.1/20\",\"projectcalico.org/IPv4VXLANTunnelAddr\":\"10.1.26.0\",\"volumes.kubernetes.io/controller-managed-attach-detach\":\"true\"}",
			"capacity":           "{\"cpu\":\"12\",\"ephemeral-storage\":\"959200352Ki\",\"hugepages-1Gi\":\"0\",\"hugepages-2Mi\":\"0\",\"memory\":\"32514144Ki\",\"pods\":\"110\"}",
			"cluster_uid":        "d7fd8e77-93de-4742-9037-5db9a01e966a",
			"conditions":         "[{\"type\":\"NetworkUnavailable\",\"status\":\"False\",\"lastHeartbeatTime\":\"2021-01-20T16:31:53Z\",\"lastTransitionTime\":\"2021-01-20T16:31:53Z\",\"reason\":\"CalicoIsUp\",\"message\":\"Calico is running on this node\"},{\"type\":\"MemoryPressure\",\"status\":\"False\",\"lastHeartbeatTime\":\"2021-01-21T19:24:08Z\",\"lastTransitionTime\":\"2021-01-12T18:30:24Z\",\"reason\":\"KubeletHasSufficientMemory\",\"message\":\"kubelet has sufficient memory available\"},{\"type\":\"DiskPressure\",\"status\":\"False\",\"lastHeartbeatTime\":\"2021-01-21T19:24:08Z\",\"lastTransitionTime\":\"2021-01-12T18:30:24Z\",\"reason\":\"KubeletHasNoDiskPressure\",\"message\":\"kubelet has no disk pressure\"},{\"type\":\"PIDPressure\",\"status\":\"False\",\"lastHeartbeatTime\":\"2021-01-21T19:24:08Z\",\"lastTransitionTime\":\"2021-01-12T18:30:24Z\",\"reason\":\"KubeletHasSufficientPID\",\"message\":\"kubelet has sufficient PID available\"},{\"type\":\"Ready\",\"status\":\"True\",\"lastHeartbeatTime\":\"2021-01-21T19:24:08Z\",\"lastTransitionTime\":\"2021-01-21T01:12:31Z\",\"reason\":\"KubeletReady\",\"message\":\"kubelet is posting ready status. AppArmor enabled\"}]",
			"creation_timestamp": "1610476224",
			"daemon_endpoints":   "{\"kubeletEndpoint\":{\"Port\":10250}}",
			"images":             "[{\"names\":[\"docker.io/library/kubequery:latest\"],\"sizeBytes\":202523444},{\"names\":null,\"sizeBytes\":174592418},{\"names\":[\"k8s.gcr.io/ingress-nginx/controller@sha256:fc4979d8b8443a831c9789b5155cded454cb7de737a8b727bc2ba0106d2eae8b\",\"k8s.gcr.io/ingress-nginx/controller:v0.35.0\"],\"sizeBytes\":111763794},{\"names\":[\"docker.io/istio/proxyv2@sha256:3ad9ee2b43b299e5e6d97aaea5ed47dbf3da9293733607d9b52f358313e852ae\",\"docker.io/istio/proxyv2:1.5.1\"],\"sizeBytes\":106728139},{\"names\":[\"docker.io/jaegertracing/jaeger-operator@sha256:5a3198179f7972028a29dd7fbf71ac7a21e0dbf46c85e8cc2c37e3b6a5ee26a4\",\"docker.io/jaegertracing/jaeger-operator:1.14.0\"],\"sizeBytes\":99946252},{\"names\":[\"docker.io/calico/node@sha256:cb9dea7b86471c71925ae318f7c60af72d9ddf1dab0fe2029832a671b83bba6a\",\"docker.io/calico/node:v3.13.2\"],\"sizeBytes\":88917441},{\"names\":[\"docker.io/istio/mixer@sha256:92940f04e9aa20a41e330eb8a00a0b8ee7a3f4029dcdadfca4a5d009774474b2\",\"docker.io/istio/mixer:1.5.1\"],\"sizeBytes\":86988340},{\"names\":[\"docker.io/istio/pilot@sha256:818aecc1c73c53af9091ac1d4f500d9d7cec6d135d372d03cffab1addaff4ec0\",\"docker.io/istio/pilot:1.5.1\"],\"sizeBytes\":85950908},{\"names\":[\"docker.io/uptycs/kubequery@sha256:96b6c15753941f58e97fc6f80ee7ec06ce63d48a14b53ee0cc1dd10dc3585e7d\",\"docker.io/uptycs/kubequery:latest\"],\"sizeBytes\":82661645},{\"names\":[\"docker.io/istio/galley@sha256:d69acf890e5c82cb0c000fc15c540777ee566ae225762d85f157f69c9665338c\",\"docker.io/istio/galley:1.5.1\"],\"sizeBytes\":82020368},{\"names\":[\"docker.io/istio/sidecar_injector@sha256:cf334211f192378e7fcb66baeeb43412e483e34d739e93711d0a61568dd00462\",\"docker.io/istio/sidecar_injector:1.5.1\"],\"sizeBytes\":77988679},{\"names\":[\"docker.io/calico/cni@sha256:bbf7e3ac3f80d0a356a6c27b095bd313d1106f8ed84f85850816ed79295843c1\",\"docker.io/calico/cni:v3.13.2\"],\"sizeBytes\":76710099},{\"names\":[\"docker.io/istio/kubectl@sha256:83ea57063cf3344a2462c5bbaa5b125810f2e8ef7283d2ba3bfd9393e624b80f\",\"docker.io/istio/kubectl:1.5.1\"],\"sizeBytes\":76608582},{\"names\":[\"docker.io/grafana/grafana@sha256:bd55ea2bad17f5016431734b42fdfc202ebdc7d08b6c4ad35ebb03d06efdff69\",\"docker.io/grafana/grafana:6.4.3\"],\"sizeBytes\":76169588},{\"names\":[\"quay.io/kiali/kiali:v1.9\"],\"sizeBytes\":75529164},{\"names\":[\"docker.io/istio/citadel@sha256:92b985411af9844b75c5fc9c39c33fc27ef549c31b5221358f334062aadb86ec\",\"docker.io/istio/citadel:1.5.1\"],\"sizeBytes\":72604439},{\"names\":[\"docker.io/kubernetesui/dashboard@sha256:06868692fb9a7f2ede1a06de1b7b32afabc40ec739c1181d83b5ed3eb147ec6e\",\"docker.io/kubernetesui/dashboard:v2.0.0\"],\"sizeBytes\":66209190},{\"names\":[\"docker.io/grafana/grafana@sha256:89304bc2335f4976618548d7b93d165ed67369d3a051d2f627fc4e0aa3d0aff1\",\"docker.io/grafana/grafana:7.1.0\"],\"sizeBytes\":59911815},{\"names\":[\"quay.io/prometheus/prometheus@sha256:d4ba4dd1a9ebb90916d0bfed3c204adcb118ed24546bf8dd2e6b30fc0fd2009e\",\"quay.io/prometheus/prometheus:v2.20.0\"],\"sizeBytes\":59435495},{\"names\":[\"docker.io/prom/prometheus@sha256:cd93b8711bb92eb9c437d74217311519e0a93bc55779aa664325dc83cd13cb32\",\"docker.io/prom/prometheus:v2.12.0\"],\"sizeBytes\":54819393},{\"names\":[\"docker.io/calico/pod2daemon-flexvol@sha256:0022da5a9a89512f8a117f12d2088b3f1f8f22c094ee15aae24d58085f2c186a\",\"docker.io/calico/pod2daemon-flexvol:v3.13.2\"],\"sizeBytes\":37530211},{\"names\":[\"quay.io/prometheus/alertmanager@sha256:24a5204b418e8fa0214cfb628486749003b039c279c56b5bddb5b10cd100d926\",\"quay.io/prometheus/alertmanager:v0.21.0\"],\"sizeBytes\":27097956},{\"names\":[\"docker.io/jaegertracing/all-in-one@sha256:738442983b772a5d413c8a2c44a5563956adaff224e5b38f52a959124dafc119\",\"docker.io/jaegertracing/all-in-one:1.16\"],\"sizeBytes\":23571671},{\"names\":[\"docker.io/directxman12/k8s-prometheus-adapter@sha256:44558d3ae98467e44fee72ebc3948ce59630996013a51d49cf925682a7b87c18\",\"docker.io/directxman12/k8s-prometheus-adapter:v0.7.0\"],\"sizeBytes\":23407634},{\"names\":[\"docker.io/jaegertracing/all-in-one@sha256:021aefafecbb5559078206996f1f4e8fc5907debab047f4fcc5c837689a66cfa\",\"docker.io/jaegertracing/all-in-one:1.14.0\"],\"sizeBytes\":23208939},{\"names\":[\"docker.io/calico/kube-controllers@sha256:a635173cbe9deb33deba9baadffd933f61c63fbdadc0e3fa60ff1a14198c1da8\",\"docker.io/calico/kube-controllers:v3.13.2\"],\"sizeBytes\":23132265},{\"names\":[\"quay.io/brancz/kube-rbac-proxy@sha256:05e15e1164fd7ac85f5702b3f87ef548f4e00de3a79e6c4a6a34c92035497a9a\",\"quay.io/brancz/kube-rbac-proxy:v0.8.0\"],\"sizeBytes\":19991394},{\"names\":[\"docker.io/kubernetesui/metrics-scraper@sha256:555981a24f184420f3be0c79d4efb6c948a85cfce84034f85a563f4151a81cbf\",\"docker.io/kubernetesui/metrics-scraper:v1.0.4\"],\"sizeBytes\":16020077},{\"names\":[\"docker.io/coredns/coredns@sha256:41bee6992c2ed0f4628fcef75751048927bcd6b1cee89c79f6acb63ca5474d5a\",\"docker.io/coredns/coredns:1.6.6\"],\"sizeBytes\":12932169},{\"names\":[\"quay.io/coreos/prometheus-operator@sha256:a54e806fb27d2fb0251da4f3b2a3bb5320759af63a54a755788304775f2384a7\",\"quay.io/coreos/prometheus-operator:v0.40.0\"],\"sizeBytes\":12496211},{\"names\":[\"quay.io/prometheus/node-exporter@sha256:a2f29256e53cc3e0b64d7a472512600b2e9410347d53cdc85b49f659c17e02ee\",\"quay.io/prometheus/node-exporter:v0.18.1\"],\"sizeBytes\":11122661},{\"names\":[\"gcr.io/k8s-staging-kube-state-metrics/kube-state-metrics@sha256:9718f2e7999e75f4993e312fccada801c0eb98eaba73db072f0f806d67fcc238\",\"gcr.io/k8s-staging-kube-state-metrics/kube-state-metrics:v1.9.7\"],\"sizeBytes\":10782953},{\"names\":[\"k8s.gcr.io/metrics-server-amd64@sha256:c9c4e95068b51d6b33a9dccc61875df07dc650abbf4ac1a19d58b4628f89288b\",\"k8s.gcr.io/metrics-server-amd64:v0.3.6\"],\"sizeBytes\":10542830},{\"names\":[\"docker.io/cdkbot/hostpath-provisioner-amd64@sha256:339f78eabc68ffb1656d584e41f121cb4d2b667565428c8dde836caf5b8a0228\",\"docker.io/cdkbot/hostpath-provisioner-amd64:1.0.0\"],\"sizeBytes\":9745308},{\"names\":[\"quay.io/coreos/prometheus-config-reloader@sha256:c679a143b24b7731ad1577a9865aa3805426cbf1b25e30807b951dff68466ffd\",\"quay.io/coreos/prometheus-config-reloader:v0.40.0\"],\"sizeBytes\":4254190},{\"names\":[\"docker.io/jimmidyson/configmap-reload@sha256:d107c7a235c266273b1c3502a391fec374430e5625539403d0de797fa9c556a2\",\"docker.io/jimmidyson/configmap-reload:v0.3.0\"],\"sizeBytes\":4063371},{\"names\":[\"k8s.gcr.io/pause@sha256:f78411e19d84a252e53bff71a4407a5686c46983a2c2eeed83929b888179acea\",\"k8s.gcr.io/pause:3.1\"],\"sizeBytes\":317164}]",
			"labels":             "{\"beta.kubernetes.io/arch\":\"amd64\",\"beta.kubernetes.io/os\":\"linux\",\"kubernetes.io/arch\":\"amd64\",\"kubernetes.io/hostname\":\"seshu\",\"kubernetes.io/os\":\"linux\",\"microk8s.io/cluster\":\"true\"}",
			"name":               "seshu",
			"node_info":          "{\"machineID\":\"c73ef4a4ef2a4ec19a75719b63db3bb7\",\"systemUUID\":\"4c4c4544-0044-3510-8058-c6c04f5a5932\",\"bootID\":\"0b51cb6f-120b-4557-b74a-e53a5f4f00d5\",\"kernelVersion\":\"5.4.0-60-generic\",\"osImage\":\"Ubuntu 20.04.1 LTS\",\"containerRuntimeVersion\":\"containerd://1.3.7\",\"kubeletVersion\":\"v1.20.1-34+e7db93d188d0d1\",\"kubeProxyVersion\":\"v1.20.1-34+e7db93d188d0d1\",\"operatingSystem\":\"linux\",\"architecture\":\"amd64\"}",
			"uid":                "d0d45111-421d-4d4f-89c9-3e75ca2dc06c",
			"unschedulable":      "0",
		},
	}, ns)
}
