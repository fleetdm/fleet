---
apiVersion: v1
kind: policy
spec:
  name: CIS Ubuntu 22.04 - 1.1.1.1 Ensure cramfs kernel module is not available (Automated)
  platforms: linux
  platform: linux
  description: Ensure cramfs kernel module is not available (Automated)
  resolution: |
    Create /etc/modprobe.d/cramfs.conf with blacklist + install rules to prevent loading cramfs.
  # QA Validation:
  # - Where: Run on the audited Ubuntu 22.04 host (use a disposable VM for FAIL).
  # - PASS (run):
  #   - sudo bash -c 'cat <<EOF > /etc/modprobe.d/cramfs.conf
# blacklist cramfs
# install cramfs /bin/false
# EOF'
  #   - sudo modprobe -r cramfs 2>/dev/null || true
  # - FAIL (run):
  #   - sudo rm -f /etc/modprobe.d/cramfs.conf
  #   - (optional) sudo modprobe cramfs 2>/dev/null || true
  # - Expected:
  #   - PASS: query returns 1 row
  #   - FAIL: query returns 0 rows
  query: |
    SELECT 1
    WHERE (SELECT COUNT(*) FROM kernel_modules WHERE name='cramfs') = 0
      AND (SELECT COUNT(*) FROM file_contents
           WHERE path LIKE '/etc/modprobe.d/%.conf'
             AND contents LIKE '%blacklist cramfs%'
             
           AND contents NOT LIKE '%#%blacklist cramfs%'
       ) >= 1
      AND (SELECT COUNT(*) FROM file_contents
           WHERE path LIKE '/etc/modprobe.d/%.conf'
             AND (contents LIKE '%install cramfs /bin/false%' OR contents LIKE '%install cramfs /bin/true%')
             
           AND contents NOT LIKE '%#%blacklist cramfs%'
           AND contents NOT LIKE '%#%install cramfs /bin/false%'
           AND contents NOT LIKE '%#%install cramfs /bin/true%'
       ) >= 1;
  purpose: Informational
  tags: compliance, CIS, CIS_Ubuntu_22_04
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS Ubuntu 22.04 - 1.1.1.2 Ensure freevxfs kernel module is not available (Automated)
  platforms: linux
  platform: linux
  description: Ensure freevxfs kernel module is not available (Automated)
  resolution: |
    Create /etc/modprobe.d/freevxfs.conf with blacklist + install rules to prevent loading freevxfs.
  # QA Validation:
  # - Where: Run on the audited Ubuntu 22.04 host (use a disposable VM for FAIL).
  # - PASS (run):
  #   - sudo bash -c "printf '%s\n' 'blacklist freevxfs' 'install freevxfs /bin/false' > /etc/modprobe.d/freevxfs.conf"
  #   - sudo modprobe -r freevxfs 2>/dev/null || true
  # - FAIL (run):
  #   - sudo rm -f /etc/modprobe.d/freevxfs.conf
  #   - (optional) sudo modprobe freevxfs 2>/dev/null || true
  # - Expected:
  #   - PASS: query returns 1 row
  #   - FAIL: query returns 0 rows
  query: |
    SELECT 1
    WHERE (SELECT COUNT(*) FROM kernel_modules WHERE name='freevxfs') = 0
      AND (SELECT COUNT(*) FROM file_contents
           WHERE path LIKE '/etc/modprobe.d/%.conf'
             AND contents LIKE '%blacklist freevxfs%'
             AND contents NOT LIKE '%#%') >= 1
      AND (SELECT COUNT(*) FROM file_contents
           WHERE path LIKE '/etc/modprobe.d/%.conf'
             AND (contents LIKE '%install freevxfs /bin/false%' OR contents LIKE '%install freevxfs /bin/true%')
             AND contents NOT LIKE '%#%') >= 1;
  purpose: Informational
  tags: compliance, CIS, CIS_Ubuntu_22_04
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS Ubuntu 22.04 - 1.1.1.4 Ensure hfsplus kernel module is not available (Automated)
  platforms: linux
  platform: linux
  description: Ensure hfsplus kernel module is not available (Automated)
  resolution: |
    Create /etc/modprobe.d/hfs.conf with blacklist + install rules to prevent loading hfs.
  # QA Validation:
  # - Where: Run on the audited Ubuntu 22.04 host (use a disposable VM for FAIL).
  # - PASS (run):
  #   - sudo bash -c "printf '%s\n' 'blacklist hfs' 'install hfs /bin/false' > /etc/modprobe.d/hfs.conf"
  #   - sudo modprobe -r hfs 2>/dev/null || true
  # - FAIL (run):
  #   - sudo rm -f /etc/modprobe.d/hfs.conf
  #   - (optional) sudo modprobe hfs 2>/dev/null || true
  # - Expected:
  #   - PASS: query returns 1 row
  #   - FAIL: query returns 0 rows
  query: |
    SELECT 1
    WHERE (SELECT COUNT(*) FROM kernel_modules WHERE name='hfs') = 0
      AND (SELECT COUNT(*) FROM file_contents
           WHERE path LIKE '/etc/modprobe.d/%.conf'
             AND contents LIKE '%blacklist hfs%'
             AND contents NOT LIKE '%#%') >= 1
      AND (SELECT COUNT(*) FROM file_contents
           WHERE path LIKE '/etc/modprobe.d/%.conf'
             AND (contents LIKE '%install hfs /bin/false%' OR contents LIKE '%install hfs /bin/true%')
             AND contents NOT LIKE '%#%') >= 1;
  purpose: Informational
  tags: compliance, CIS, CIS_Ubuntu_22_04
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS Ubuntu 22.04 - 1.1.1.5 Ensure jffs2 kernel module is not available (Automated)
  platforms: linux
  platform: linux
  description: Ensure jffs2 kernel module is not available (Automated)
  resolution: |
    Create /etc/modprobe.d/hfsplus.conf with blacklist + install rules to prevent loading hfsplus.
  # QA Validation:
  # - Where: Run on the audited Ubuntu 22.04 host (use a disposable VM for FAIL).
  # - PASS (run):
  #   - sudo bash -c "printf '%s\n' 'blacklist hfsplus' 'install hfsplus /bin/false' > /etc/modprobe.d/hfsplus.conf"
  #   - sudo modprobe -r hfsplus 2>/dev/null || true
  # - FAIL (run):
  #   - sudo rm -f /etc/modprobe.d/hfsplus.conf
  #   - (optional) sudo modprobe hfsplus 2>/dev/null || true
  # - Expected:
  #   - PASS: query returns 1 row
  #   - FAIL: query returns 0 rows
  query: |
    SELECT 1
    WHERE (SELECT COUNT(*) FROM kernel_modules WHERE name='hfsplus') = 0
      AND (SELECT COUNT(*) FROM file_contents
           WHERE path LIKE '/etc/modprobe.d/%.conf'
             AND contents LIKE '%blacklist hfsplus%'
             AND contents NOT LIKE '%#%') >= 1
      AND (SELECT COUNT(*) FROM file_contents
           WHERE path LIKE '/etc/modprobe.d/%.conf'
             AND (contents LIKE '%install hfsplus /bin/false%' OR contents LIKE '%install hfsplus /bin/true%')
             AND contents NOT LIKE '%#%') >= 1;
  purpose: Informational
  tags: compliance, CIS, CIS_Ubuntu_22_04
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS Ubuntu 22.04 - 1.1.1.6 Ensure overlay kernel module is not available (Automated)
  platforms: linux
  platform: linux
  description: Ensure overlay kernel module is not available (Automated)
  resolution: |
    Create /etc/modprobe.d/udf.conf with blacklist + install rules to prevent loading udf.
  # QA Validation:
  # - Where: Run on the audited Ubuntu 22.04 host (use a disposable VM for FAIL).
  # - PASS (run):
  #   - sudo bash -c "printf '%s\n' 'blacklist udf' 'install udf /bin/false' > /etc/modprobe.d/udf.conf"
  #   - sudo modprobe -r udf 2>/dev/null || true
  # - FAIL (run):
  #   - sudo rm -f /etc/modprobe.d/udf.conf
  #   - (optional) sudo modprobe udf 2>/dev/null || true
  # - Expected:
  #   - PASS: query returns 1 row
  #   - FAIL: query returns 0 rows
  query: |
    SELECT 1
    WHERE (SELECT COUNT(*) FROM kernel_modules WHERE name='udf') = 0
      AND (SELECT COUNT(*) FROM file_contents
           WHERE path LIKE '/etc/modprobe.d/%.conf'
             AND contents LIKE '%blacklist udf%'
             AND contents NOT LIKE '%#%') >= 1
      AND (SELECT COUNT(*) FROM file_contents
           WHERE path LIKE '/etc/modprobe.d/%.conf'
             AND (contents LIKE '%install udf /bin/false%' OR contents LIKE '%install udf /bin/true%')
             AND contents NOT LIKE '%#%') >= 1;
  purpose: Informational
  tags: compliance, CIS, CIS_Ubuntu_22_04
  contributors: sharon-fdm
