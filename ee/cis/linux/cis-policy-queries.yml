---
apiVersion: v1
kind: policy
spec:
  name: CIS Ubuntu 22.04 - 1.1.1.1 Ensure cramfs kernel module is not available (Automated)
  platforms: linux
  platform: linux
  description: Ensure cramfs kernel module is not available (Automated)
  resolution: |
    Create /etc/modprobe.d/cramfs.conf with blacklist + install rules to prevent loading cramfs.
  # QA Validation:
  # - Where: Run on the audited Ubuntu 22.04 host (use a disposable VM for FAIL).
  # - PASS (run):
  #   - sudo bash -c 'cat <<EOF > /etc/modprobe.d/cramfs.conf
# blacklist cramfs
# install cramfs /bin/false
# EOF'
  #   - sudo modprobe -r cramfs 2>/dev/null || true
  # - FAIL (run):
  #   - sudo rm -f /etc/modprobe.d/cramfs.conf
  #   - (optional) sudo modprobe cramfs 2>/dev/null || true
  # - Expected:
  #   - PASS: query returns 1 row
  #   - FAIL: query returns 0 rows
  query: |
    SELECT 1
    WHERE (SELECT COUNT(*) FROM kernel_modules WHERE name='cramfs') = 0
      AND (SELECT COUNT(*) FROM file_contents
           WHERE path LIKE '/etc/modprobe.d/%.conf'
             AND contents LIKE '%blacklist cramfs%'
             
           AND contents NOT LIKE '%#%blacklist cramfs%'
       ) >= 1
      AND (SELECT COUNT(*) FROM file_contents
           WHERE path LIKE '/etc/modprobe.d/%.conf'
             AND (contents LIKE '%install cramfs /bin/false%' OR contents LIKE '%install cramfs /bin/true%')
             
           AND contents NOT LIKE '%#%blacklist cramfs%'
           AND contents NOT LIKE '%#%install cramfs /bin/false%'
           AND contents NOT LIKE '%#%install cramfs /bin/true%'
       ) >= 1;
  purpose: Informational
  tags: compliance, CIS, CIS_Ubuntu_22_04
  contributors: sharon-fdm
