---
# The latest version of CIS Benchmarks for macOS as of January 2023 was used which was benchmark 1.0 for macOS 13.0 https://workbench.cisecurity.org/benchmarks/10541
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure All Apple-provided Software Is Current
  platforms: macOS
  platform: darwin
  description: Checks that the current version of macOS is up to date. This query requires maintenance over time.
  resolution: "Go to System Settings/Software Update and install the latest updates manually"
  query: SELECT 1 FROM os_version WHERE version >= '13.1';
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS1.1
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Auto Update Is Enabled (MDM Required)
  platforms: macOS
  platform: darwin
  description: Checks that the system is configured via MDM to automatically install updates.
  resolution: "Ask your system administrator to deploy an MDM profile that enables automatic updates."
  query: SELECT 1 FROM managed_policies WHERE domain='com.apple.SoftwareUpdate' AND name='AutomaticCheckEnabled' AND value=1 LIMIT 1;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS1.2
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Download New Updates When Available Is Enabled (MDM Required)
  platforms: macOS
  platform: darwin
  description: Checks that the system is configured via MDM to automatically download updates.
  resolution: "Ask your system administrator to deploy an MDM profile that enables automatic update downloads."
  query: SELECT 1 FROM managed_policies WHERE domain='com.apple.SoftwareUpdate' AND name='AutomaticDownload' AND value=1 LIMIT 1;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS1.3
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Install of macOS Updates Is Enabled (MDM Required)
  platforms: macOS
  platform: darwin
  description: Ensure that macOS updates are installed after they are available from Apple.
  resolution: "Ask your system administrator to deploy an MDM profile that enables automatic install of macOS updates."
  query: SELECT 1 FROM managed_policies WHERE domain='com.apple.SoftwareUpdate' AND name='AutomaticallyInstallMacOSUpdates' AND value=1 LIMIT 1;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS1.4
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Install Application Updates from the App Store Is Enabled (MDM Required)
  platforms: macOS
  platform: darwin
  description: Ensure that application updates are installed after they are available from Apple.
  resolution: Ask your system administrator to deploy an MDM profile that enables automatic updates of Apple apps.
  query: SELECT 1 FROM managed_policies WHERE domain='com.apple.SoftwareUpdate' AND name='AutomaticallyInstallAppUpdates' AND value=1;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS1.5
  contributors: lucasmrod
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Install Security Responses and System Files Is Enabled (MDM Required)
  platforms: macOS
  platform: darwin
  description: |
    Ensure that system and security updates are installed after they are available from
    Apple. This setting enables definition updates for XProtect and Gatekeeper. With this
    setting in place, new malware and adware that Apple has added to the list of malware or
    untrusted software will not execute.
  resolution: "Ask your system administrator to deploy an MDM profile that enables automatic critical system and security updates."
  query: SELECT 1 FROM managed_policies WHERE domain='com.apple.SoftwareUpdate' AND name='CriticalUpdateInstall' AND value=1 LIMIT 1;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS1.6
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Software Update Deferment Is Less Than or Equal to 30 Days (MDM Required)
  platforms: macOS
  platform: darwin
  description: |
    Apple provides the capability to manage software updates on Apple devices through
    mobile device management. Part of those capabilities permit organizations to defer
    software updates and allow for testing. Many organizations have specialized software
    and configurations that may be negatively impacted by Apple updates. If software
    updates are deferred, they should not be deferred for more than 30 days.
    This control only verifies that deferred software updates are not deferred for more than 30 days.
  resolution: "Ask your system administrator to deploy an MDM profile configures update deferment to a value of 30 days or less."
  query: SELECT 1 FROM managed_policies WHERE domain='com.apple.applicationaccess' AND name='enforcedSoftwareUpdateDelay' AND value <= 30;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS1.7
  contributors: lucasmrod
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure iCloud Drive Document and Desktop Sync Is Disabled (MDM Required)
  platforms: macOS
  platform: darwin
  description: Automated Document synchronization should be planned and controlled to approved storage.
  resolution: |
    The administrator should configure this via MDM profile.
    Create or edit a configuration profile with the following information:
      1. The PayloadType string is com.apple.applicationaccess.
      2. The key to include is allowCloudDesktopAndDocuments.
      3. The key must be set to <false/>.
  query: SELECT 1 FROM managed_policies WHERE domain='com.apple.applicationaccess' AND name='allowCloudDesktopAndDocuments' AND (value = 0 OR value = 'false') LIMIT 1;
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS2.1.1.3
  contributors: zwass
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Firewall Is Enabled
  platforms: macOS
  platform: darwin
  description: A firewall minimizes the threat of unauthorized users gaining access to your system while connected to a network or the Internet.
  resolution: "Go to the Network pane in System Settings and ensure Firewall is active."
  query: SELECT 1 FROM alf WHERE global_state >= 1;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.2.1
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Firewall Stealth Mode Is Enabled
  platforms: macOS
  platform: darwin
  description: |
    While in Stealth mode, the computer will not respond to unsolicited probes, dropping that traffic.
    Stealth mode on the firewall minimizes the threat of system discovery tools while connected to a network or the Internet.
  resolution: |
    Perform the following steps to enable firewall stealth mode:
      1. Open System Settings
      2. Select Network
      3. Select Firewall
      4. Select Options...
      5. Set Enabled stealth mode to enabled
  query: SELECT 1 FROM alf WHERE global_state >= 1 AND stealth_enabled = 1;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.2.2
  contributors: lucasmrod
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure AirDrop Is Disabled (MDM Required)
  platforms: macOS
  platform: darwin
  description: |
    AirDrop can allow malicious files to be downloaded from unknown sources.
    Contacts Only limits may expose personal information to devices in the same area.
  resolution: |
    Ask your system administrator to deploy an MDM profile that disables AirDrop.
    Create or edit a configuration profile with the following information:
      1. The PayloadType string is com.apple.applicationaccess
      2. The key to include is allowAirDrop
      3. The key must be set to <false/>
  query: SELECT 1 FROM managed_policies WHERE domain='com.apple.applicationaccess' AND name='allowAirDrop' AND (value = 0 OR value = 'false') LIMIT 1;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.3.1.1
  contributors: lucasmrod
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure AirPlay Receiver Is Disabled (MDM Required)
  platforms: macOS
  platform: darwin
  description: |
    In macOS Monterey (12.0), Apple has added the capability to share content from
    another Apple device to the screen of a host Mac. While there are many valuable uses
    of this capability, such sharing on a standard Mac user workstation should be enabled
    ad hoc as required rather than allowing a continuous sharing service. The feature can
    be restricted by Apple ID or network and is configured to use by accepting the
    connection on the Mac. Part of the concern is frequent connection requests may
    function as a denial-of-service and access control limits may provide too much
    information to an attacker.
  resolution: |
    The administrator should configure this via MDM profile.
    Create or edit a configuration profile with the following information:
      1. The PayloadType string is com.apple.applicationaccess
      2. The key to include is allowAirPlayIncomingRequests
      3. The key must be set to <false/>
  query: SELECT 1 FROM managed_policies WHERE domain='com.apple.applicationaccess' AND name='allowAirPlayIncomingRequests' AND (value = 0 OR value = 'false') LIMIT 1;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.3.1.2
  contributors: lucasmrod
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Set Time and Date Automatically Is Enabled (MDM required)
  platforms: macOS
  platform: darwin
  description: 
  resolution: |
      The administrator should configure this via MDM profile.
      Create or edit a configuration profile with the following information:
        1. The PayloadType string is com.apple.applicationaccess.
        2. The key to include is forceAutomaticDateAndTime.
        3. The key must be set to <true/>.
  query: SELECT 1 FROM managed_policies WHERE domain='com.apple.applicationaccess' AND name='forceAutomaticDateAndTime' AND value=1 LIMIT 1;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.3.2.1
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Time Is Set Within Appropriate Limits (fleetd required)
  platforms: macOS
  platform: darwin
  description: |
    Correct date and time settings are required for authentication protocols, file creation, modification dates and log entries.
    The time offset compared to time.apple.com must be between -270.x and 270.x seconds.
  resolution: Make sure the device can connect to time.apple.com to synchronize time.
  query: SELECT * FROM sntp_request WHERE server = 'time.apple.com' AND clock_offset_ms <= 270000 AND clock_offset_ms >= -270000;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.3.2.2
  contributors: 
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure DVD or CD Sharing Is Disabled
  platforms: macOS
  platform: darwin
  description: |
    DVD or CD Sharing allows users to remotely access the system's optical drive.
    Disabling DVD or CD Sharing minimizes the risk of an attacker using the optical drive as
    a vector for attack and exposure of sensitive data.
  resolution: |
    Graphical Method:
    1. Open System Settings
    2. Select General
    3. Select Sharing
    4. Set CD/DVD Sharing to disabled
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM plist WHERE
        path = '/var/db/com.apple.xpc.launchd/disabled.plist' AND
        key = 'com.apple.ODSAgent' AND
        value = '0'
    );
  # We are not using the launchd table because it does not check if services
  # are disabled via disabled.plist, which the preference pane uses whenever
  # a service is disabled after it has been enabled in the past.
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.3.3.1
  contributors: artemist-work
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Screen Sharing Is Disabled 
  platforms: macOS
  platform: darwin
  description: |
    Screen Sharing allows a computer to connect to another computer on a network and
    display the computer’s screen. While sharing the computer’s screen, the user can
    control what happens on that computer, such as opening documents or applications,
    opening, moving, or closing windows, and even shutting down the computer.
    Disabling Screen Sharing mitigates the risk of remote connections being made without
    the user of the console knowing that they are sharing the computer.
  resolution: |
    Graphical Method:
    1. Open System Settings
    2. Select General
    3. Select Sharing
    4. Set Screen Sharing to disabled
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM plist WHERE
        path = '/var/db/com.apple.xpc.launchd/disabled.plist' AND
        key = 'com.apple.screensharing' AND
        value = '0'
    );
  # We are not using the launchd table because it does not check if services
  # are disabled via disabled.plist, which the preference pane uses whenever
  # a service is disabled after it has been enabled in the past.
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.3.3.2
  contributors: artemist-work
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure File Sharing Is Disabled
  platforms: macOS
  platform: darwin
  description: |
    File sharing from a user workstation creates additional risks by
    increasing complexity and making security more difficult. Hardened
    file servers should be used instead of workstations
  resolution: |
    Graphical Method:
    1. Open System Settings
    2. Select General
    3. Select Sharing
    4. Set File Sharing to disabled
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM plist WHERE
        path = '/var/db/com.apple.xpc.launchd/disabled.plist' AND
        key = 'com.apple.smbd' AND
        value = '0'
    );
  # We are not using the launchd table because it does not check if services
  # are disabled via disabled.plist, which the preference pane uses whenever
  # a service is disabled after it has been enabled in the past.
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.3.3.3
  contributors: artemist-work
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Remote Login Is Disabled
  platforms: macOS
  platform: darwin
  description: |
    Remote Login allows an interactive terminal session to a computer.
    The SSH server built into macOS should not be enabled on a standard user computer,
    particularly one that changes locations and IP addresses.
    A standard user that runs local applications, including email, web browser,
    and productivity tools, should not use the same device as a server

  resolution: |
    Graphical Method:
    1. Open System Settings
    2. Select General
    3. Select Sharing
    4. Set Remote Login to disabled
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM plist WHERE
        path = '/var/db/com.apple.xpc.launchd/disabled.plist' AND
        key = 'com.openssh.sshd' AND
        value = '0'
    );
  # We are not using the launchd table because it does not check if services
  # are disabled via disabled.plist, which the preference pane uses whenever
  # a service is disabled after it has been enabled in the past.
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.3.3.5
  contributors: artemist-work
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Remote Management is Disabled
  platforms: macOS
  platform: darwin
  description: |
    Remote Management is the client portion of Apple Remote Desktop (ARD).
    Remote Management can be used by remote administrators to view the current screen,
    install software, report on, and generally manage client Macs.
    Remote Management should only be enabled on trusted networks with strong
    user controls present in a Directory system.
    Mobile devices without strict controls are vulnerable to exploit and monitoring.
  resolution: |
    Graphical Method:
    1. Open System Settings
    2. Select General
    3. Select Sharing
    4. Set Remote Management to disabled
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM processes WHERE
        path = '/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/MacOS/ARDAgent'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.3.3.6
  contributors: artemist-work
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Bluetooth Sharing Is Disabled
  platforms: macOS
  platform: darwin
  description: |
    Bluetooth Sharing allows files to be exchanged with Bluetooth-enabled devices.
    Disabling Bluetooth Sharing minimizes the risk of an attacker using Bluetooth
    to remotely attack the system.
  resolution: |
    Graphical Method:
    1. Open System Settings
    2. Select General
    3. Select Sharing
    4. Set Bluetooth Sharing to disabled
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT * FROM plist WHERE
        path LIKE '/Users/%/Library/Preferences/ByHost/com.apple.Bluetooth.%.plist' AND
        key = 'PrefKeyServicesEnabled' AND
        value = '1'
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.3.3.11
  contributors: artemist-work
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Backup Automatically is Enabled If Time Machine Is Enabled (FDA Required)
  platforms: macOS
  platform: darwin
  description: |
    Backup solutions are only effective if the backups run on a regular basis.
    The time to check for backups is before the hard drive fails or the computer goes missing.
    In order to simplify the user experience so that backups are more likely to occur,
    Time Machine should be on and set to Back Up Automatically whenever the target volume is available.

    FDA (Full Disk Access) is required to read the /Library/Preferences/com.apple.TimeMachine.plist
    file that contains the Time Machine configuration and backup destinations.
  resolution: |
    Ask your system administrator to deploy an MDM profile that enables automatic backup if Time Machine is enabled.
    The system administrator can do one of:
    A. Disable Time Machine on the device.
    B. Run the following command to enable automatic backup on Time Machine destinations:
      /usr/bin/sudo /usr/bin/defaults write /Library/Preferences/com.apple.TimeMachine.plist AutoBackup -bool true
  query: |
    SELECT 'no time machine backups' as output
    FROM (SELECT COUNT(*) as c FROM time_machine_backups) t1 WHERE t1.c = 0
    UNION
    SELECT 'time machine automatic backup set to true' as output
    FROM plist WHERE path='/Library/Preferences/com.apple.TimeMachine.plist'
    AND key='AutoBackup' AND (value = 1 OR value = 'true');
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS2.3.4.1
  contributors: lucasmrod
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Time Machine Volumes Are Encrypted If Time Machine Is Enabled (FDA Required)
  platforms: macOS
  platform: darwin
  description: |
    Backup solutions are only effective if the backups run on a regular basis.
    The time to check for backups is before the hard drive fails or the computer goes missing.
    In order to simplify the user experience so that backups are more likely to occur,
    Time Machine should be on and set to Back Up Automatically whenever the target volume is available.

    FDA (Full Disk Access) is required to read the /Library/Preferences/com.apple.TimeMachine.plist
    file that contains the Time Machine configuration and backup destinations.
  resolution: |
    Graphical Method:
    Perform the following steps to enable encryption on the Time Machine drive:
      1. Open `System Settings`.
      2. Select `General`.
      3. Select `Time Machine`.
      4. Select the unencrypted drive.
      5. Select `-` to forget that drive as a destination.
      6. Select `+` to add a different drive as the destination.
      7. Select `Set Up Disk...`.
      8. Set Encrypt Backup to enabled.
      9. Enter a password in the `New Password` and the same password in the `Re-enter Password` fields.
      10. A password hint is required, but it is recommended that you do not use any identifying information for the password
  query: |
    SELECT 'no time machine destinations configured' as output
    FROM (SELECT COUNT(*) as c FROM time_machine_destinations) t1 WHERE t1.c = 0
    UNION
    SELECT 'time machines destinations with encryption with automatic backup' as output
    FROM (SELECT COUNT(*) as c FROM time_machine_destinations WHERE encryption <> 'Encrypted') t2 WHERE t2.c = 0;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.3.4.2
  contributors: lucasmrod
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Show Wi-Fi status in Menu Bar Is Enabled (MDM Required)
  platforms: macOS
  platform: darwin
  description: |
    The Wi-Fi status in the menu bar indicates if the system's wireless internet capabilities are enabled.
    If so, the system will scan for available wireless networks in order to connect.
    Enabling "Show Wi-Fi status in menu bar" is a security awareness method that helps mitigate public area
    wireless exploits by making the user aware of their wireless connectivity status.
  resolution: |
    Automated method:
    Ask your system administrator to deploy an MDM profile that enables the Wi-Fi status in the menu bar.
    Create or edit a configuration profile with the following information:
    1. The `PayloadType` string is `com.apple.controlcenter`.
    2. The key to include is `WiFi`.
    3. The key must be set to `<integer>18</integer>`.
  query: SELECT 1 FROM managed_policies WHERE domain = 'com.apple.controlcenter' AND name = 'WiFi' AND value = 18;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.4.1
  contributors: lucasmrod
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Show Bluetooth Status in Menu Bar Is Enabled (MDM Required)
  platforms: macOS
  platform: darwin
  description: |
    Enabling "Show Bluetooth status in menu bar" is a security awareness method that
    helps understand the current state of Bluetooth, including whether it is enabled,
    discoverable, what paired devices exist, and what paired devices are currently active.
  resolution: |
    Automated method:
    Ask your system administrator to deploy an MDM profile that enables the Bluetooth status in the menu bar.
    Create or edit a configuration profile with the following information:
    1. The `PayloadType` string is `com.apple.controlcenter`.
    2. The key to include is `Bluetooth`.
    3. The key must be set to `<integer>18</integer>`.
  query: SELECT 1 FROM managed_policies WHERE domain = 'com.apple.controlcenter' AND name = 'Bluetooth' AND value = 18;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.4.2
  contributors: lucasmrod
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Location Services Is Enabled
  platforms: macOS
  platform: darwin
  description: Checks that Location Services option is enabled.
  resolution: |
    Automated method:
    Ask your system administrator to deploy an MDM profile that enables automatic updates of Apple apps.
    Graphical method:
      Perform the following steps to enable Location Services:
        1. Open System Settings
        2. Select Privacy & Security
        3. Select Location Services
        4. Verify Location Services is enabled
  query: SELECT 1 FROM location_services where enabled=1;
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS2.6.1.1
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Location Services Is in the Menu Bar
  platforms: macOS
  platform: darwin
  description: Checks that Location Services option is presented in the Menu Bar.
  resolution: |
    Automated method:
    Ask your system administrator to deploy an MDM profile that enables the "location services" icon in menu bar when System Services request your location.
    Graphical method:
      Perform the following steps to enable Location Services:
        1. Open System Settings
        2. Select Privacy & Security
        3. Select Location Services
        4. Select Details...
        5. Verify Show location icon in menu bar when System Services request your
        location is set to your organization's parameters
  query:  SELECT 1 FROM plist WHERE path='/Library/Preferences/com.apple.locationmenu.plist' AND key='ShowSystemServices' AND value=1;
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS2.6.1.2
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Limit Ad Tracking Is Enabled (MDM Required)
  platforms: macOS
  platform: darwin
  description: Checks that Ensure Limit Ad Tracking Is Enabled.
  resolution: |
    Automated method:
    Ask your system administrator to deploy an MDM profile that disables apple personalized advertising.
    Graphical method:
      Perform the following steps to enable Location Services:
        1. Open Privacy & Security
        2. Select Apple Advertising
        3. Verify that Personalized Ads is not enabled
  query: SELECT 1 FROM managed_policies WHERE domain='com.apple.applicationaccess' AND name='allowApplePersonalizedAdvertising' AND value=0;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.6.3
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Screen Saver Corners Are Secure (FDA Required)
  platforms: macOS
  platform: darwin
  description: |
    Setting a hot corner to disable the screen saver poses a potential security risk since an
    unauthorized person could use this to bypass the login screen and gain access to the system.

    FDA (Full Disk Access) is required to read the configuration of all the users in the device
    ('/Users/*/Library/Preferences/com.apple.dock.plist')
  resolution: |
    Ask your system administrator to deploy a script that will configure
    `wvous-tl-corner`, `wvous-bl-corner`, `wvous-tr-corner`, and `wvous-br-corner` in
    domain `com.apple.dock` to a value that is not 6 (for all users of the device).

    Graphical Method:
      Perform the following steps to ensure that a Hot Corner is not set to Disable Screen Saver:
        1. Open System Settings
        2. Select Desktop & Dock
        3. Select`Hot Corners...`
        4. Verify that `Disable Screen Saver` is not set to any of the corners.
  query: |
    SELECT 1 WHERE NOT EXISTS(
      SELECT 1 FROM plist
      WHERE path LIKE '/Users/%/Library/Preferences/com.apple.dock.plist' AND (
        key = 'wvous-br-corner' OR
        key = 'wvous-bl-corner' OR
        key = 'wvous-tr-corner' OR
        key = 'wvous-tl-corner'
    ) AND value = 6);
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS2.7.1
  contributors: lucasmrod
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure a Password is Required to Wake the Computer From Sleep or Screen Saver Is Enabled (MDM Required)
  platforms: macOS
  platform: darwin
  description: Checks that Password is Required to Wake the Computer From Sleep or Screen Saver Is Enabled.
  resolution: |
    Automated method:
    Ask your system administrator to deploy an MDM profile that Ensure a Password is Required to Wake the Computer From Sleep or Screen Saver Is Enabled.
    Graphical method:
      Perform the following steps to enable Location Services:
        1. Open System Settings
        2. Select Lock Screen
        3. Verify that Require password after screensaver begins or display is turned
        off is set with After 0 seconds or After 5 seconds
  query: |
    SELECT 1 WHERE EXISTS(select 1 FROM managed_policies WHERE domain='com.apple.screensaver' AND name='askForPassword' AND value=1)  AND EXISTS(select 1 FROM managed_policies WHERE domain='com.apple.screensaver' AND name='askForPasswordDelay' AND value <= 5)
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.10.2
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Gatekeeper Is Enabled
  platforms: macOS
  platform: darwin
  description: |
    Checks that Gatekeeper Is Enabled. Gatekeeper is Apple’s application that utilizes allowlisting to restrict downloaded applications from launching. It functions as a control to limit applications from unverified sources from running without authorization. In an update to Gatekeeper in macOS 13 Ventura, Gatekeeper checks every application on every launch, not just quarantined apps.
  resolution: |
    Automated method:
    Ask your system administrator to deploy an MDM profile that Ensure Gatekeeper Is Enabled
    Graphical method:
      Perform the following steps to enable Location Services:
        1. Open System Settings
        2. Select Privacy & Security
        3. Verify that 'Allow apps downloaded from' is set to' App Store and identified developers'
  query: SELECT 1 FROM gatekeeper WHERE assessments_enabled = 1 AND dev_id_enabled = 1;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.6.4
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Sending Diagnostic and Usage Data to Apple Is Disabled (MDM Required)
  platforms: macOS
  platform: darwin
  description: Checks that Sending Diagnostic and Usage Data to Apple Is Disabled.
  resolution: |
    Automated method:
    Ask your system administrator to deploy an MDM profile that disables Sending Diagnostic and Usage Data to Apple.
    Graphical method:
      Perform the following steps to enable Location Services:
        1. Open System Settings
        2. Select Privacy & Security
        3. Select Analytics & Improvements
        4. Verify that Share Mac Analytics is not enabled
        5. Verify that Share with App Developers is not enabled
        6. Verify that Improve Siri & Dictation is not enabled
  query: |
    SELECT 1 WHERE 
    EXISTS(select 1 FROM managed_policies WHERE domain='com.apple.SubmitDiagInfo' AND name='AutoSubmit' AND value = 0)  
    AND 
    EXISTS(select 1 FROM managed_policies WHERE domain='com.apple.applicationaccess' AND name='allowDiagnosticSubmission' AND value = 0)
    AND 
    EXISTS(select 1 FROM managed_policies WHERE domain='com.apple.applicationaccess' AND name='Siri Data Sharing Opt-In Status' AND value = 2);
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS2.6.2
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure an Inactivity Interval of 20 Minutes Or Less for the Screen Saver Is Enabled (MDM Required)
  platforms: macOS
  platform: darwin
  description: A locking screen saver is one of the standard security controls to limit access to a computer and the current user's session when the computer is temporarily unused or unattended. In macOS, the screen saver starts after a value is selected in the drop- down menu. 20 minutes or less is an acceptable value. Any value can be selected through the command line or script, but a number that is not reflected in the GUI can be problematic. 20 minutes is the default for new accounts.
  resolution: |
    Automated method:
    Ask your system administrator to deploy an MDM profile that ensure an Inactivity Interval of 20 Minutes Or Less for the Screen Saver to be Enabled.
    Graphical method:
      Perform the following steps to enable Location Services:
        1. Open System Settings
        2. Select Lock Screen
        3. Verify that Start Screen Saver when inactive is set for 20 minutes or less (≤1200 seconds)
  query: SELECT 1 FROM managed_policies WHERE domain='com.apple.screensaver' AND name='idleTime' AND value <= 1200;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.10.1
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure a Custom Message for the Login Screen Is Enabled
  platforms: macOS
  platform: darwin
  description: An access warning informs the user that the system is reserved for authorized use only, and that the use of the system may be monitored
  resolution: |
    Graphical method:
      Perform the following steps to enable Location Services:
        1. Open System Settings
        2. Select Lock Screen
        3. Verify Show message when locked is enabled
        4. Select Set
        5. Verify that the message displayed is configured to your organization's required text
  query: SELECT 1 FROM plist WHERE path='/Library/Preferences/com.apple.loginwindow.plist' AND key='LoginwindowText' AND value != "";
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.10.3
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure FileVault Is Enabled (MDM required)
  platforms: macOS
  platform: darwin
  description: Checks that FileVault Is Enabled. FileVault secures a system's data by automatically encrypting its boot volume and requiring a password or recovery key to access it. This policy checks that filevault is enabled on the device and that the user is not allowed to disable it.
  resolution: |
    Automated method:
    Ask your system administrator to deploy an MDM profile that enables FileVault and disables turning it off.
    Graphical method:
      Perform the following steps to enable Location Services:
        1. Open System Settings
        2. Select Privacy & Privacy
        3. Verify that FileVault states FileVault is turned on for the disk "<disk name>"
        4. Select Privacy & Security
        5. Select Profile
        6. Verify that an installed profile has FileVault Can't Disable set to True
  query: |
    SELECT 1 WHERE 
    EXISTS(SELECT 1 FROM managed_policies WHERE domain='com.apple.MCX' AND name='dontAllowFDEDisable' AND value=1)  
    AND 
    EXISTS(SELECT 1 FROM disk_encryption WHERE user_uuid IS NOT "" AND filevault_status = 'on' LIMIT 1);
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.6.5
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Login Window Displays as Name and Password Is Enabled (MDM required)
  platforms: macOS
  platform: darwin
  description: Checks Login Window Displays as Name and Password Is Enabled.
  resolution: |
    Automated method:
    Ask your system administrator to deploy an MDM profile that Ensure Login Window Displays as Name and Password Is Enabled.
    Graphical method:
      Perform the following steps to enable Location Services:
        1. Open System Settings
        2. Select Lock Screen
        3. Verify that Login window shows is set to Name and Password
  query: SELECT 1 FROM managed_policies where domain='com.apple.loginwindow' AND name='SHOWFULLNAME' AND value=1;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.10.4
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Show Password Hints Is Disabled (MDM Required)
  platforms: macOS
  platform: darwin
  description: Checks Show Password Hints Is Disabled.
  resolution: |
    Automated method:
    Ask your system administrator to deploy an MDM profile that Ensures Show Password Hints Is Disabled.
    Graphical method:
      Perform the following steps to enable Location Services:
        1. OpenSystemSettings
        2. Select Lock Screen
        3. Verify that Show password hints is disabled
  query: SELECT 1 FROM managed_policies WHERE domain = 'com.apple.loginwindow' AND name = 'RetriesUntilHint' AND value = 0;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.10.5
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Users' Accounts Do Not Have a Password Hint (fleetd required)
  platforms: macOS
  platform: darwin
  description: |
    Password hints help the user recall their passwords for various systems and/or accounts. In most cases, password hints are simple and closely related to the user's password.
  resolution: |
    Automated method:
    Ask your system administrator to deploy an MDM profile that disables apple personalized advertising.
    Graphical method:
      Perform the following steps to enable Location Services:
        1. Open System Settings
        2. Select Touch ID & Passwords (or Login Password on non-Touch ID Macs)
        3. Select Change...
        4. Change the password and ensure that no text is entered in the Password hint box
  query: SELECT 1 FROM user_login_settings WHERE password_hint_enabled = 0;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.11.1
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Guest Account Is Disabled
  platforms: macOS
  platform: darwin
  description: Checks that Guest Account Is Disabled.
  resolution: |
    Automated method:
    Ask your system administrator to deploy an MDM profile that disables Guest Account.
    Graphical method:
      Perform the following steps to enable Location Services:
        1. Open System Settings
        2. Select Users & Groups
        3. Select the i next to the Guest User
        4. Verify that Allow guests to log in to this computer is disable
  query: |
    SELECT 1 WHERE
    EXISTS(SELECT 1 FROM plist WHERE path='/Library/Preferences/com.apple.loginwindow.plist' AND key='GuestEnabled' AND value = 0)
    OR
    EXISTS(select 1 FROM plist WHERE path='/Library/Preferences/com.apple.MCX.plist' AND key='DisableGuestAccount' AND value = 1);
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.12.1
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Guest Access to Shared Folders Is Disabled
  platforms: macOS
  platform: darwin
  description: Allowing guests to connect to shared folders enables users to access selected shared folders and their contents from different computers on a network
  resolution: |
    Automated method:
      Ask your system administrator to deploy the following script which will disable guest users from access to shared folders:
      /usr/bin/sudo /usr/sbin/sysadminctl -smbGuestAccess off
    Graphical Method:
      Perform the following steps to no longer allow guest user access to shared folders:
        1. Open System Settings
        2. Select Users & Groups
        3. Select the i next to the Guest User
        4. Set Allow guests to connect to shared folders to disabled
  query: SELECT 1 from plist where path = '/Library/Preferences/SystemConfiguration/com.apple.smb.server.plist' AND key = 'AllowGuestAccess' AND value = 0;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.12.2
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Automatic Login Is Disabled (MDM Required)
  platforms: macOS
  platform: darwin
  description: |
    The automatic login feature saves a user's system access credentials and bypasses the login screen. Instead, the system automatically loads to the user's desktop screen
  resolution: |
    Automated method:
    Ask your system administrator to deploy an MDM profile that Ensure Automatic Login Is Disabled
    Graphical method:
      Perform the following steps to enable Location Services:
        1. Open System Settings
        2. Select Users & Groups
        3. Set Automatic login in as... to Off
    Profile Method:
        Create or edit a configuration profile with the following information:
        1. The Payload Type string is com.apple.loginwindow
        2. The key to include is com.apple.login.mcx.DisableAutoLoginClient 
        3. The key must be set to <true/>
  query: SELECT 1 FROM managed_policies WHERE domain='com.apple.loginwindow' AND name='com.apple.login.mcx.DisableAutoLoginClient' AND value = 1;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS2.12.3
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Security Auditing Is Enabled
  platforms: macOS
  platform: darwin
  description: |
    macOS's audit facility, auditd, receives notifications from the kernel when certain system calls, such as open, fork, and exit, are made. These notifications are captured and written to an audit log.
  resolution: |
    Automated method:
    Ask your system administrator to deploy the following script which will enable security auditing:
    /usr/bin/sudo /bin/launchctl load -w /System/Library/LaunchDaemons/com.apple.auditd.plist
  query: | 
    SELECT 1 WHERE EXISTS (
      SELECT
        l.program, l.label, l.program_arguments,
        p.path, p.name , p.cmdline
      FROM
        launchd AS l
        INNER JOIN processes AS p
      ON (l.program = p.path)
      WHERE
      (l.label = "com.apple.auditd")
      AND
      (l.program_arguments = p.cmdline)
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS3.1
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Security Auditing Flags For User-Attributable Events Are Configured Per Local Organizational Requirements
  platforms: macOS
  platform: darwin
  description: |
    Auditing is the capture and maintenance of information about security-related events. Auditable events often depend on differing organizational requirements.
  resolution: |
    Automated method:
    Ask your system administrator to deploy an MDM profile that disables Bonjour advertising service.
    Terminal Method: 
      Perform the following to set the required Security Auditing Flags:
      Edit the /etc/security/audit_control file and add -fm, ad, -ex, aa, -fr, lo, and -fw to flags. You can also substitute -all for -fm, -ex, -fr, and -fw.
  query: |
    SELECT 1 WHERE EXISTS (    
      SELECT line
      FROM file_lines WHERE path = '/etc/security/audit_control' 
      AND 
      (
            (
              line LIKE 'flags:%' 
              AND 
              line LIKE "%-fm%"
              AND 
              line LIKE "%ad%"
              AND 
              line LIKE "%-ex%"
              AND 
              line LIKE "%aa%"
              AND 
              line LIKE "%-fr%"
              AND 
              line LIKE "%lo%"
              AND 
              line LIKE "%-fw%" 
            ) 
            OR 
            (
              line LIKE 'flags:%' 
              AND 
              line LIKE "%-all%" 
              AND 
              line LIKE "%ad%"
              AND 
              line LIKE "%aa%"
              AND 
              line LIKE "%lo%"
            )
      )
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS3.2
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure install.log Is Retained for 365 or More Days and No Maximum Size
  platforms: macOS
  platform: darwin
  description: |
    macOS writes information pertaining to system-related events to the file /var/log/install.log and has a configurable retention policy for this file. The default logging setting limits the file size of the logs and the maximum size for all logs. The default allows for an errant application to fill the log files and does not enforce sufficient log retention. The Benchmark recommends a value based on standard use cases. The value should align with local requirements within the organization.
  resolution: |
    Automated method:
      Ask your system administrator to deploy a script which will ensure proper retention for install.log.
    Terminal Method:
      Perform the following to ensure that install logs are retained for at least 365 days:
      Edit the /etc/asl/com.apple.install file and add or modify the ttl value to 365 or greater on the file line. Also, remove the all_max= setting and value from the file line.
  query: |
    SELECT 1 WHERE
    EXISTS ( SELECT line, 
             CAST ( regex_match(line, 'ttl=(\d+)', 1) AS INTEGER ) AS val 
             FROM file_lines 
             WHERE path = '/etc/asl/com.apple.install' 
             AND val >=365 )
    AND
    NOT EXISTS ( SELECT line  
             FROM file_lines 
             WHERE path = '/etc/asl/com.apple.install'  
             AND  line  LIKE "%all_max=%" );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS3.3
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Security Auditing Retention Is Enabled
  platforms: macOS
  platform: darwin
  description: |
    The macOS audit capability contains important information to investigate security or operational issues. This resource is only completely useful if it is retained long enough to allow technical staff to find the root cause of anomalies in the records.
    Retention can be set to respect both size and longevity. To retain as much as possible under a certain size, the recommendation is to use the following:
    expire-after:60d OR 5G
    This recomendation is based on minimum storage for review and investigation. When a third party tool is in use to allow remote logging or the store and forwarding of logs, this local storage requirement is not required.
  resolution: |
    Automated method:
    Ask your system administrator to deploy the following script which will ensure proper Security Auditing Retention:
    cp /etc/security/audit_control ./tmp.txt; origExpire=$(cat ./tmp.txt  | grep expire-after);  sed "s/${origExpire}/expire-after:60d OR 5G/" ./tmp.txt > /etc/security/audit_control; rm ./tmp.txt;
  query: |
    SELECT 1 WHERE EXISTS (
      SELECT line,
      CAST(regex_match(line, 'expire-after:(\d+)d OR (\d+)G', 1) AS INTEGER) AS days,
      CAST(regex_match(line, 'expire-after:(\d+)d OR (\d+)G', 2) AS INTEGER) AS size
      FROM file_lines
      WHERE path = '/etc/security/audit_control'
      AND days >=60
      AND size >=5
    );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS3.4
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Access to Audit Records Is Controlled
  platforms: macOS
  platform: darwin
  description: |
    The audit system on macOS writes important operational and security information that can be both useful for an attacker and a place for an attacker to attempt to obfuscate unwanted changes that were recorded. As part of defense-in-depth the /etc/security/audit_control configuration and the files in /var/audit should be owned only by root with group wheel with read-only rights and no other access allowed. macOS ACLs should not be used for these files.
  resolution: |
    Automated method:
    Ask your system administrator to deploy the following script which will Ensure Access to Audit Records Is Controlled:
      /usr/bin/sudo /usr/sbin/chown -R root:wheel /etc/security/audit_control
      /usr/bin/sudo /bin/chmod -R o-rw /etc/security/audit_control
      /usr/bin/sudo /usr/sbin/chown -R root:wheel /var/audit/
      /usr/bin/sudo /bin/chmod -R o-rw /var/audit/
  query: |
    SELECT 1 WHERE 
      -- For all files in /var/audit:
      -- UID, GID should be owned by root.
      -- MODE should be 0440 ("-r--r-----")
      NOT EXISTS ( SELECT 1 FROM file WHERE path LIKE '/var/audit/%' AND (uid !=0 OR gid !=0 OR mode != "0440") )
      AND 
      NOT EXISTS ( select 1 from file 
                        where path LIKE 
                        ( 
                            SELECT dir FROM 
                            ( 
                              -- The path we are looking for is written inside /etc/security/audit_control in a line that starts with "dir:"
                              -- Looking immediately at this and REGEX-ing the path after it (and concatenating "/%")
                              -- Same explanation for queries below.
                              select line, CONCAT(regex_match(line, '^dir:(.+)',1 ), '/%') AS dir 
                              FROM file_lines 
                              WHERE path = '/etc/security/audit_control' 
                              AND line LIKE "dir:%"
                            )
                        ) 
                        AND ( uid !=0 OR gid !=0 OR mode != "0440" )
                  ) 
      AND 
      -- For /etc/security/audit_control the MODE should be 0400 ("-r--------")
      NOT EXISTS ( select 1 from file where path = "/etc/security/audit_control" AND mode != "0400" );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS3.5
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Firewall Logging Is Enabled and Configured (MDM Required)
  platforms: macOS
  platform: darwin
  description: |
    The socketfilter Firewall is what is used when the Firewall is turned on in the Security & Privacy Preference Pane. In order to appropriately monitor what access is allowed and denied, logging must be enabled. The logging level must be set to "detailed" to be useful in monitoring connection attempts that the firewall detects. Throttled login is not sufficient for examine Firewall connection attempts.
  resolution: |
    Profile Method:
    Create or edit a configuration profile with the following information:
    1. The Payload Type string is com.apple.security.firewall 
    2. The key to include is EnableFirewall
    3. The key must be set to<true/>
    4. The key to also include is EnableLogging
    5. The key must be set to<true/>
    6. The key to also include is LoggingOption
    7. The key must be set to <string>detail</string>
  query: |
    SELECT 1 WHERE
    (
      EXISTS ( SELECT 1 FROM managed_policies WHERE domain='com.apple.security.firewall' AND name='EnableLogging' AND value=1 )
      AND
      EXISTS ( SELECT 1 FROM managed_policies WHERE domain='com.apple.security.firewall' AND name='LoggingOption' AND value="detail" )
    )
    OR
    (
      EXISTS ( SELECT 1 FROM plist WHERE path='/Library/Preferences/com.apple.alf.plist' AND key='loggingenabled' AND value = 1 )
      AND
      EXISTS ( SELECT 1 FROM plist WHERE path='/Library/Preferences/com.apple.alf.plist' AND key='loggingoption' AND value = 2 )
    );

  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS3.6
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Bonjour Advertising Services Is Disabled (MDM Required)
  platforms: macOS
  platform: darwin
  description: |
    Bonjour is an auto-discovery mechanism for TCP/IP devices which enumerate devices and services within a local subnet.
    DNS on macOS is integrated with Bonjour and should not be turned off, but the Bonjour advertising service can be disabled.
  resolution: |
    Automated method:
    Ask your system administrator to deploy an MDM profile that disables Bonjour advertising service.
    Profile Method:
        Create or edit a configuration profile with the following information:
        1. The Payload Type string is `com.apple.mDNSResponder`.
        2. The key to include is `NoMulticastAdvertisements`.
        3. The key must be set to `<true/>`.
  query: SELECT 1 FROM managed_policies WHERE domain='com.apple.mDNSResponder' AND name='NoMulticastAdvertisements' AND value = 1;
  purpose: Informational
  tags: compliance, CIS, CIS_Level2, CIS4.1
  contributors: lucasmrod
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure HTTP Server Is Disabled
  platforms: macOS
  platform: darwin
  description: |
    Personal web sharing could be enabled to allow someone on another computer to download files or information from the user's computer.
    Apache is still part of the Operating System and can be easily turned on to share files and provide remote connectivity
    to an end-user computer. Web serving should not be done from a user desktop. Open ports make it easier to exploit the computer.
  resolution: |
    Automated method:
    Ask your system administrator to deploy the following script which will disable the Apache service:
    /usr/bin/sudo /bin/launchctl unload -w /System/Library/LaunchDaemons/org.apache.httpd.plist
  query: SELECT 1 WHERE NOT EXISTS(SELECT * FROM processes WHERE path = '/usr/sbin/httpd');
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS4.2
  contributors: lucasmrod
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure NFS Server Is Disabled
  platforms: macOS
  platform: darwin
  description: |
    MacOS can act as an NFS fileserver. NFS sharing could be enabled to allow someone on another computer to mount
    shares and gain access to information from the user's computer.
  resolution: |
    Automated method:
    Ask your system administrator to deploy the following script which will disable the NFS service
    and its directory listing:
    /usr/bin/sudo /bin/launchctl disable system/com.apple.nfsd
    /usr/bin/sudo /bin/rm /etc/exports
  query: |
    SELECT 1 WHERE
    NOT EXISTS(SELECT 1 FROM processes WHERE path = '/sbin/nfsd')
    AND
    NOT EXISTS(SELECT 1 FROM file WHERE path = '/etc/exports');
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS4.3
  contributors: lucasmrod
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Home Folders Are Secure
  platforms: macOS
  platform: darwin
  description: |
    By default, macOS allows all valid users into the top level of every other user's home folder and restricts access to the Apple default folders within. Another user on the same system can see you have a "Documents" folder but cannot see inside it. This configuration does work for personal file sharing but can expose user files to standard accounts on the system.
    The best parallel for Enterprise environments is that everyone who has a Dropbox account can see everything that is at the top level but can't see your pictures. Similarly with macOS, users can see into every new Directory that is created because of the default permissions.
    Home folders should be restricted to access only by the user. Sharing should be used on dedicated servers or cloud instances that are managing access controls. Some environments may encounter problems if execute rights are removed as well as read and write. Either no access or execute only for group or others is acceptable.
  resolution: |
    Automated method:
    Ask your system administrator to deploy a script that will go over all users and set the mode for all of them either like this:
    /usr/bin/sudo /bin/chmod -R og-rwx /Users/<username>
    Or like this if there is a need for excutable access:
    /usr/bin/sudo /bin/chmod -R og-rw /Users/<username>
  query: SELECT 1 WHERE NOT EXISTS (
    SELECT 1 FROM file WHERE (
    path LIKE '/Users/%'
    AND path != '/Users/Shared/'
    AND mode != "0700"
    AND mode !="0701"
    AND mode !="0710"
    AND mode !="0711"
    ));
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS5.1.1
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure System Integrity Protection Status (SIP) Is Enabled
  platforms: macOS
  platform: darwin
  description: |
    System Integrity Protection is a security feature introduced in OS X 10.11 El Capitan. System Integrity Protection restricts access to System domain locations and restricts runtime attachment to system processes. Any attempt to inspect or attach to a system process will fail. Kernel Extensions are now restricted to /Library/Extensions and are required to be signed with a Developer ID.
  resolution: |
    Terminal Method:
    Perform the following steps to enable System Integrity Protection:
      1. Reboot into the Recovery Partition (reboot and hold down Command (⌘) + R)
      2. Select Utilities
      3. Select Terminal
      4. Run the following command:
          /usr/bin/sudo /usr/bin/csrutil enable
  query: SELECT 1 FROM sip_config WHERE config_flag="sip" and enabled=1;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS5.1.2
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Apple Mobile File Integrity (AMFI) Is Enabled (fleetd required)
  platforms: macOS
  platform: darwin
  description: |
    Apple Mobile File Integrity (AMFI) was first released in macOS 10.12. The daemon and service block attempts to run unsigned code. AMFI uses launchd, code signatures, certificates, entitlements, and provisioning profiles to create a filtered entitlement dictionary for an app. AMFI is the macOS kernel module that enforces code-signing and library validation.
    Note: AMFI cannot be disabled with SIP enabled, but a change attempt can be made that will appear successful, and report incorrectly as successful. If the AMFI audit fails, and the SIP audit passes, this is still an issue the admin should research.
  resolution: |
    Automated method:
      Ask your system administrator to deploy the following script which will Ensure Apple Mobile File Integrity (AMFI) Is Enabled:
      /usr/bin/sudo /usr/sbin/nvram boot-args=""
  query: SELECT 1 FROM csrutil_info WHERE ssv_enabled="1";
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS5.1.3
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Sealed System Volume (SSV) Is Enabled (fleetd required)
  platforms: macOS
  platform: darwin
  description: |
    Sealed System Volume is a security feature introduced in macOS 11.0 Big Sur.
    During system installation, a SHA-256 cryptographic hash is calculated for all immutable system files and stored in a Merkle tree which itself is hashed as the Seal. Both are stored in the metadata of the snapshot created of the System volume.
    The seal is verified by the boot loader at startup. macOS will not boot if system files have been tampered with. If validation fails, the user will be instructed to reinstall the operating system.
    During read operations for files located in the Sealed System Volume, a hash is calculated and compared to the value stored in the Merkle tree.
  resolution: |
    If SSV has been disabled, assume that the operating system has been compromised. Back up any files, and do a clean install to a known good Operating System.
  query: SELECT 1 FROM nvran_info WHERE amfi_enabled="1";
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS5.1.4
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Password Account Lockout Threshold Is Configured (Fleetd required)
  platforms: macOS
  platform: darwin
  description: |
    The account lockout threshold specifies the amount of times a user can enter an incorrect password before a lockout will occur.
  resolution: |
    Automated method:
    Ask your system administrator to deploy an MDM profile that Ensure Password Account Lockout Threshold.
    Profile Method:
    Create or edit a configuration profile with the following information:
      1. The PayloadType string is com.apple.mobiledevice.passwordpolicy 
      2. The key to include is maxFailedAttempts
      3. The key must be set to <integer><value≤5></integer>
  query: SELECT 1 FROM  pwd_policy where max_failed_attempts <= 5;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS5.2.1
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Password Minimum Length Is Configured
  platforms: macOS
  platform: darwin
  description: |
    A minimum password length is the fewest number of characters a password can contain to meet a system's requirements. Ensure that a minimum of a 15-character password is part of the password policy on the computer. Where the confidentiality of encrypted information in FileVault is more of a concern, requiring a longer password or passphrase may be sufficient rather than imposing additional complexity requirements that may be self-defeating.
  resolution: |
    Automated method:
    Ask your system administrator to deploy an MDM profile that disables Guest Account.
    Profile Method:
    Create or edit a configuration profile with the following information:
      1. The PayloadType string is com.apple.mobiledevice.passwordpolicy 
      2. The key to include is minLength
      3. The key must be set to <integer><value≥15></integer>
  query: |
    SELECT 1 
    FROM (
    SELECT cast(lengthtxt as integer(2)) minlength 
    FROM (
    SELECT SUBSTRING(length, 1, 2) AS lengthtxt 
    FROM (
    SELECT policy_description, policy_identifier, split(policy_content, '{', 1) AS length 
    FROM password_policy 
    WHERE policy_identifier LIKE '%minLength')) 
    WHERE minlength >= 15);
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS5.2.2
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Password Age Is Configured (fleetd required)
  platforms: macOS
  platform: darwin
  description: |
    Over time, passwords can be captured by third parties through mistakes, phishing attacks, third-party breaches, or merely brute-force attacks. To reduce the risk of exposure and to decrease the incentives of password reuse (passwords that are not forced to be changed periodically generally are not ever changed), users should reset passwords periodically. This control uses 365 days as the acceptable value. Some organizations may be more or less restrictive. This control mainly exists to mitigate against password reuse of the macOS account password in other realms that may be more prone to compromise. Attackers take advantage of exposed information to attack other accounts.
  resolution: |
    Automated method:
    Ask your system administrator to deploy an MDM profile that disables Guest Account.
    Profile Method:
    Create or edit a configuration profile with the following information:
      1. The Payload Type string is com.apple.mobiledevice.passwordpolicy 
      2. The key to include is maxPINAgeInDays
      3. The key must be set to <integer><value<=365></integer>
  query: |
    SELECT 1 WHERE
    EXISTS(SELECT 1 FROM pwd_policy WHERE expires_every_n_days <= 365)
    OR
    EXISTS(SELECT 1 FROM pwd_policy WHERE days_to_expiration <= 365);
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS5.2.7
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure Password History Is Configured (fleetd required)
  platforms: macOS
  platform: darwin
  description: |
    Over time, passwords can be captured by third parties through mistakes, phishing attacks, third-party breaches, or merely brute-force attacks. To reduce the risk of exposure and to decrease the incentives of password reuse (passwords that are not forced to be changed periodically generally are not ever changed), users must reset passwords periodically. This control ensures that previous passwords are not reused immediately by keeping a history of previous password hashes. Ensure that password history checks are part of the password policy on the computer. This control checks whether a new password is different than the previous 15. The latest NIST guidance based on exploit research referenced in this section details how one of the greatest risks is password exposure rather than password cracking. Passwords should be changed to a new unique value whenever a password might have been exposed to anyone other than the account holder. Attackers have maintained persistent control based on predictable password change patterns and substantially different patterns should be used in case of a leak.
  resolution: |
    Automated method:
    Ask your system administrator to deploy an MDM profile that disables Guest Account.
    Profile Method:
    Create or edit a configuration profile with the following information:
      1. The Payload Type string is com.apple.mobiledevice.passwordpolicy 
      2. The key to include is pinHistory
      3. The key must be set to <integer><value≥15></integer>
  query: SELECT 1 FROM  pwd_policy where history_depth >= 15;
  purpose: Informational
  tags: compliance, CIS, CIS_Level1, CIS5.2.8
  contributors: sharon-fdm
