---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure that the --profiling argument is set to false
  platforms: RHEL_version_x
  platform: linux
  description: |
    Disable profiling, if not needed.
  resolution: |
    Edit the API server pod specification file /etc/kubernetes/manifests/kube-  apiserver.yaml on the Control Plane node and set the below parameter.  --profiling=false
  query: |
    SELECT 1 WHERE 
      EXISTS (
        SELECT 1 AS pass
        FROM processes
        WHERE name = 'kube-apiserver'
        AND cmdline LIKE '%--profiling=false%'
        )
      OR NOT EXISTS (
        SELECT 1 FROM processes WHERE name = 'kube-apiserver'
        );  
  purpose: Informational
  tags: compliance, CIS, CIS_Level1
  contributors: sharon-fdm
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure that the --authorization-mode argument includes RBAC
  platform: linux
  description: |
    Turn on Role Based Access Control.
  resolution: |
    Run the following command on the Control Plane node: `ps -ef | grep kube-apiserver` Verify that the --authorization-mode argument exists and is set to a value to include RBAC.
  query: |
    SELECT 1 WHERE
      EXISTS (
        SELECT 1
        FROM processes
        WHERE name = 'kube-apiserver'
        AND cmdline LIKE '%--authorization-mode=%RBAC%'
        )
      OR NOT EXISTS (
        SELECT 1 FROM processes WHERE name = 'kube-apiserver'
        );  
  purpose: Informational
  tags: compliance, CIS, CIS_Level1
  contributors: harrisonravazzolo
---
apiVersion: v1
kind: policy
spec:
  name: CIS (K8s) 1.1.14 - Ensure that the default administrative credential file ownership is set to root:root
  platform: linux
  description: |
    Ensure that the admin.conf (and super-admin.conf file, where it exists) file ownership is set to root:root.
  resolution: |
    Use the chown command to set the file ownership to root:root.
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT 1 FROM FILE f
        JOIN users u USING (uid)
        JOIN groups g USING (gid)
      WHERE f.path = '/var/lib/rancher/rke2/server/cred/admin.kubeconfig'
        AND (u.username != 'root' OR g.groupname != 'root')
    )
  purpose: Informational
  tags: compliance, CIS, CIS_Level1
  contributors: zwass
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure that the --cert-file and --key-file arguments are set as appropriate (Automated)
  platform: linux
  description: |
    Configure TLS encryption for the etcd service.
  resolution: |
    Remediation:
    By default, RKE2 generates cert and key files for etcd. These are located in /var/lib/rancher/rke2/server/tls/etcd/.
     If this check fails, ensure that the configuration file /var/lib/rancher/rke2/server/db/etcd/config has not been modified to use custom cert and key files.
  query: |
    SELECT 1 AS success
    FROM 
        processes
    WHERE 
        name = 'etcd' AND cmdline LIKE '%--cert-file%' AND cmdline LIKE '%--key-file%';
  purpose: Informational
  tags: compliance, CIS, CIS_Level1
  contributors: mccormickjw
---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure that the scheduler.conf file ownership is set to root:root
  platform: linux
  description: CIS K8s benchamrk 1.1.16 -> Ensure that the scheduler.conf file ownership is set to root:root.
  resolution: The scheduler.conf file is the kubeconfig file for the Scheduler. You should set its file ownership to maintain the integrity of the file. The file should be owned by root:root.
  query: |
    SELECT 1 WHERE
      EXISTS(
        SELECT 
          1 as pass 
        FROM 
          file 
        WHERE 
          path = '/var/lib/rancher/rke2/server/cred/scheduler.kubeconfig' 
          AND uid = 0 
          AND gid = 0;
          )
        OR NOT EXISTS (
          SELECT 1 FROM file WHERE path = '/var/lib/rancher/rke2/server/cred/scheduler.kubeconfig'
          );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1
  contributors: rsjaklic20
---
