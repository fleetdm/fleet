---
apiVersion: v1
kind: policy
spec:
  name: CIS - Ensure that the --profiling argument is set to false
  platforms: RHEL_version_x
  platform: linux
  description: |
    Disable profiling, if not needed.
  resolution: |
    Edit the API server pod specification file /etc/kubernetes/manifests/kube-  apiserver.yaml on the Control Plane node and set the below parameter.  --profiling=false
  query: |
    SELECT 1 WHERE 
      EXISTS (
        SELECT 1 AS pass
        FROM processes
        WHERE name = 'kube-apiserver'
        AND cmdline LIKE '%--profiling=false%'
        )
      OR NOT EXISTS (
        SELECT 1 FROM processes WHERE name = 'kube-apiserver'
        );  
  purpose: Informational
  tags: compliance, CIS, CIS_Level1
  contributors: sharon-fdm
---
1
---
2
---
apiVersion: v1
kind: policy
spec:
  name: CIS (K8s) 1.1.14 - Ensure that the default administrative credential file ownership is set to root:root
  platform: linux
  description: |
    Ensure that the admin.conf (and super-admin.conf file, where it exists) file ownership is set to root:root.
  resolution: |
    Use the chown command to set the file ownership to root:root.
  query: |
    SELECT 1 WHERE NOT EXISTS (
      SELECT 1 FROM FILE f
        JOIN users u USING (uid)
        JOIN groups g USING (gid)
      WHERE f.path = '/var/lib/rancher/rke2/server/cred/admin.kubeconfig'
        AND (u.username != 'root' OR g.groupname != 'root')
    )
  purpose: Informational
  tags: compliance, CIS, CIS_Level1
  contributors: zwass
---
4
---
apiVersion: v1
kind: policy
spec:
  name: CIS - 1.2.9 - v1.12 - Ensure that the admission control plugin EventRateLimit is set (Manual)
  platforms: linux
  platform: linux
  description: |
    Limit the rate at which the API server accepts requests.
    Using EventRateLimit admission control enforces a limit on the number of events that
    the API Server will accept in a given time slice. A misbehaving workload could
    overwhelm and DoS the API Server, making it unavailable. This particularly applies to a
    multi-tenant cluster, where there might be a small percentage of misbehaving tenants
    which could have a significant impact on the performance of the cluster overall. Hence,
    it is recommended to limit the rate of events that the API server will accept.
  resolution: |
    Follow the Kubernetes documentation and set the desired limits in a configuration file.
    Then, edit the API server pod specification file /etc/kubernetes/manifests/kube-apiserver.yaml and set the below parameters.
    '--enable-admission-plugins=...,EventRateLimit,...'
    '--admission-control-config-file=<path/to/configuration/file>'
  query: |
    SELECT 1 WHERE ( SELECT 1 FROM processes where name like "%kube-apiserver%" and cmdline like "%--enable-admission-plugins=%EventRateLimit%" and cmdline like "%--admission-control-config-file=%") OR NOT EXISTS ( SELECT 1 FROM processes where name like "%kube-apiserver%");
  purpose: Informational
  tags: compliance, CIS, CIS_Level1
  contributors: baic
---
apiVersion: v1
kind: policy
spec:
  name: CIS 2.2 - Ensure that the --client-cert-auth argument is set to true
  platform: linux
  description: |
    Enable client authencation on etcd service.
  resolution: |
    Edit the etcd pod specification file /etc/kubernetes/manifests/etcd.yaml on the master node and set the parameter --client-cert-auth="true"
  query: |
    SELECT 1 WHERE
        EXISTS (
            SELECT 1
            FROM processes
            WHERE name = 'etcd'
            AND cmdline LIKE '%--client-cert-auth=true%'
        )
        OR NOT EXISTS (
            SELECT 1 FROM processes WHERE name = 'etcd'
        );
  purpose: Informational
  tags: compliance, CIS, CIS_Level1
  contributors: kc9wwh
---
7
---
8
---
9
