module.exports = {


  friendlyName: 'View dashboard',


  description: 'Display "Dashboard" page.',


  exits: {

    success: {
      viewTemplatePath: 'pages/dashboard'
    }

  },


  fn: async function () {

    let dataForGraphs = {};
    // Sanity check.
    // console.time('all vulns query')
    // let allVulns = await Vulnerability.find();
    // console.timeEnd('all vulns query')

    console.time('all vulns native query');
    let nativeQueryToFindAllVulnerabilityIdsWithSeverity = `SELECT id, severity FROM vulnerability;`;
    console.timeEnd('all vulns native query');
    let vulnerabilityNativeQueryResult = await sails.sendNativeQuery(nativeQueryToFindAllVulnerabilityIdsWithSeverity);

    let vulnerabilityIdsWithSeverity = vulnerabilityNativeQueryResult.rows;



    let criticalSeverity = vulnerabilityIdsWithSeverity.filter((vuln)=>{
      return vuln.severity >= 9;
    });
    let highSeverity = vulnerabilityIdsWithSeverity.filter((vuln)=>{
      return vuln.severity <= 8.9 && vuln.severity >= 7.0;
    });
    let mediumSeverity = vulnerabilityIdsWithSeverity.filter((vuln)=>{
      return vuln.severity <= 6.9 && vuln.severity >= 4.0;
    });
    let lowSeverity = vulnerabilityIdsWithSeverity.filter((vuln)=>{
      return vuln.severity >= 0 && vuln.severity <= 3.9;
    });

    let totalUniqueCounts = {
      low: lowSeverity.length,
      medium: mediumSeverity.length,
      high: highSeverity.length,
      critical: criticalSeverity.length,
    };
    console.log(totalUniqueCounts);




    // Now build native SQL Queries using the IDs of vulnerabilities to find vulnerabilityInstall records for each severity.
    let lowVulnerabilityInstallNativeQuery;
    let mediumVulnerabilityInstallNativeQuery;
    let highVulnerabilityInstallNativeQuery;
    let criticalVulnerabilityInstallNativeQuery;
    if(sails.config.datastores.default.adapter === 'sails-postgresql') {
      // If this app is configured to use a Postgres datastore, we'll need to put double quotes around the uninstalledAt column name.
      lowVulnerabilityInstallNativeQuery = `
      SELECT * FROM vulnerabilityinstall
        WHERE "uninstalledAt" = 0 AND vulnerability IN (${_.pluck(lowSeverity,'id').join(',')});`;
      mediumVulnerabilityInstallNativeQuery = `
      SELECT * FROM vulnerabilityinstall
        WHERE "uninstalledAt" = 0 AND vulnerability IN (${_.pluck(mediumSeverity,'id').join(',')})`;
      highVulnerabilityInstallNativeQuery = `
      SELECT * FROM vulnerabilityinstall
        WHERE "uninstalledAt" = 0 AND vulnerability IN (${_.pluck(highSeverity,'id').join(',')})`;
      criticalVulnerabilityInstallNativeQuery = `
      SELECT * FROM vulnerabilityinstall
        WHERE "uninstalledAt" = 0 AND vulnerability IN (${_.pluck(criticalSeverity,'id').join(',')})`;
    } else if(sails.config.datastores.default.adapter === 'sails-mysql') {
      lowVulnerabilityInstallNativeQuery = `
      SELECT * FROM vulnerabilityinstall
        WHERE uninstalledAt = 0 AND vulnerability IN (${_.pluck(lowSeverity,'id').join(',')})`;
      mediumVulnerabilityInstallNativeQuery = `
      SELECT * FROM vulnerabilityinstall
        WHERE uninstalledAt = 0 AND vulnerability IN (${_.pluck(mediumSeverity,'id').join(',')})`;
      highVulnerabilityInstallNativeQuery = `
      SELECT * FROM vulnerabilityinstall
        WHERE uninstalledAt = 0 AND vulnerability IN (${_.pluck(highSeverity,'id').join(',')})`;
      criticalVulnerabilityInstallNativeQuery = `
      SELECT * FROM vulnerabilityinstall
        WHERE uninstalledAt = 0 AND vulnerability IN (${_.pluck(criticalSeverity,'id').join(',')})`;
    }

    console.time(`native queries to get total counts`)
    // Now send some queries.
    let criticalVulnInstallsResult = await sails.sendNativeQuery(criticalVulnerabilityInstallNativeQuery);
    let totalInstallsWithCricitalVulns = criticalVulnInstallsResult.rows;
    let highVulnInstallsResult = await sails.sendNativeQuery(highVulnerabilityInstallNativeQuery);
    let totalInstallsWithHighVulns = highVulnInstallsResult.rows;
    let mediumVulnInstallsResult = await sails.sendNativeQuery(mediumVulnerabilityInstallNativeQuery);
    let totalInstallsWithMediumVulns = mediumVulnInstallsResult.rows;
    let lowVulnInstallsResult = await sails.sendNativeQuery(lowVulnerabilityInstallNativeQuery);
    let totalInstallsWithLowVulns = lowVulnInstallsResult.rows;
    console.timeEnd(`native queries to get total counts`)

    let totalNumberOfVulns = {
      low: totalInstallsWithLowVulns.length,
      medium: totalInstallsWithMediumVulns.length,
      high: totalInstallsWithHighVulns.length,
      critical: totalInstallsWithCricitalVulns.length
    }
    console.log(totalNumberOfVulns);
    dataForGraphs.totalNumberOfVulns = totalNumberOfVulns;
    // console.log(totalInstallsWithCricitalVulns)
    // console.log(totalInstallsWithCricitalVulns.length)



    // console.log(allVulns.length)
    // console.log(_.unique(allVulns, 'cveId').length)

    // console.time('counts queries');
    // // Get unique critical vulnerabilities
    // numberOfCriticalVulns = await Vulnerability.count({
    //   severity: {
    //     '>=': 9
    //   }
    // });
    // console.log(numberOfCriticalVulns);

    // // Get unique high vulnerabilities
    // let numberOfHighVulns = await Vulnerability.count({
    //   severity: {
    //     '<': 9,
    //     '>': 7
    //   }
    // });

    // console.log(numberOfHighVulns);

    // // Get unique medium vulnerabilities
    // let numberOfMediumVulns = await Vulnerability.count({
    //   severity: {
    //     '<': 7,
    //     '>': 4
    //   }
    // });

    // console.log(numberOfMediumVulns);


    // // Get unique low vulnerabilities
    // let numberOfLowVulns = await Vulnerability.count({
    //   severity: {
    //     '<': 4
    //   }
    // });

    // console.log(numberOfLowVulns);

    // console.timeEnd('counts queries');



    dataForGraphs.totalUniqueCounts = totalUniqueCounts;
    // Get total critical vulns.

    // We may need to use a native query for this.
    // let queryToFind



    // Get total high vulns.
    // Get total medium vulns.
    // Get total low vulns.


    // Get top ten most vulnerable hosts

    let nativeQueryToFindTopTenMostVulnerableHosts = `
    SELECT
      h."displayName" AS host,
      h."fleetApid" AS hostId,
      MAX(v.severity) AS highestSeverityVulnerability
    FROM vulnerabilityinstall vi
    JOIN vulnerability v ON vi.vulnerability = v.id
    JOIN host h ON vi.host = h.id
    WHERE
      vi."uninstalledAt" IS NULL OR vi."uninstalledAt" = 0
    GROUP BY
      h.id, h."displayName"
    ORDER BY
      highestSeverityVulnerability DESC
    LIMIT 10;`;

    console.time(`native query to find top 10 most vulnerable hosts`)
    let topTenMostVulnerableHosts = await sails.sendNativeQuery(nativeQueryToFindTopTenMostVulnerableHosts)
    console.timeEnd(`native query to find top 10 most vulnerable hosts`)
    let mostVulnerableHosts = topTenMostVulnerableHosts.rows.map((host)=>{
      return {
        displayName: host.host,
        fleetUrl: sails.config.custom.fleetBaseUrl + `/hosts/${host.hostid}`,
        highestSeverity: host.highestseverityvulnerability,
      }
    })
    dataForGraphs.mostVulnerableHosts = mostVulnerableHosts;
    // Get most vulnerable software.

    let nativeQueryToFindTopTenMostVulnerableSoftwareItems = `
    SELECT
        vi."softwareName",
        vi."versionName",
        vi."fleetApid",
        COUNT(DISTINCT v.id) AS "numberOfVulns"
    FROM vulnerabilityinstall vi
    JOIN vulnerability v
      ON vi.vulnerability = v.id
    WHERE
        vi."uninstalledAt" IS NULL OR vi."uninstalledAt" = 0
    GROUP BY
        vi."softwareName",
        vi."versionName",
        vi."fleetApid"
    ORDER BY
        "numberOfVulns" DESC
    LIMIT 10;`;
    console.time(`top ten most vulenerable software query`);
    let topVulnerableSoftwareResult = await sails.sendNativeQuery(nativeQueryToFindTopTenMostVulnerableSoftwareItems)
    console.timeEnd(`top ten most vulenerable software query`);
    console.log(topVulnerableSoftwareResult)
    let topTenMostVulnerableSoftwareItems = topVulnerableSoftwareResult.rows.map((software)=>{
      return {
        softwareNameAndVersion: `${software.softwareName} - ${software.versionName}`,
        fleetUrl: sails.config.custom.fleetBaseUrl + `/software/versions/${software.fleetApid}`,
        numberOfVulns: software.numberOfVulns,
      }
    })

    dataForGraphs.mostVulnerableSoftware = topTenMostVulnerableSoftwareItems;

    // Get top critical unique software
    // Software with most vulnerabilities that are installed on < 5 hosts.

    let queryToFindTopUniqueCriticalSoftwareWithMostVulnerabilities = `
    WITH "activeInstalls" AS (
      SELECT
        vulnerabilityinstall.host,
        vulnerabilityinstall."softwareName",
        vulnerabilityinstall."versionName",
        vulnerabilityinstall."fleetApid",
        vulnerabilityinstall."softwareName" || ' ' || COALESCE(vulnerabilityinstall."versionName", '') AS "softwareNameAndVersion"
      FROM vulnerabilityinstall
      WHERE vulnerabilityinstall."uninstalledAt" IS NULL OR vulnerabilityinstall."uninstalledAt" = 0
    ),
    "softwareHostCounts" AS (
      SELECT
        "activeInstalls"."softwareNameAndVersion",
        COUNT(DISTINCT "activeInstalls".host) AS "hostInstallCount",
        STRING_AGG(DISTINCT host."displayName", ', ' ORDER BY host."displayName") AS "hostNames",
        STRING_AGG(
      DISTINCT "activeInstalls"."fleetApid"::text,
      ', ' ORDER BY "activeInstalls"."fleetApid"::text
    ) AS "fleetApid"
      FROM "activeInstalls"
      JOIN host ON host.id = "activeInstalls".host
      GROUP BY "activeInstalls"."softwareNameAndVersion"
    ),
    "criticalVulnerabilityAgg" AS (
      SELECT
        "activeInstalls"."softwareNameAndVersion",
        COUNT(DISTINCT vulnerability.id) AS "vulnerabilityCount",
        STRING_AGG(DISTINCT vulnerability."cveId", ', ' ORDER BY vulnerability."cveId") AS "cveIds"
      FROM "activeInstalls"
      JOIN vulnerabilityinstall ON
           vulnerabilityinstall.host = "activeInstalls".host
       AND vulnerabilityinstall."softwareName" = "activeInstalls"."softwareName"
       AND COALESCE(vulnerabilityinstall."versionName",'') = COALESCE("activeInstalls"."versionName",'')
       AND (vulnerabilityinstall."uninstalledAt" IS NULL OR vulnerabilityinstall."uninstalledAt" = 0)
      JOIN vulnerability ON vulnerability.id = vulnerabilityinstall.vulnerability
      WHERE vulnerability.severity >= 9.0
      GROUP BY "activeInstalls"."softwareNameAndVersion"
    )
    SELECT
      "softwareHostCounts"."softwareNameAndVersion",
      "softwareHostCounts"."hostInstallCount",
      "criticalVulnerabilityAgg"."vulnerabilityCount",
      "criticalVulnerabilityAgg"."cveIds",
      "softwareHostCounts"."hostNames",
      "softwareHostCounts"."fleetApid"
    FROM "softwareHostCounts"
    JOIN "criticalVulnerabilityAgg"
      ON "criticalVulnerabilityAgg"."softwareNameAndVersion" = "softwareHostCounts"."softwareNameAndVersion"
    WHERE "softwareHostCounts"."hostInstallCount" < 5
    ORDER BY
      "criticalVulnerabilityAgg"."vulnerabilityCount" DESC,
      "softwareHostCounts"."hostInstallCount" ASC,
      "softwareHostCounts"."softwareNameAndVersion" ASC
    LIMIT 10;`;

    let topUniqueCriticalVulnsResult = await sails.sendNativeQuery(queryToFindTopUniqueCriticalSoftwareWithMostVulnerabilities);
    // console.log(topUniqueCriticalVulnsResult);
    let uniqueCriticalSoftware = topUniqueCriticalVulnsResult.rows.map((software)=>{
      // Build an array of CVE objects, with each containing the CVE ID and a link to the Fleet page for the CVE.
      let cves = software.cveIds.split(', ').map((cveId)=>{
        return {
          name: cveId,
          url: `${sails.config.custom.fleetBaseUrl}/software/vulnerabilities/${cveId}`
        }
      })

      return {
        softwareNameAndVersion: software.softwareNameAndVersion,
        fleetUrl: `${sails.config.custom.fleetBaseUrl}/software/versions/${software.fleetApid}`,
        numberOfVulns: software.vulnerabilityCount,
        cves,
        affectedHosts: software.hostNames.split(', '),
      }
    })
    dataForGraphs.uniqueCriticalSoftware = uniqueCriticalSoftware;
    // console.log(uniqueCriticalSoftware);


    // Top 5 external hosts with number of criitcal vulnerabilities

    let nativeQueryToFindMostVulnerableExternalHosts = `
    WITH "activeCriticalVulnerabilityInstalls" AS (
        -- Active vulnerability installs where the vulnerability is critical
        SELECT DISTINCT
            vulnerabilityinstall.host,
            vulnerabilityinstall.vulnerability
        FROM vulnerabilityinstall
        JOIN vulnerability
            ON vulnerability.id = vulnerabilityinstall.vulnerability
        WHERE
            (
                vulnerabilityinstall."uninstalledAt" IS NULL
                OR vulnerabilityinstall."uninstalledAt" = 0
            )
            AND vulnerability.severity >= 9.0
    ),
    "criticalVulnerabilityCountsByHost" AS (
        -- Count how many distinct critical vulnerabilities each host has
        SELECT
            activeCriticalVulnerabilityInstalls.host,
            COUNT(DISTINCT activeCriticalVulnerabilityInstalls.vulnerability) AS "criticalVulnerabilityCount",
            STRING_AGG(
                DISTINCT vulnerability."cveId",
                ', ' ORDER BY vulnerability."cveId"
            ) AS "cveIds"
        FROM "activeCriticalVulnerabilityInstalls" AS activeCriticalVulnerabilityInstalls
        JOIN vulnerability
            ON vulnerability.id = activeCriticalVulnerabilityInstalls.vulnerability
        GROUP BY
            activeCriticalVulnerabilityInstalls.host
    )
    SELECT
        host."displayName" AS "displayName",
        host."fleetApid" AS "fleetApid",
        host."teamDisplayName" AS "teamName",
        criticalVulnerabilityCountsByHost."criticalVulnerabilityCount",
        criticalVulnerabilityCountsByHost."cveIds"
    FROM "criticalVulnerabilityCountsByHost" AS criticalVulnerabilityCountsByHost
    JOIN host
        ON host.id = criticalVulnerabilityCountsByHost.host
    WHERE
        host."teamDisplayName" ILIKE '%server%'
    ORDER BY
        criticalVulnerabilityCountsByHost."criticalVulnerabilityCount" DESC,
        host."displayName" ASC
    LIMIT 5;`;


    let topFiveVulnerableExternalHostsResult = await sails.sendNativeQuery(nativeQueryToFindMostVulnerableExternalHosts);

    let mostVulnerableExternalHosts = topFiveVulnerableExternalHostsResult.rows.map((host)=>{
      let cves = host.cveIds.split(', ').map((cveId)=>{
        return {
          name: cveId,
          url: `${sails.config.custom.fleetBaseUrl}/software/vulnerabilities/${cveId}`
        }
      })
      return {
        displayName: host.displayName,
        fleetUrl: `${sails.config.custom.fleetBaseUrl}/hosts/${host.fleetApid}`,
        numberOfVulns: host.criticalVulnerabilityCount,
        cves,
      }
    });

    dataForGraphs.mostVulnerableExternalHosts = mostVulnerableExternalHosts;



    // Hosts with most CVEs

    let hostsWithMostVulnsQuery = `
    WITH "activeVulnerabilityInstalls" AS (
      SELECT DISTINCT
        vulnerabilityinstall.host,
        vulnerabilityinstall.vulnerability
      FROM vulnerabilityinstall
      WHERE
        vulnerabilityinstall."uninstalledAt" IS NULL
        OR vulnerabilityinstall."uninstalledAt" = 0
    ),
    "vulnerabilityCountsByHost" AS (
      SELECT
        activeVulnerabilityInstalls.host,
        COUNT(DISTINCT activeVulnerabilityInstalls.vulnerability) AS "vulnerabilityCount",
        STRING_AGG(DISTINCT vulnerability."cveId", ', ' ORDER BY vulnerability."cveId") AS "cveIds"
      FROM "activeVulnerabilityInstalls" AS activeVulnerabilityInstalls
      JOIN vulnerability
        ON vulnerability.id = activeVulnerabilityInstalls.vulnerability
      GROUP BY
        activeVulnerabilityInstalls.host
    )
    SELECT
      host."displayName" AS "displayName",
      host."fleetApid" AS "fleetApid",
      vulnerabilityCountsByHost."vulnerabilityCount",
      vulnerabilityCountsByHost."cveIds"
    FROM "vulnerabilityCountsByHost" AS vulnerabilityCountsByHost
    JOIN host
      ON host.id = vulnerabilityCountsByHost.host
    ORDER BY
      vulnerabilityCountsByHost."vulnerabilityCount" DESC,
      host."displayName" ASC
    LIMIT 10;
`;

    let hostWithMostVulnsResult = await sails.sendNativeQuery(hostsWithMostVulnsQuery);

    let hostsWithMostVulns = hostWithMostVulnsResult.rows.map((host)=>{
      let cves = host.cveIds.split(', ').map((cveId)=>{
        return {
          name: cveId,
          url: `${sails.config.custom.fleetBaseUrl}/software/vulnerabilities/${cveId}`
        }
      })
      return {
        displayName: host.displayName,
        fleetUrl: `${sails.config.custom.fleetBaseUrl}/hosts/${host.fleetApid}`,
        numberOfVulns: host.vulnerabilityCount,
        cves,
      }
    });

    dataForGraphs.hostsWithMostVulns = hostsWithMostVulns;

    // Hosts will always have:
    //   - displayName
    //   - fleetUrl
    // Software items will always have:
    //   - softwareNameAndVersion
    //   - fleetUrl
    // Top 6.



    // CVE Activity Trends



    // Respond with view.
    return {
      ...dataForGraphs
    };

  }


};
