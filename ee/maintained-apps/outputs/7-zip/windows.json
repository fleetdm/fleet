{
  "versions": [
    {
      "version": "25.01",
      "queries": {
        "exists": "SELECT 1 FROM programs WHERE name = '7-Zip 25.01 (x64)' AND publisher = 'Igor Pavlov';"
      },
      "installer_url": "https://7-zip.org/a/7z2501-x64.msi",
      "install_script_ref": "8959087b",
      "uninstall_script_ref": "f5763693",
      "sha256": "e7eb0b7ed5efa4e087b7b17f191797f7af5b7f442d1290c66f3a21777005ef57",
      "default_categories": [
        "Productivity"
      ],
      "upgrade_code": "{23170F69-40C1-2702-0000-000004000000}"
    }
  ],
  "refs": {
    "8959087b": "$logFile = \"${env:TEMP}/fleet-install-software.log\"\n\ntry {\n\n$installProcess = Start-Process msiexec.exe `\n  -ArgumentList \"/quiet /norestart /lv ${logFile} /i `\"${env:INSTALLER_PATH}`\"\" `\n  -PassThru -Verb RunAs -Wait\n\nGet-Content $logFile -Tail 500\n\nExit $installProcess.ExitCode\n\n} catch {\n  Write-Host \"Error: $_\"\n  Exit 1\n}\n",
    "f5763693": "# Attempts to locate 7-Zip's product code and uninstall it using msiexec\n# This script is version-agnostic and will find any installed version of 7-Zip\n\n$displayNamePattern = \"7-Zip*\"\n$publisher = \"Igor Pavlov\"\n$upgradeCode = \"{23170F69-40C1-2702-0000-000004000000}\"\n\n# Close any running 7-Zip processes before uninstalling\nWrite-Host \"Closing any running 7-Zip processes...\"\nGet-Process -Name \"7z*\" -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue\nGet-Process -Name \"7zFM\" -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue\nStart-Sleep -Seconds 2\n\n$productCodes = @()\n$timeoutSeconds = 300  # 5 minute timeout per product\n\n# Method 1: Use upgrade code to find all related products (most reliable for MSI)\nWrite-Host \"Searching for 7-Zip using upgrade code: $upgradeCode\"\ntry {\n  $installer = New-Object -ComObject WindowsInstaller.Installer\n  $relatedProducts = $installer.RelatedProducts($upgradeCode)\n  foreach ($productCode in $relatedProducts) {\n    $productCodes += $productCode\n    Write-Host \"Found product code via upgrade code: $productCode\"\n  }\n} catch {\n  Write-Host \"Upgrade code method failed: $_\"\n}\n\n# Method 2: Search registry for any 7-Zip installation\nif ($productCodes.Count -eq 0) {\n  Write-Host \"Searching registry for 7-Zip installation...\"\n  \n  $paths = @(\n    'HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall',\n    'HKLM:\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall',\n    'HKCU:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall',\n    'HKCU:\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall'\n  )\n\n  foreach ($p in $paths) {\n    $items = Get-ChildItem -Path $p -ErrorAction SilentlyContinue | ForEach-Object {\n      Get-ItemProperty $_.PSPath -ErrorAction SilentlyContinue\n    } | Where-Object {\n      $_.DisplayName -and $_.DisplayName -like $displayNamePattern -and ($publisher -eq \"\" -or $_.Publisher -eq $publisher) -and $_.PSChildName -match '^{[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}}$'\n    }\n    if ($items) {\n      $foundCode = ($items | Select-Object -First 1).PSChildName\n      if ($foundCode -notin $productCodes) {\n        $productCodes += $foundCode\n        Write-Host \"Found product code in registry: $foundCode\"\n      }\n    }\n  }\n}\n\n# Method 3: Use WindowsInstaller COM object to find by name\nif ($productCodes.Count -eq 0) {\n  Write-Host \"Trying WindowsInstaller COM object method...\"\n  try {\n    if (-not $installer) {\n      $installer = New-Object -ComObject WindowsInstaller.Installer\n    }\n    $products = $installer.Products\n    \n    foreach ($product in $products) {\n      try {\n        $productName = $installer.ProductInfo($product, \"ProductName\")\n        if ($productName -like $displayNamePattern) {\n          if ($product -notin $productCodes) {\n            $productCodes += $product\n            Write-Host \"Found product code via WindowsInstaller: $product (Product: $productName)\"\n          }\n        }\n      } catch {\n        # Continue searching\n      }\n    }\n  } catch {\n    Write-Host \"WindowsInstaller COM object method failed: $_\"\n  }\n}\n\nif ($productCodes.Count -eq 0) {\n  Write-Host \"Product code not found for 7-Zip\"\n  Exit 0  # Not found = success for Fleet\n}\n\n# Uninstall all found product codes\n$allSucceeded = $true\nforeach ($productCode in $productCodes) {\n  Write-Host \"Attempting to uninstall product code: $productCode\"\n  \n  try {\n    # Use /qn (quiet no UI) for better compatibility\n    # REBOOT=ReallySuppress prevents any reboot prompts\n    $process = Start-Process msiexec -ArgumentList @(\"/x\", $productCode, \"/qn\", \"/norestart\", \"REBOOT=ReallySuppress\") -PassThru -NoNewWindow\n    \n    # Wait for process with timeout\n    $completed = $process.WaitForExit($timeoutSeconds * 1000)\n    if (-not $completed) {\n      Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue\n      Write-Host \"Uninstall timed out after $timeoutSeconds seconds for product code: $productCode\"\n      $allSucceeded = $false\n      continue\n    }\n    \n    # Check exit code\n    if ($process.ExitCode -eq 0) {\n      Write-Host \"Uninstall successful for product code: $productCode (exit code: 0)\"\n    } else {\n      Write-Host \"Uninstall failed for product code: $productCode with exit code: $($process.ExitCode)\"\n      $allSucceeded = $false\n    }\n  } catch {\n    Write-Host \"Error running uninstaller for product code $productCode : $_\"\n    $allSucceeded = $false\n  }\n}\n\n# Add a delay to ensure filesystem and registry are updated\nif ($allSucceeded) {\n  Write-Host \"All uninstalls completed successfully\"\n  Start-Sleep -Seconds 5\n  Exit 0\n} else {\n  Write-Host \"One or more uninstalls failed\"\n  Exit 1603  # ERROR_UNINSTALL_FAILURE\n}\n"
  }
}
