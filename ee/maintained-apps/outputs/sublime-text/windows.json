{
  "versions": [
    {
      "version": "4.0.0.420000",
      "queries": {
        "exists": "SELECT 1 FROM programs WHERE name = 'Sublime Text' AND publisher = 'Sublime HQ Pty Ltd';"
      },
      "installer_url": "https://download.sublimetext.com/sublime_text_build_4200_x64_setup.exe",
      "install_script_ref": "65690e6c",
      "uninstall_script_ref": "03f70392",
      "sha256": "3d3c70e51aef08f85d7160bcc70793bed9acec250973090ab67d98987bce7c7e",
      "default_categories": [
        "Developer tools"
      ]
    }
  ],
  "refs": {
    "03f70392": "# Attempts to locate Sublime Text's uninstaller from registry and execute it silently\n\n$displayName = \"Sublime Text\"\n$publisher = \"Sublime HQ Pty Ltd\"\n\n$paths = @(\n  'HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall',\n  'HKLM:\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall',\n  'HKCU:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall'\n)\n\n$uninstall = $null\nforeach ($p in $paths) {\n  $items = Get-ItemProperty \"$p\\*\" -ErrorAction SilentlyContinue | Where-Object {\n    $_.DisplayName -and ($_.DisplayName -eq $displayName -or $_.DisplayName -like \"$displayName*\") -and ($publisher -eq \"\" -or $_.Publisher -eq $publisher)\n  }\n  if ($items) { $uninstall = $items | Select-Object -First 1; break }\n}\n\nif (-not $uninstall -or -not $uninstall.UninstallString) {\n  Write-Host \"Uninstall entry not found\"\n  Exit 0\n}\n\n# Kill any running Sublime Text processes before uninstalling\nStop-Process -Name \"sublime_text\" -Force -ErrorAction SilentlyContinue\nStart-Sleep -Seconds 2\n\n$uninstallCommand = $uninstall.UninstallString\n$uninstallArgs = \"/VERYSILENT /NORESTART\"\n\n# Parse the uninstall command to separate executable from existing arguments\n$splitArgs = $uninstallCommand.Split('\"')\nif ($splitArgs.Length -gt 1) {\n    if ($splitArgs.Length -eq 3) {\n        $existingArgs = $splitArgs[2].Trim()\n        if ($existingArgs -ne '') {\n            $uninstallArgs = \"$existingArgs $uninstallArgs\"\n        }\n    } elseif ($splitArgs.Length -gt 3) {\n        Write-Host \"Error: Uninstall command contains multiple quoted strings\"\n        Exit 1\n    }\n    $uninstallCommand = $splitArgs[1]\n}\n\nWrite-Host \"Uninstall command: $uninstallCommand\"\nWrite-Host \"Uninstall args: $uninstallArgs\"\n\ntry {\n    $processOptions = @{\n        FilePath = $uninstallCommand\n        ArgumentList = $uninstallArgs\n        NoNewWindow = $true\n        PassThru = $true\n        Wait = $true\n    }\n    \n    $process = Start-Process @processOptions\n    $exitCode = $process.ExitCode\n    \n    Write-Host \"Uninstall exit code: $exitCode\"\n    Exit $exitCode\n} catch {\n    Write-Host \"Error running uninstaller: $_\"\n    Exit 1\n}\n\n",
    "65690e6c": "# Learn more about .exe install scripts:\n# http://fleetdm.com/learn-more-about/exe-install-scripts\n\n$exeFilePath = \"${env:INSTALLER_PATH}\"\n\ntry {\n    # Verify installer file exists\n    if (-not (Test-Path $exeFilePath)) {\n        Write-Host \"Error: Installer file not found at: $exeFilePath\"\n        Exit 1\n    }\n\n    Write-Host \"Installing Sublime Text from: $exeFilePath\"\n    \n    # Add arguments to install silently\n    # Sublime Text uses an Inno Setup-based installer\n    # Based on winget manifest: https://github.com/microsoft/winget-pkgs/blob/master/manifests/s/SublimeHQ/SublimeText/4/4.0.0.420000/SublimeHQ.SublimeText.4.installer.yaml\n    # /VERYSILENT = Very silent installation (no dialogs, no progress bar)\n    # /SUPPRESSMSGBOXES = Suppress message boxes\n    # /NORESTART = Do not restart the computer\n    $processOptions = @{\n        FilePath = \"$exeFilePath\"\n        ArgumentList = \"/VERYSILENT /SUPPRESSMSGBOXES /NORESTART\"\n        PassThru = $true\n        Wait = $true\n        NoNewWindow = $true\n    }\n    \n    # Start process and track exit code\n    Write-Host \"Starting installation with arguments: $($processOptions.ArgumentList)\"\n    $process = Start-Process @processOptions\n    \n    if ($null -eq $process) {\n        Write-Host \"Error: Failed to start installer process\"\n        Exit 1\n    }\n    \n    $exitCode = $process.ExitCode\n    \n    # Prints the exit code\n    Write-Host \"Install exit code: $exitCode\"\n    \n    # Sublime Text's installer intentionally doesn't write version to registry\n    # We need to manually write it so osquery can detect it\n    if ($exitCode -eq 0) {\n        Write-Host \"Writing version to registry for osquery detection...\"\n        \n        # Wait a moment for installation to complete and registry to be created\n        Start-Sleep -Seconds 2\n        \n        # Get version from the installed executable's file version\n        $sublimeExe = \"C:\\Program Files\\Sublime Text\\sublime_text.exe\"\n        $version = $null\n        \n        if (Test-Path $sublimeExe) {\n            try {\n                $fileVersionInfo = (Get-Item $sublimeExe).VersionInfo\n                # Try FileVersion first, fall back to ProductVersion\n                $version = if ($fileVersionInfo.FileVersion) { $fileVersionInfo.FileVersion } else { $fileVersionInfo.ProductVersion }\n                Write-Host \"Found version from executable: $version\"\n            } catch {\n                Write-Host \"Warning: Could not read version from executable: $_\"\n            }\n        }\n        \n        # If we still don't have a version, try to extract from installer filename\n        if (-not $version) {\n            $installerName = Split-Path -Leaf $exeFilePath\n            # Try to match build number pattern (e.g., \"sublime_text_build_4200_x64_setup.exe\")\n            if ($installerName -match 'build_(\\d+)') {\n                $buildNumber = $matches[1]\n                # Convert build number to version format (e.g., 4200 -> 4.0.0.420000)\n                # This is a heuristic - actual version format may vary\n                $major = if ($buildNumber.Length -ge 1) { $buildNumber[0] } else { \"4\" }\n                $minor = \"0\"\n                $patch = \"0\"\n                $build = $buildNumber.PadRight(6, '0')\n                $version = \"$major.$minor.$patch.$build\"\n                Write-Host \"Extracted version from filename: $version\"\n            }\n        }\n        \n        # Write version to registry if we found it\n        if ($version) {\n            $registryPath = \"HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\Sublime Text_is1\"\n            if (Test-Path $registryPath) {\n                try {\n                    Set-ItemProperty -Path $registryPath -Name \"DisplayVersion\" -Value $version -ErrorAction Stop\n                    Write-Host \"Successfully wrote version '$version' to registry at DisplayVersion\"\n                } catch {\n                    Write-Host \"Warning: Failed to write DisplayVersion to registry: $_\"\n                }\n            } else {\n                Write-Host \"Warning: Registry key not found at $registryPath\"\n            }\n        } else {\n            Write-Host \"Warning: Could not determine version to write to registry\"\n        }\n    }\n    \n    Exit $exitCode\n\n} catch {\n    Write-Host \"Error: $_\"\n    Write-Host \"Error details: $($_.Exception.Message)\"\n    Exit 1\n}\n\n"
  }
}
