projects:
  - name: Fleet Customer Metrics
    environments:
      - name: Production
        databases:
          - name: metrics-db
            databaseName: metrics
            user: metrics
            plan: basic-256mb
            region: oregon
            ipAllowList: [] # Only allow internal connections
            postgresMajorVersion: "18"
            diskSizeGB: 2
          - name: grafana-db
            databaseName: grafana
            user: grafana
            plan: basic-256mb
            region: oregon
            ipAllowList: []
            postgresMajorVersion: "18"
            diskSizeGB: 1
        services:
          - type: web
            name: grafana
            runtime: image
            image:
              url: docker.io/grafana/grafana-oss:latest
            plan: starter
            envVars:
              - key: GF_SERVER_ROOT_URL
                sync: false
              - key: GF_SECURITY_ADMIN_USER
                sync: false
              - key: GF_SECURITY_ADMIN_PASSWORD
                sync: false
              - key: GF_DATABASE_USER
                fromDatabase:
                  name: grafana-db
                  property: user
              - key: GF_DATABASE_TYPE
                value: postgres
              - key: GF_DATABASE_PASSWORD
                fromDatabase:
                  name: grafana-db
                  property: password
              - key: GF_DATABASE_NAME
                fromDatabase:
                  name: grafana-db
                  property: database
              - key: GF_DATABASE_HOST
                fromDatabase:
                  name: grafana-db
                  property: host
              - key: GF_INSTALL_PLUGINS
                value: volkovlabs-table-panel
            region: oregon
            healthCheckPath: /api/health
            autoDeployTrigger: commit
          - type: cron
            rootDir: tools/fleet-customer-metrics
            name: importer
            runtime: python
            plan: starter
            envVars:
              - key: CSV_URL
                sync: false
              - key: PGPASSWORD
                fromDatabase:
                  name: metrics-db
                  property: password
              - key: PGUSER
                fromDatabase:
                  name: metrics-db
                  property: user
              - key: PGDATABASE
                fromDatabase:
                  name: metrics-db
                  property: database
              - key: PGPORT
                fromDatabase:
                  name: metrics-db
                  property: port
              - key: PGHOST
                fromDatabase:
                  name: metrics-db
                  property: host
            region: oregon
            buildCommand: pip install -r requirements.txt
            startCommand: python import_data.py
            schedule: 04 * * * *
            autoDeployTrigger: commit
version: "1"
