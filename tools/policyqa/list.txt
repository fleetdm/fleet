========================================
name: CIS Ubuntu 22.04 - 1.1.1.6 Ensure overlay kernel module is not available (Automated)

---- run to pass ----
sudo bash -c "printf '%s\n' 'blacklist udf' 'install udf /bin/false' > /etc/modprobe.d/udf.conf"
sudo modprobe -r udf 2>/dev/null || true

---- run to fail ----
sudo rm -f /etc/modprobe.d/udf.conf
sudo modprobe udf 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE (SELECT COUNT(*) FROM kernel_modules WHERE name='udf') = 0
  AND (SELECT COUNT(*) FROM file_contents
       WHERE path LIKE '/etc/modprobe.d/%.conf'
         AND contents LIKE '%blacklist udf%'
         AND contents NOT LIKE '%#%') >= 1
  AND (SELECT COUNT(*) FROM file_contents
       WHERE path LIKE '/etc/modprobe.d/%.conf'
         AND (contents LIKE '%install udf /bin/false%' OR contents LIKE '%install udf /bin/true%')
         AND contents NOT LIKE '%#%') >= 1;

========================================
name: CIS Ubuntu 22.04 - 1.1.1.7 Ensure squashfs kernel module is not available (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE (SELECT COUNT(*) FROM kernel_modules WHERE name IN ('squashfs')) = 0
  AND (SELECT COUNT(*) FROM file_contents
       WHERE path LIKE '/etc/modprobe.d/%.conf'
         AND (contents LIKE '%blacklist squashfs%')
         AND contents NOT LIKE '%#%') >= 1
  AND (SELECT COUNT(*) FROM file_contents
       WHERE path LIKE '/etc/modprobe.d/%.conf'
         AND ((contents LIKE '%install squashfs /bin/false%') OR (contents LIKE '%install squashfs /bin/true%'))
         AND contents NOT LIKE '%#%') >= 1;

========================================
name: CIS Ubuntu 22.04 - 1.1.1.8 Ensure udf kernel module is not available (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE (SELECT COUNT(*) FROM kernel_modules WHERE name IN ('udf')) = 0
  AND (SELECT COUNT(*) FROM file_contents
       WHERE path LIKE '/etc/modprobe.d/%.conf'
         AND (contents LIKE '%blacklist udf%')
         AND contents NOT LIKE '%#%') >= 1
  AND (SELECT COUNT(*) FROM file_contents
       WHERE path LIKE '/etc/modprobe.d/%.conf'
         AND ((contents LIKE '%install udf /bin/false%') OR (contents LIKE '%install udf /bin/true%'))
         AND contents NOT LIKE '%#%') >= 1;

========================================
name: CIS Ubuntu 22.04 - 1.1.1.9 Ensure usb -storage kernel module is not available (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE (SELECT COUNT(*) FROM kernel_modules WHERE name IN ('usb-storage', 'usb_storage')) = 0
  AND (SELECT COUNT(*) FROM file_contents
       WHERE path LIKE '/etc/modprobe.d/%.conf'
         AND (contents LIKE '%blacklist usb-storage%' OR contents LIKE '%blacklist usb_storage%')
         AND contents NOT LIKE '%#%') >= 1
  AND (SELECT COUNT(*) FROM file_contents
       WHERE path LIKE '/etc/modprobe.d/%.conf'
         AND ((contents LIKE '%install usb-storage /bin/false%' OR contents LIKE '%install usb_storage /bin/false%') OR (contents LIKE '%install usb-storage /bin/true%' OR contents LIKE '%install usb_storage /bin/true%'))
         AND contents NOT LIKE '%#%') >= 1;

========================================
name: CIS Ubuntu 22.04 - 1.1.1.10 Ensure unused filesystems kernel modules are not available (Manual)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 1.1.1.11 Ensure firewire -core kernel module is not available (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE (SELECT COUNT(*) FROM kernel_modules WHERE name IN ('firewire-core', 'firewire_core')) = 0
  AND (SELECT COUNT(*) FROM file_contents
       WHERE path LIKE '/etc/modprobe.d/%.conf'
         AND (contents LIKE '%blacklist firewire-core%' OR contents LIKE '%blacklist firewire_core%')
         AND contents NOT LIKE '%#%') >= 1
  AND (SELECT COUNT(*) FROM file_contents
       WHERE path LIKE '/etc/modprobe.d/%.conf'
         AND ((contents LIKE '%install firewire-core /bin/false%' OR contents LIKE '%install firewire_core /bin/false%') OR (contents LIKE '%install firewire-core /bin/true%' OR contents LIKE '%install firewire_core /bin/true%'))
         AND contents NOT LIKE '%#%') >= 1;

========================================
name: CIS Ubuntu 22.04 - 1.1.2.1.1 Ensure /tmp is tmpfs or a separate partition (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM mounts WHERE path='/tmp');

========================================
name: CIS Ubuntu 22.04 - 1.1.2.1.2 Ensure nodev option set on /tmp partition (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM mounts
  WHERE path='/tmp'
    AND ',' || flags || ',' LIKE '%,nodev,%'
);

========================================
name: CIS Ubuntu 22.04 - 1.1.2.1.3 Ensure nosuid option set on /tmp partition (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM mounts
  WHERE path='/tmp'
    AND ',' || flags || ',' LIKE '%,nosuid,%'
);

========================================
name: CIS Ubuntu 22.04 - 1.1.2.1.4 Ensure noexec option set on /tmp partition (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM mounts
  WHERE path='/tmp'
    AND ',' || flags || ',' LIKE '%,noexec,%'
);

========================================
name: CIS Ubuntu 22.04 - 1.1.2.2.1 Ensure /dev/shm is tmpfs or a separate partition (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM mounts WHERE path='/dev/shm');

========================================
name: CIS Ubuntu 22.04 - 1.1.2.2.2 Ensure nodev option set on /dev/shm partition (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM mounts
  WHERE path='/dev/shm'
    AND ',' || flags || ',' LIKE '%,nodev,%'
);

========================================
name: CIS Ubuntu 22.04 - 1.1.2.2.3 Ensure nosuid option set on /dev/shm partition (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM mounts
  WHERE path='/dev/shm'
    AND ',' || flags || ',' LIKE '%,nosuid,%'
);

========================================
name: CIS Ubuntu 22.04 - 1.1.2.2.4 Ensure noexec option set on /dev/shm partition (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM mounts
  WHERE path='/dev/shm'
    AND ',' || flags || ',' LIKE '%,noexec,%'
);

========================================
name: CIS Ubuntu 22.04 - 1.1.2.3.1 Ensure separate partition exists for /home (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 1.1.2.3.2 Ensure nodev option set on /home partition (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM mounts
  WHERE path='/home'
    AND ',' || flags || ',' LIKE '%,nodev,%'
);

========================================
name: CIS Ubuntu 22.04 - 1.1.2.3.3 Ensure nosuid option set on /home partition (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM mounts
  WHERE path='/home'
    AND ',' || flags || ',' LIKE '%,nosuid,%'
);

========================================
name: CIS Ubuntu 22.04 - 1.1.2.4.1 Ensure separate partition exists for /var (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 1.1.2.4.2 Ensure nodev option set on /var partition (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM mounts
  WHERE path='/var'
    AND ',' || flags || ',' LIKE '%,nodev,%'
);

========================================
name: CIS Ubuntu 22.04 - 1.1.2.4.3 Ensure nosuid option set on /var partition (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM mounts
  WHERE path='/var'
    AND ',' || flags || ',' LIKE '%,nosuid,%'
);

========================================
name: CIS Ubuntu 22.04 - 1.1.2.5.1 Ensure separate partition exists for /var/tmp (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 1.1.2.5.2 Ensure nodev option set on /var/tmp partition (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM mounts
  WHERE path='/var/tmp'
    AND ',' || flags || ',' LIKE '%,nodev,%'
);

========================================
name: CIS Ubuntu 22.04 - 1.1.2.5.3 Ensure nosuid option set on /var/tmp partition (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM mounts
  WHERE path='/var/tmp'
    AND ',' || flags || ',' LIKE '%,nosuid,%'
);

========================================
name: CIS Ubuntu 22.04 - 1.1.2.5.4 Ensure noexec option set on /var/tmp partition (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM mounts
  WHERE path='/var/tmp'
    AND ',' || flags || ',' LIKE '%,noexec,%'
);

========================================
name: CIS Ubuntu 22.04 - 1.1.2.6.1 Ensure separate partition exists for /var/log (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 1.1.2.6.2 Ensure nodev option set on /var/log partition (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM mounts
  WHERE path='/var/log'
    AND ',' || flags || ',' LIKE '%,nodev,%'
);

========================================
name: CIS Ubuntu 22.04 - 1.1.2.6.3 Ensure nosuid option set on /var/log partition (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM mounts
  WHERE path='/var/log'
    AND ',' || flags || ',' LIKE '%,nosuid,%'
);

========================================
name: CIS Ubuntu 22.04 - 1.1.2.6.4 Ensure noexec option set on /var/log partition (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM mounts
  WHERE path='/var/log'
    AND ',' || flags || ',' LIKE '%,noexec,%'
);

========================================
name: CIS Ubuntu 22.04 - 1.1.2.7.1 Ensure separate partition exists for /var/log/audit (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM mounts WHERE path='/var/log/audit');

========================================
name: CIS Ubuntu 22.04 - 1.1.2.7.2 Ensure nodev option set on /var/log/audit partition (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM mounts
  WHERE path='/var/log/audit'
    AND ',' || flags || ',' LIKE '%,nodev,%'
);

========================================
name: CIS Ubuntu 22.04 - 1.1.2.7.3 Ensure nosuid option set on /var/log/audit partition (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM mounts
  WHERE path='/var/log/audit'
    AND ',' || flags || ',' LIKE '%,nosuid,%'
);

========================================
name: CIS Ubuntu 22.04 - 1.1.2.7.4 Ensure noexec option set on /var/log/audit partition (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM mounts
  WHERE path='/var/log/audit'
    AND ',' || flags || ',' LIKE '%,noexec,%'
);

========================================
name: CIS Ubuntu 22.04 - 1.2.1.1 Ensure GPG keys are configured (Manual)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 1.2.1.2 Ensure package manager repositories are configured (Manual)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 1.2.2.1 Ensure updates, patches, and additional security software are installed (Manual)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 1.3.1.1 Ensure the apparmor packages are installed (Automated)

---- run to pass ----
sudo apt-get update -y && sudo apt-get install -y apparmor apparmor-utils

---- run to fail ----
sudo apt-get update -y && sudo apt-get purge -y apparmor apparmor-utils || true

---- osquery ----
SELECT 1
WHERE EXISTS (SELECT 1 FROM deb_packages WHERE name='apparmor')
  AND EXISTS (SELECT 1 FROM deb_packages WHERE name='apparmor-utils');

========================================
name: CIS Ubuntu 22.04 - 1.3.1.2 Ensure AppArmor is enabled (Automated) ................................

---- run to pass ----
sudo systemctl enable --now apparmor.service

---- run to fail ----
sudo systemctl disable --now apparmor.service

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/sys/module/apparmor/parameters/enabled' AND line='Y'
)
AND EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name='apparmor.service' AND active_state='active'
);

========================================
name: CIS Ubuntu 22.04 - 1.3.1.3 Ensure all AppArmor Profiles are not disabled (Automated)

---- run to pass ----
sudo rm -f /etc/apparmor.d/disable/* || true

---- run to fail ----
sudo mkdir -p /etc/apparmor.d/disable && sudo ln -sf /etc/apparmor.d/usr.bin.man /etc/apparmor.d/disable/usr.bin.man

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM glob
  WHERE pattern='/etc/apparmor.d/disable/*'
);

========================================
name: CIS Ubuntu 22.04 - 1.3.1.4 Ensure all AppArmor Profiles are enforcing (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 1.4.2 Ensure access to bootloader config is configured (Automated)

---- run to pass ----
sudo chown root:root /boot/grub/grub.cfg && sudo chmod 0600 /boot/grub/grub.cfg

---- run to fail ----
sudo chmod 0777 /boot/grub/grub.cfg

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file
  WHERE path = '/boot/grub/grub.cfg' AND uid = 0 AND gid = 0
    AND mode = '0600'
);

========================================
name: CIS Ubuntu 22.04 - 1.5.1 Ensure randomize_va_space is configured (Automated)

---- run to pass ----
sudo sysctl -w kernel.randomize_va_space=2

---- run to fail ----
sudo sysctl -w kernel.randomize_va_space=0

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='kernel.randomize_va_space' AND value='2');

========================================
name: CIS Ubuntu 22.04 - 1.5.2 Ensure ptrace_scope is configured (Automated)

---- run to pass ----
sudo sysctl -w kernel.yama.ptrace_scope=1

---- run to fail ----
sudo sysctl -w kernel.yama.ptrace_scope=0

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='kernel.yama.ptrace_scope' AND CAST(value AS INTEGER) >= 1);

========================================
name: CIS Ubuntu 22.04 - 1.5.3 Ensure suid_dumpable is configured (Automated)

---- run to pass ----
sudo sysctl -w kernel.kptr_restrict=1

---- run to fail ----
sudo sysctl -w kernel.kptr_restrict=0

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='kernel.kptr_restrict' AND CAST(value AS INTEGER) >= 1);

========================================
name: CIS Ubuntu 22.04 - 1.5.4 Ensure core file size is configured (Automated)

---- run to pass ----
sudo sysctl -w kernel.dmesg_restrict=1

---- run to fail ----
sudo sysctl -w kernel.dmesg_restrict=0

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='kernel.dmesg_restrict' AND value='1');

========================================
name: CIS Ubuntu 22.04 - 1.5.5 Ensure prelink is not installed (Automated) ................................

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE NOT EXISTS (SELECT 1 FROM deb_packages WHERE name='prelink');

========================================
name: CIS Ubuntu 22.04 - 1.5.6 Ensure Automatic Error Reporting is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 1.6.1 Ensure /etc/motd is configured (Automated) ................................

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 1.6.2 Ensure /etc/issue is configured (Automated) ................................

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 1.6.3 Ensure /etc/issue.net is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 1.6.4 Ensure access to /etc/motd is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 1.6.5 Ensure access to /etc/issue is configured (Automated)

---- run to pass ----
sudo chown root:root /etc/issue && sudo chmod 0644 /etc/issue

---- run to fail ----
sudo chmod 0777 /etc/issue

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file
  WHERE path='/etc/issue' AND uid=0 AND gid=0 AND type='regular'
    AND mode IN ('0644','0640')
);

========================================
name: CIS Ubuntu 22.04 - 1.6.6 Ensure access to /etc/issue.net is configured (Automated)

---- run to pass ----
sudo chown root:root /etc/issue.net && sudo chmod 0644 /etc/issue.net

---- run to fail ----
sudo chmod 0777 /etc/issue.net

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file
  WHERE path='/etc/issue.net' AND uid=0 AND gid=0 AND type='regular'
    AND mode IN ('0644','0640')
);

========================================
name: CIS Ubuntu 22.04 - 1.7.1 Ensure GDM is removed (Automated) ................................

---- run to pass ----
sudo apt-get update -y && sudo apt-get purge -y gdm3 || true

---- run to fail ----
sudo apt-get update -y && sudo apt-get install -y gdm3

---- osquery ----
SELECT 1
WHERE NOT EXISTS (SELECT 1 FROM deb_packages WHERE name='gdm3');

========================================
name: CIS Ubuntu 22.04 - 1.7.2 Ensure GDM login banner is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 1.7.3 Ensure GDM disable -user-list option is enabled (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 1.7.4 Ensure GDM screen locks when the user is idle (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 1.7.5 Ensure GDM screen locks cannot be overridden (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 1.7.6 Ensure GDM automatic mounting of removable media is disabled (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 1.7.7 Ensure GDM disabling automatic mounting of removable media is not overridden

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 1.7.8 Ensure GDM autorun -never is enabled (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 1.7.9 Ensure GDM autorun -never is not overridden (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 1.7.10 Ensure XDMCP is not enabled (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 1.7.11 Ensure Xwayland is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 2.1.1 Ensure autofs services are not in use (Automated)

---- run to pass ----
sudo systemctl disable --now autofs.service 2>/dev/null || true

---- run to fail ----
sudo systemctl enable --now autofs.service 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name IN ('autofs.service')
    AND active_state = 'active'
);

========================================
name: CIS Ubuntu 22.04 - 2.1.2 Ensure avahi daemon services are not in use (Automated)

---- run to pass ----
sudo systemctl disable --now avahi-daemon.service 2>/dev/null || true

---- run to fail ----
sudo systemctl enable --now avahi-daemon.service 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name IN ('avahi-daemon.service')
    AND active_state = 'active'
);

========================================
name: CIS Ubuntu 22.04 - 2.1.3 Ensure dhcp server services are not in use (Automated)

---- run to pass ----
sudo systemctl disable --now isc-dhcp-server.service 2>/dev/null || true

---- run to fail ----
sudo systemctl enable --now isc-dhcp-server.service 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name IN ('isc-dhcp-server.service','dhcpd.service')
    AND active_state = 'active'
);

========================================
name: CIS Ubuntu 22.04 - 2.1.4 Ensure dns server services are not in use (Automated)

---- run to pass ----
sudo systemctl disable --now bind9.service 2>/dev/null || true

---- run to fail ----
sudo systemctl enable --now bind9.service 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name IN ('bind9.service','named.service')
    AND active_state = 'active'
);

========================================
name: CIS Ubuntu 22.04 - 2.1.5 Ensure dnsmasq services are not in use (Automated)

---- run to pass ----
sudo systemctl disable --now dnsmasq.service 2>/dev/null || true

---- run to fail ----
sudo systemctl enable --now dnsmasq.service 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name IN ('dnsmasq.service')
    AND active_state = 'active'
);

========================================
name: CIS Ubuntu 22.04 - 2.1.6 Ensure ftp server services are not in use (Automated)

---- run to pass ----
sudo systemctl disable --now vsftpd.service 2>/dev/null || true

---- run to fail ----
sudo systemctl enable --now vsftpd.service 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name IN ('vsftpd.service','proftpd.service')
    AND active_state = 'active'
);

========================================
name: CIS Ubuntu 22.04 - 2.1.7 Ensure ldap server services are not in use (Automated)

---- run to pass ----
sudo systemctl disable --now slapd.service 2>/dev/null || true

---- run to fail ----
sudo systemctl enable --now slapd.service 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name IN ('slapd.service')
    AND active_state = 'active'
);

========================================
name: CIS Ubuntu 22.04 - 2.1.8 Ensure message access server services are not in use (Automated)

---- run to pass ----
sudo systemctl disable --now dovecot.service 2>/dev/null || true

---- run to fail ----
sudo systemctl enable --now dovecot.service 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name IN ('dovecot.service','courier-imap.service','cyrus-imapd.service')
    AND active_state = 'active'
);

========================================
name: CIS Ubuntu 22.04 - 2.1.9 Ensure network file system services are not in use (Automated)

---- run to pass ----
sudo systemctl disable --now nfs-server.service 2>/dev/null || true

---- run to fail ----
sudo systemctl enable --now nfs-server.service 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name IN ('nfs-server.service','nfs-kernel-server.service')
    AND active_state = 'active'
);

========================================
name: CIS Ubuntu 22.04 - 2.1.10 Ensure nis server services are not in use (Automated)

---- run to pass ----
sudo systemctl disable --now nis.service 2>/dev/null || true

---- run to fail ----
sudo systemctl enable --now nis.service 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name IN ('nis.service','ypserv.service')
    AND active_state = 'active'
);

========================================
name: CIS Ubuntu 22.04 - 2.1.11 Ensure print server services are not in use (Automated)

---- run to pass ----
sudo systemctl disable --now cups.service 2>/dev/null || true

---- run to fail ----
sudo systemctl enable --now cups.service 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name IN ('cups.service')
    AND active_state = 'active'
);

========================================
name: CIS Ubuntu 22.04 - 2.1.12 Ensure rpcbind services are not in use (Automated)

---- run to pass ----
sudo systemctl disable --now rpcbind.service 2>/dev/null || true

---- run to fail ----
sudo systemctl enable --now rpcbind.service 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name IN ('rpcbind.service')
    AND active_state = 'active'
);

========================================
name: CIS Ubuntu 22.04 - 2.1.13 Ensure rsync services are not in use (Automated)

---- run to pass ----
sudo systemctl disable --now rsync.service 2>/dev/null || true

---- run to fail ----
sudo systemctl enable --now rsync.service 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name IN ('rsync.service')
    AND active_state = 'active'
);

========================================
name: CIS Ubuntu 22.04 - 2.1.14 Ensure samba file server services are not in use (Automated)

---- run to pass ----
sudo systemctl disable --now smbd.service 2>/dev/null || true

---- run to fail ----
sudo systemctl enable --now smbd.service 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name IN ('smbd.service','nmbd.service')
    AND active_state = 'active'
);

========================================
name: CIS Ubuntu 22.04 - 2.1.15 Ensure snmp services are not in use (Automated)

---- run to pass ----
sudo systemctl disable --now snmpd.service 2>/dev/null || true

---- run to fail ----
sudo systemctl enable --now snmpd.service 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name IN ('snmpd.service')
    AND active_state = 'active'
);

========================================
name: CIS Ubuntu 22.04 - 2.1.16 Ensure tftp server services are not in use (Automated)

---- run to pass ----
sudo systemctl disable --now tftpd.service 2>/dev/null || true

---- run to fail ----
sudo systemctl enable --now tftpd.service 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name IN ('tftpd.service','tftpd-hpa.service')
    AND active_state = 'active'
);

========================================
name: CIS Ubuntu 22.04 - 2.1.17 Ensure web proxy server services are not in use (Automated)

---- run to pass ----
sudo systemctl disable --now squid.service 2>/dev/null || true

---- run to fail ----
sudo systemctl enable --now squid.service 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name IN ('squid.service')
    AND active_state = 'active'
);

========================================
name: CIS Ubuntu 22.04 - 2.1.18 Ensure web server services are not in use (Automated)

---- run to pass ----
sudo systemctl disable --now apache2.service 2>/dev/null || true

---- run to fail ----
sudo systemctl enable --now apache2.service 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name IN ('apache2.service','nginx.service')
    AND active_state = 'active'
);

========================================
name: CIS Ubuntu 22.04 - 2.1.19 Ensure xinetd services are not in use (Automated)

---- run to pass ----
sudo systemctl disable --now xinetd.service 2>/dev/null || true

---- run to fail ----
sudo systemctl enable --now xinetd.service 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name IN ('xinetd.service')
    AND active_state = 'active'
);

========================================
name: CIS Ubuntu 22.04 - 2.1.20 Ensure X window server services are not in use (Automated)

---- run to pass ----
sudo systemctl disable --now display-manager.service 2>/dev/null || true

---- run to fail ----
sudo systemctl enable --now display-manager.service 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name IN ('display-manager.service','gdm.service','gdm3.service','lightdm.service')
    AND active_state = 'active'
);

========================================
name: CIS Ubuntu 22.04 - 2.1.21 Ensure mail transfer agents are configured for local -only mode (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 2.1.22 Ensure only approved services are listening on a network interface (Manual)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 2.2.1 Ensure nis client is not installed (Automated)

---- run to pass ----
sudo apt-get purge -y nis

---- run to fail ----
sudo apt-get update && sudo apt-get install -y nis

---- osquery ----
SELECT 1 WHERE NOT EXISTS (SELECT 1 FROM deb_packages WHERE name = 'nis');

========================================
name: CIS Ubuntu 22.04 - 2.2.3 Ensure talk client is not installed (Automated)

---- run to pass ----
sudo apt-get purge -y talk

---- run to fail ----
sudo apt-get update && sudo apt-get install -y talk

---- osquery ----
SELECT 1 WHERE NOT EXISTS (SELECT 1 FROM deb_packages WHERE name = 'talk');

========================================
name: CIS Ubuntu 22.04 - 2.2.4 Ensure telnet client is not installed (Automated)

---- run to pass ----
sudo apt-get purge -y telnet

---- run to fail ----
sudo apt-get update && sudo apt-get install -y telnet

---- osquery ----
SELECT 1 WHERE NOT EXISTS (SELECT 1 FROM deb_packages WHERE name = 'telnet');

========================================
name: CIS Ubuntu 22.04 - 2.2.5 Ensure ldap client is not installed (Automated)

---- run to pass ----
sudo apt-get purge -y ldap-utils

---- run to fail ----
sudo apt-get update && sudo apt-get install -y ldap-utils

---- osquery ----
SELECT 1 WHERE NOT EXISTS (SELECT 1 FROM deb_packages WHERE name = 'ldap-utils');

========================================
name: CIS Ubuntu 22.04 - 2.2.6 Ensure ftp client is not installed (Automated)

---- run to pass ----
sudo apt-get purge -y ftp

---- run to fail ----
sudo apt-get update && sudo apt-get install -y ftp

---- osquery ----
SELECT 1 WHERE NOT EXISTS (SELECT 1 FROM deb_packages WHERE name = 'ftp');

========================================
name: CIS Ubuntu 22.04 - 2.3.1 Ensure time synchronization is in use ................................

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name='chrony.service' AND active_state='active'
)
OR EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name='systemd-timesyncd.service' AND active_state='active'
);

========================================
name: CIS Ubuntu 22.04 - 2.3.1.1 Ensure a single time synchronization daemon is in use (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 2.3.2.1 Ensure systemd -timesyncd configured with authorized timeserver (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 2.3.2.2 Ensure systemd -timesyncd is enabled and running (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 2.3.3.1 Ensure chrony is configured with authorized timeserver (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/etc/chrony/chrony.conf'
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'server %' OR contents LIKE 'pool %')
);

========================================
name: CIS Ubuntu 22.04 - 2.3.3.2 Ensure chrony is running as user _chrony (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 2.3.3.3 Ensure chrony is enabled and running (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 2.4.1.1 Ensure cron daemon is enabled and active (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE NOT EXISTS (SELECT 1 FROM deb_packages WHERE name='cron')
   OR (
     EXISTS (
       SELECT 1 FROM systemd_units
       WHERE (name='cron.service' OR name='crond.service')
         AND enabled_state='enabled'
     )
     AND EXISTS (
       SELECT 1 FROM systemd_units
       WHERE (name='cron.service' OR name='crond.service')
         AND active_state='active'
     )
   );

========================================
name: CIS Ubuntu 22.04 - 2.4.1.2 Ensure access to /etc/crontab is configured (Automated)

---- run to pass ----
sudo chown root:root /etc/crontab && sudo chmod 0600 /etc/crontab

---- run to fail ----
sudo chmod 0777 /etc/crontab

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file
  WHERE path = '/etc/crontab' AND uid = 0 AND gid = 0
    AND mode = '0600'
);

========================================
name: CIS Ubuntu 22.04 - 2.4.1.3 Ensure access to /etc/cron.hourly is configured (Automated)

---- run to pass ----
sudo chown root:root /etc/cron.hourly && sudo chmod 0700 /etc/cron.hourly

---- run to fail ----
sudo chmod 0777 /etc/cron.hourly

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file
  WHERE path = '/etc/cron.hourly' AND uid = 0 AND gid = 0 AND type = 'directory'
    AND mode = '0700'
);

========================================
name: CIS Ubuntu 22.04 - 2.4.1.4 Ensure access to /etc/cron.daily is configured (Automated)

---- run to pass ----
sudo chown root:root /etc/cron.daily && sudo chmod 0700 /etc/cron.daily

---- run to fail ----
sudo chmod 0777 /etc/cron.daily

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file
  WHERE path = '/etc/cron.daily' AND uid = 0 AND gid = 0 AND type = 'directory'
    AND mode = '0700'
);

========================================
name: CIS Ubuntu 22.04 - 2.4.1.5 Ensure access to /etc/cron.weekly is configured (Automated)

---- run to pass ----
sudo chown root:root /etc/cron.weekly && sudo chmod 0700 /etc/cron.weekly

---- run to fail ----
sudo chmod 0777 /etc/cron.weekly

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file
  WHERE path = '/etc/cron.weekly' AND uid = 0 AND gid = 0 AND type = 'directory'
    AND mode = '0700'
);

========================================
name: CIS Ubuntu 22.04 - 2.4.1.6 Ensure access to /etc/cron.monthly is configured (Automated)

---- run to pass ----
sudo chown root:root /etc/cron.monthly && sudo chmod 0700 /etc/cron.monthly

---- run to fail ----
sudo chmod 0777 /etc/cron.monthly

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file
  WHERE path = '/etc/cron.monthly' AND uid = 0 AND gid = 0 AND type = 'directory'
    AND mode = '0700'
);

========================================
name: CIS Ubuntu 22.04 - 2.4.1.7 Ensure access to /etc/cron.yearly is configured (Automated)

---- run to pass ----
sudo chown root:root /etc/cron.yearly && sudo chmod 0700 /etc/cron.yearly

---- run to fail ----
sudo chmod 0777 /etc/cron.yearly

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file
  WHERE path = '/etc/cron.yearly' AND uid = 0 AND gid = 0 AND type = 'directory'
    AND mode = '0700'
);

========================================
name: CIS Ubuntu 22.04 - 2.4.1.8 Ensure access to /etc/cron.d is configured (Automated)

---- run to pass ----
sudo chown root:root /etc/cron.d && sudo chmod 0700 /etc/cron.d

---- run to fail ----
sudo chmod 0777 /etc/cron.d

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file
  WHERE path = '/etc/cron.d' AND uid = 0 AND gid = 0 AND type = 'directory'
    AND mode = '0700'
);

========================================
name: CIS Ubuntu 22.04 - 2.4.1.9 Ensure access to crontab is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE NOT EXISTS (SELECT 1 FROM deb_packages WHERE name='cron')
   OR (
     (SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file
  WHERE path='/etc/cron.allow'
    AND uid=0
    AND mode IN ('0640','0600','0400')
    AND (gid=0 OR gid = (SELECT gid FROM groups WHERE groupname='crontab' LIMIT 1))
);)
     AND
     (SELECT 1
WHERE NOT EXISTS (SELECT 1 FROM file WHERE path='/etc/cron.deny')
   OR EXISTS (
     SELECT 1 FROM file
     WHERE path='/etc/cron.deny'
       AND uid=0
       AND mode IN ('0640','0600','0400')
       AND (gid=0 OR gid = (SELECT gid FROM groups WHERE groupname='crontab' LIMIT 1))
   );)
   );

========================================
name: CIS Ubuntu 22.04 - 2.4.2.1 Ensure access to at is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE NOT EXISTS (SELECT 1 FROM deb_packages WHERE name='at')
   OR (
     (SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file
  WHERE path='/etc/at.allow'
    AND uid=0
    AND mode IN ('0640','0600','0400')
    AND (gid=0 OR gid = (SELECT gid FROM groups WHERE groupname='daemon' LIMIT 1))
);)
     AND
     (SELECT 1
WHERE NOT EXISTS (SELECT 1 FROM file WHERE path='/etc/at.deny')
   OR EXISTS (
     SELECT 1 FROM file
     WHERE path='/etc/at.deny'
       AND uid=0
       AND mode IN ('0640','0600','0400')
       AND (gid=0 OR gid = (SELECT gid FROM groups WHERE groupname='daemon' LIMIT 1))
   );)
   );

========================================
name: CIS Ubuntu 22.04 - 3.1.1 Ensure IPv6 status is identified (Manual) ................................

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 3.1.2 Ensure wireless interfaces are not available (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/proc/net/wireless'
    AND contents LIKE '%:%'
);

========================================
name: CIS Ubuntu 22.04 - 3.1.3 Ensure bluetooth services are not in use (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE NOT EXISTS (SELECT 1 FROM deb_packages WHERE name='bluez')
   OR (
     NOT EXISTS (
       SELECT 1 FROM systemd_units
       WHERE name='bluetooth.service' AND enabled_state='enabled'
     )
     AND NOT EXISTS (
       SELECT 1 FROM systemd_units
       WHERE name='bluetooth.service' AND active_state='active'
     )
   );

========================================
name: CIS Ubuntu 22.04 - 3.2.1 Ensure dccp kernel module is not available (Automated)

---- run to pass ----
sudo bash -c "printf '%s\n' 'blacklist dccp' 'install dccp /bin/false' > /etc/modprobe.d/dccp.conf"
sudo modprobe -r dccp 2>/dev/null || true

---- run to fail ----
sudo rm -f /etc/modprobe.d/dccp.conf
sudo modprobe dccp 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE (SELECT COUNT(*) FROM kernel_modules WHERE name='dccp') = 0
  AND (SELECT COUNT(*) FROM file_contents
       WHERE path LIKE '/etc/modprobe.d/%.conf'
         AND contents LIKE '%blacklist dccp%'
         AND contents NOT LIKE '%#%') >= 1
  AND (SELECT COUNT(*) FROM file_contents
       WHERE path LIKE '/etc/modprobe.d/%.conf'
         AND (contents LIKE '%install dccp /bin/false%' OR contents LIKE '%install dccp /bin/true%')
         AND contents NOT LIKE '%#%') >= 1;

========================================
name: CIS Ubuntu 22.04 - 3.2.2 Ensure tipc kernel module is not available (Automated)

---- run to pass ----
sudo bash -c "printf '%s\n' 'blacklist tipc' 'install tipc /bin/false' > /etc/modprobe.d/tipc.conf"
sudo modprobe -r tipc 2>/dev/null || true

---- run to fail ----
sudo rm -f /etc/modprobe.d/tipc.conf
sudo modprobe tipc 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE (SELECT COUNT(*) FROM kernel_modules WHERE name='tipc') = 0
  AND (SELECT COUNT(*) FROM file_contents
       WHERE path LIKE '/etc/modprobe.d/%.conf'
         AND contents LIKE '%blacklist tipc%'
         AND contents NOT LIKE '%#%') >= 1
  AND (SELECT COUNT(*) FROM file_contents
       WHERE path LIKE '/etc/modprobe.d/%.conf'
         AND (contents LIKE '%install tipc /bin/false%' OR contents LIKE '%install tipc /bin/true%')
         AND contents NOT LIKE '%#%') >= 1;

========================================
name: CIS Ubuntu 22.04 - 3.2.3 Ensure rds kernel module is not available (Automated)

---- run to pass ----
sudo bash -c "printf '%s\n' 'blacklist rds' 'install rds /bin/false' > /etc/modprobe.d/rds.conf"
sudo modprobe -r rds 2>/dev/null || true

---- run to fail ----
sudo rm -f /etc/modprobe.d/rds.conf
sudo modprobe rds 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE (SELECT COUNT(*) FROM kernel_modules WHERE name='rds') = 0
  AND (SELECT COUNT(*) FROM file_contents
       WHERE path LIKE '/etc/modprobe.d/%.conf'
         AND contents LIKE '%blacklist rds%'
         AND contents NOT LIKE '%#%') >= 1
  AND (SELECT COUNT(*) FROM file_contents
       WHERE path LIKE '/etc/modprobe.d/%.conf'
         AND (contents LIKE '%install rds /bin/false%' OR contents LIKE '%install rds /bin/true%')
         AND contents NOT LIKE '%#%') >= 1;

========================================
name: CIS Ubuntu 22.04 - 3.2.4 Ensure sctp kernel module is not available (Automated)

---- run to pass ----
sudo bash -c "printf '%s\n' 'blacklist sctp' 'install sctp /bin/false' > /etc/modprobe.d/sctp.conf"
sudo modprobe -r sctp 2>/dev/null || true

---- run to fail ----
sudo rm -f /etc/modprobe.d/sctp.conf
sudo modprobe sctp 2>/dev/null || true

---- osquery ----
SELECT 1
WHERE (SELECT COUNT(*) FROM kernel_modules WHERE name='sctp') = 0
  AND (SELECT COUNT(*) FROM file_contents
       WHERE path LIKE '/etc/modprobe.d/%.conf'
         AND contents LIKE '%blacklist sctp%'
         AND contents NOT LIKE '%#%') >= 1
  AND (SELECT COUNT(*) FROM file_contents
       WHERE path LIKE '/etc/modprobe.d/%.conf'
         AND (contents LIKE '%install sctp /bin/false%' OR contents LIKE '%install sctp /bin/true%')
         AND contents NOT LIKE '%#%') >= 1;

========================================
name: CIS Ubuntu 22.04 - 3.3.1.1 Ensure net.ipv4.ip_forward is configured (Automated)

---- run to pass ----
sudo sysctl -w net.ipv4.ip_forward=0

---- run to fail ----
sudo sysctl -w net.ipv4.ip_forward=1

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='net.ipv4.ip_forward' AND value='0');

========================================
name: CIS Ubuntu 22.04 - 3.3.1.2 Ensure net.ipv4.conf.all.forwarding is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (SELECT 1 FROM system_controls WHERE name='net.ipv4.conf.all.forwarding' AND value='0')
  AND EXISTS (
    SELECT 1 FROM file_contents
    WHERE (path='/etc/sysctl.conf'
       OR path LIKE '/etc/sysctl.d/%.conf'
       OR path LIKE '/usr/lib/sysctl.d/%.conf'
       OR path LIKE '/lib/sysctl.d/%.conf'
       OR path LIKE '/run/sysctl.d/%.conf')
      AND contents NOT LIKE '%#%'
      AND (contents LIKE 'net.ipv4.conf.all.forwarding = 0'
        OR contents LIKE 'net.ipv4.conf.all.forwarding=0'
        OR contents LIKE 'net.ipv4.conf.all.forwarding = 0 %'
        OR contents LIKE 'net.ipv4.conf.all.forwarding=0 %')
  );

========================================
name: CIS Ubuntu 22.04 - 3.3.1.3 Ensure net.ipv4.conf.default.forwarding is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (SELECT 1 FROM system_controls WHERE name='net.ipv4.conf.default.forwarding' AND value='0')
  AND EXISTS (
    SELECT 1 FROM file_contents
    WHERE (path='/etc/sysctl.conf'
       OR path LIKE '/etc/sysctl.d/%.conf'
       OR path LIKE '/usr/lib/sysctl.d/%.conf'
       OR path LIKE '/lib/sysctl.d/%.conf'
       OR path LIKE '/run/sysctl.d/%.conf')
      AND contents NOT LIKE '%#%'
      AND (contents LIKE 'net.ipv4.conf.default.forwarding = 0'
        OR contents LIKE 'net.ipv4.conf.default.forwarding=0'
        OR contents LIKE 'net.ipv4.conf.default.forwarding = 0 %'
        OR contents LIKE 'net.ipv4.conf.default.forwarding=0 %')
  );

========================================
name: CIS Ubuntu 22.04 - 3.3.1.4 Ensure net.ipv4.conf.all.send_redirects is configured (Automated)

---- run to pass ----
sudo sysctl -w net.ipv4.conf.all.send_redirects=0

---- run to fail ----
sudo sysctl -w net.ipv4.conf.all.send_redirects=1

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='net.ipv4.conf.all.send_redirects' AND value='0');

========================================
name: CIS Ubuntu 22.04 - 3.3.1.5 Ensure net.ipv4.conf.default.send_redirects is configured (Automated)

---- run to pass ----
sudo sysctl -w net.ipv4.conf.default.send_redirects=0

---- run to fail ----
sudo sysctl -w net.ipv4.conf.default.send_redirects=1

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='net.ipv4.conf.default.send_redirects' AND value='0');

========================================
name: CIS Ubuntu 22.04 - 3.3.1.6 Ensure net.ipv4.icmp_ignore_bogus_error_responses is configured (Automated)

---- run to pass ----
sudo sysctl -w net.ipv4.icmp_ignore_bogus_error_responses=1

---- run to fail ----
sudo sysctl -w net.ipv4.icmp_ignore_bogus_error_responses=0

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='net.ipv4.icmp_ignore_bogus_error_responses' AND value='1');

========================================
name: CIS Ubuntu 22.04 - 3.3.1.7 Ensure net.ipv4.icmp_echo_ignore_broadcasts is configured (Automated)

---- run to pass ----
sudo sysctl -w net.ipv4.icmp_echo_ignore_broadcasts=1

---- run to fail ----
sudo sysctl -w net.ipv4.icmp_echo_ignore_broadcasts=0

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='net.ipv4.icmp_echo_ignore_broadcasts' AND value='1');

========================================
name: CIS Ubuntu 22.04 - 3.3.1.8 Ensure net.ipv4.conf.all.accept_redirects is configured (Automated)

---- run to pass ----
sudo sysctl -w net.ipv4.conf.all.accept_redirects=0

---- run to fail ----
sudo sysctl -w net.ipv4.conf.all.accept_redirects=1

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='net.ipv4.conf.all.accept_redirects' AND value='0');

========================================
name: CIS Ubuntu 22.04 - 3.3.1.9 Ensure net.ipv4.conf.default.accept_redirects is configured (Automated)

---- run to pass ----
sudo sysctl -w net.ipv4.conf.default.accept_redirects=0

---- run to fail ----
sudo sysctl -w net.ipv4.conf.default.accept_redirects=1

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='net.ipv4.conf.default.accept_redirects' AND value='0');

========================================
name: CIS Ubuntu 22.04 - 3.3.1.10 Ensure net.ipv4.conf.all.secure_redirects is configured (Automated)

---- run to pass ----
sudo sysctl -w net.ipv4.conf.all.secure_redirects=0

---- run to fail ----
sudo sysctl -w net.ipv4.conf.all.secure_redirects=1

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='net.ipv4.conf.all.secure_redirects' AND value='0');

========================================
name: CIS Ubuntu 22.04 - 3.3.1.11 Ensure net.ipv4.conf.default.secure_redirects is configured (Automated)

---- run to pass ----
sudo sysctl -w net.ipv4.conf.default.secure_redirects=0

---- run to fail ----
sudo sysctl -w net.ipv4.conf.default.secure_redirects=1

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='net.ipv4.conf.default.secure_redirects' AND value='0');

========================================
name: CIS Ubuntu 22.04 - 3.3.1.12 Ensure net.ipv4.conf.all.rp_filter is configured (Automated)

---- run to pass ----
sudo sysctl -w net.ipv4.conf.all.rp_filter=1

---- run to fail ----
sudo sysctl -w net.ipv4.conf.all.rp_filter=0

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='net.ipv4.conf.all.rp_filter' AND value='1');

========================================
name: CIS Ubuntu 22.04 - 3.3.1.13 Ensure net.ipv4.conf.default.rp_filter is configured (Automated)

---- run to pass ----
sudo sysctl -w net.ipv4.conf.default.rp_filter=1

---- run to fail ----
sudo sysctl -w net.ipv4.conf.default.rp_filter=0

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='net.ipv4.conf.default.rp_filter' AND value='1');

========================================
name: CIS Ubuntu 22.04 - 3.3.1.14 Ensure net.ipv4.conf.all.accept_source_route is configured (Automated)

---- run to pass ----
sudo sysctl -w net.ipv4.conf.all.accept_source_route=0

---- run to fail ----
sudo sysctl -w net.ipv4.conf.all.accept_source_route=1

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='net.ipv4.conf.all.accept_source_route' AND value='0');

========================================
name: CIS Ubuntu 22.04 - 3.3.1.15 Ensure net.ipv4.conf.default.accept_source_route is configured (Automated)

---- run to pass ----
sudo sysctl -w net.ipv4.conf.default.accept_source_route=0

---- run to fail ----
sudo sysctl -w net.ipv4.conf.default.accept_source_route=1

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='net.ipv4.conf.default.accept_source_route' AND value='0');

========================================
name: CIS Ubuntu 22.04 - 3.3.1.17 Ensure net.ipv4.conf.default.log_martians is configured (Automated)

---- run to pass ----
sudo sysctl -w net.ipv4.conf.default.log_martians=1

---- run to fail ----
sudo sysctl -w net.ipv4.conf.default.log_martians=0

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='net.ipv4.conf.default.log_martians' AND value='1');

========================================
name: CIS Ubuntu 22.04 - 3.3.1.18 Ensure net.ipv4.tcp_syncookies is configured (Automated)

---- run to pass ----
sudo sysctl -w net.ipv4.tcp_syncookies=1

---- run to fail ----
sudo sysctl -w net.ipv4.tcp_syncookies=0

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='net.ipv4.tcp_syncookies' AND value='1');

========================================
name: CIS Ubuntu 22.04 - 3.3.2.1 Ensure net.ipv6.conf.all.forwarding is configured (Automated)

---- run to pass ----
sudo sysctl -w net.ipv6.conf.all.forwarding=0

---- run to fail ----
sudo sysctl -w net.ipv6.conf.all.forwarding=1

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='net.ipv6.conf.all.forwarding' AND value='0');

========================================
name: CIS Ubuntu 22.04 - 3.3.2.2 Ensure net.ipv6.conf.default.forwarding is configured (Automated)

---- run to pass ----
sudo sysctl -w net.ipv6.conf.default.forwarding=0

---- run to fail ----
sudo sysctl -w net.ipv6.conf.default.forwarding=1

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='net.ipv6.conf.default.forwarding' AND value='0');

========================================
name: CIS Ubuntu 22.04 - 3.3.2.3 Ensure net.ipv6.conf.all.accept_redirects is configured (Automated)

---- run to pass ----
sudo sysctl -w net.ipv6.conf.all.accept_redirects=0

---- run to fail ----
sudo sysctl -w net.ipv6.conf.all.accept_redirects=1

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='net.ipv6.conf.all.accept_redirects' AND value='0');

========================================
name: CIS Ubuntu 22.04 - 3.3.2.4 Ensure net.ipv6.conf.default.accept_redirects is configured (Automated)

---- run to pass ----
sudo sysctl -w net.ipv6.conf.default.accept_redirects=0

---- run to fail ----
sudo sysctl -w net.ipv6.conf.default.accept_redirects=1

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='net.ipv6.conf.default.accept_redirects' AND value='0');

========================================
name: CIS Ubuntu 22.04 - 3.3.2.5 Ensure net.ipv6.conf.all.accept_source_route is configured (Automated)

---- run to pass ----
sudo sysctl -w net.ipv6.conf.all.accept_source_route=0

---- run to fail ----
sudo sysctl -w net.ipv6.conf.all.accept_source_route=1

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='net.ipv6.conf.all.accept_source_route' AND value='0');

========================================
name: CIS Ubuntu 22.04 - 3.3.2.6 Ensure net.ipv6.conf.default.accept_source_route is configured (Automated)

---- run to pass ----
sudo sysctl -w net.ipv6.conf.default.accept_source_route=0

---- run to fail ----
sudo sysctl -w net.ipv6.conf.default.accept_source_route=1

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='net.ipv6.conf.default.accept_source_route' AND value='0');

========================================
name: CIS Ubuntu 22.04 - 3.3.2.7 Ensure net.ipv6.conf.all.accept_ra is configured (Automated)

---- run to pass ----
sudo sysctl -w net.ipv6.conf.all.accept_ra=0

---- run to fail ----
sudo sysctl -w net.ipv6.conf.all.accept_ra=1

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='net.ipv6.conf.all.accept_ra' AND value='0');

========================================
name: CIS Ubuntu 22.04 - 3.3.2.8 Ensure net.ipv6.conf.default.accept_ra is configured (Automated)

---- run to pass ----
sudo sysctl -w net.ipv6.conf.default.accept_ra=0

---- run to fail ----
sudo sysctl -w net.ipv6.conf.default.accept_ra=1

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM sysctl WHERE name='net.ipv6.conf.default.accept_ra' AND value='0');

========================================
name: CIS Ubuntu 22.04 - 4.1.1 Ensure ufw is installed (Automated) ................................

---- run to pass ----
sudo apt-get update && sudo apt-get install -y ufw

---- run to fail ----
sudo apt-get purge -y ufw

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM deb_packages WHERE name = 'ufw');

========================================
name: CIS Ubuntu 22.04 - 4.1.2 Ensure ufw service is configured (Automated)

---- run to pass ----
sudo apt-get update && sudo apt-get install -y ufw
sudo ufw --force enable

---- run to fail ----
sudo ufw --force disable

---- osquery ----
SELECT 1
WHERE EXISTS (SELECT 1 FROM deb_packages WHERE name='ufw')
  AND EXISTS (
    SELECT 1 FROM file_contents
    WHERE path='/etc/ufw/ufw.conf'
      AND contents LIKE 'ENABLED=yes%'
      AND contents NOT LIKE '%#%'
  );

========================================
name: CIS Ubuntu 22.04 - 4.1.3 Ensure ufw incoming default is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 4.1.4 Ensure ufw outgoing default is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 4.1.5 Ensure ufw routed default is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.1.1 Ensure access to /etc/ssh/sshd_config is configured (Automated)

---- run to pass ----
sudo chown root:root /etc/ssh/sshd_config && sudo chmod 0600 /etc/ssh/sshd_config

---- run to fail ----
sudo chmod 0777 /etc/ssh/sshd_config

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file
  WHERE path = '/etc/ssh/sshd_config' AND uid = 0 AND gid = 0
    AND mode = '0600'
);

========================================
name: CIS Ubuntu 22.04 - 5.1.2 Ensure access to SSH private host key files is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.1.3 Ensure access to SSH public host key files is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.1.4 Ensure sshd access is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.1.5 Ensure sshd Banner is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.1.6 Ensure sshd Ciphers are configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.1.7 Ensure sshd ClientAliveInterval and ClientAliveCountMax are configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE (path = '/etc/ssh/sshd_config' OR path LIKE '/etc/ssh/sshd_config.d/%.conf')
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'ClientAliveInterval 300%' OR contents LIKE 'ClientAliveInterval	300%')
);

========================================
name: CIS Ubuntu 22.04 - 5.1.8 Ensure sshd DisableForwarding is enabled (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.1.9 Ensure sshd GSSAPIAuthentication is disabled (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.1.10 Ensure sshd HostbasedAuthentication is disabled (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE (path = '/etc/ssh/sshd_config' OR path LIKE '/etc/ssh/sshd_config.d/%.conf')
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'HostbasedAuthentication no%' OR contents LIKE 'HostbasedAuthentication	no%')
)
AND NOT EXISTS (
  SELECT 1 FROM file_contents
  WHERE (path = '/etc/ssh/sshd_config' OR path LIKE '/etc/ssh/sshd_config.d/%.conf')
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'HostbasedAuthentication yes%' OR contents LIKE 'HostbasedAuthentication	yes%')
);

========================================
name: CIS Ubuntu 22.04 - 5.1.11 Ensure sshd IgnoreRhosts is enabled (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE (path = '/etc/ssh/sshd_config' OR path LIKE '/etc/ssh/sshd_config.d/%.conf')
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'IgnoreRhosts yes%' OR contents LIKE 'IgnoreRhosts	yes%')
)
AND NOT EXISTS (
  SELECT 1 FROM file_contents
  WHERE (path = '/etc/ssh/sshd_config' OR path LIKE '/etc/ssh/sshd_config.d/%.conf')
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'IgnoreRhosts no%' OR contents LIKE 'IgnoreRhosts	no%')
);

========================================
name: CIS Ubuntu 22.04 - 5.1.12 Ensure sshd KexAlgorithms is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.1.13 Ensure sshd LoginGraceTime is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE (path = '/etc/ssh/sshd_config' OR path LIKE '/etc/ssh/sshd_config.d/%.conf')
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'LoginGraceTime 60%' OR contents LIKE 'LoginGraceTime	60%')
);

========================================
name: CIS Ubuntu 22.04 - 5.1.14 Ensure sshd LogLevel is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE (path = '/etc/ssh/sshd_config' OR path LIKE '/etc/ssh/sshd_config.d/%.conf')
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'LogLevel INFO%' OR contents LIKE 'LogLevel VERBOSE%' OR contents LIKE 'LogLevel	INFO%' OR contents LIKE 'LogLevel	VERBOSE%')
);

========================================
name: CIS Ubuntu 22.04 - 5.1.15 Ensure sshd MACs are configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.1.16 Ensure sshd MaxAuthTries is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE (path = '/etc/ssh/sshd_config' OR path LIKE '/etc/ssh/sshd_config.d/%.conf')
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'MaxAuthTries 4%' OR contents LIKE 'MaxAuthTries	4%')
);

========================================
name: CIS Ubuntu 22.04 - 5.1.17 Ensure sshd MaxSessions is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.1.18 Ensure sshd MaxStartups is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.1.19 Ensure sshd PermitEmptyPasswords is disabled (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE (path = '/etc/ssh/sshd_config' OR path LIKE '/etc/ssh/sshd_config.d/%.conf')
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'PermitEmptyPasswords no%' OR contents LIKE 'PermitEmptyPasswords	no%')
)
AND NOT EXISTS (
  SELECT 1 FROM file_contents
  WHERE (path = '/etc/ssh/sshd_config' OR path LIKE '/etc/ssh/sshd_config.d/%.conf')
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'PermitEmptyPasswords yes%' OR contents LIKE 'PermitEmptyPasswords	yes%')
);

========================================
name: CIS Ubuntu 22.04 - 5.1.20 Ensure sshd PermitRootLogin is disabled (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE (path = '/etc/ssh/sshd_config' OR path LIKE '/etc/ssh/sshd_config.d/%.conf')
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'PermitRootLogin no%' OR contents LIKE 'PermitRootLogin	no%')
)
AND NOT EXISTS (
  SELECT 1 FROM file_contents
  WHERE (path = '/etc/ssh/sshd_config' OR path LIKE '/etc/ssh/sshd_config.d/%.conf')
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'PermitRootLogin yes%' OR contents LIKE 'PermitRootLogin prohibit-password%' OR contents LIKE 'PermitRootLogin without-password%' OR contents LIKE 'PermitRootLogin	yes%' OR contents LIKE 'PermitRootLogin	prohibit-password%' OR contents LIKE 'PermitRootLogin	without-password%')
);

========================================
name: CIS Ubuntu 22.04 - 5.1.21 Ensure sshd PermitUserEnvironment is disabled (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE (path = '/etc/ssh/sshd_config' OR path LIKE '/etc/ssh/sshd_config.d/%.conf')
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'PermitUserEnvironment no%' OR contents LIKE 'PermitUserEnvironment	no%')
)
AND NOT EXISTS (
  SELECT 1 FROM file_contents
  WHERE (path = '/etc/ssh/sshd_config' OR path LIKE '/etc/ssh/sshd_config.d/%.conf')
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'PermitUserEnvironment yes%' OR contents LIKE 'PermitUserEnvironment	yes%')
);

========================================
name: CIS Ubuntu 22.04 - 5.1.22 Ensure sshd UsePAM is enabled (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE (path = '/etc/ssh/sshd_config' OR path LIKE '/etc/ssh/sshd_config.d/%.conf')
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'UsePAM yes%' OR contents LIKE 'UsePAM	yes%')
)
AND NOT EXISTS (
  SELECT 1 FROM file_contents
  WHERE (path = '/etc/ssh/sshd_config' OR path LIKE '/etc/ssh/sshd_config.d/%.conf')
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'UsePAM no%' OR contents LIKE 'UsePAM	no%')
);

========================================
name: CIS Ubuntu 22.04 - 5.2.1 Ensure sudo is installed (Automated) ................................

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM deb_packages WHERE name='sudo');

========================================
name: CIS Ubuntu 22.04 - 5.2.2 Ensure sudo commands use pty (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.2.3 Ensure sudo log file exists (Automated) ................................

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.2.4 Ensure users must provide password for escalation (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.2.5 Ensure re -authentication for privilege escalation is not disabled globally (Automated) 542

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.2.6 Ensure sudo timestamp_timeout is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.2.7 Ensure access to the su command is restricted (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.3.1.1 Ensure latest version of pam is installed (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM deb_packages WHERE name='latest-version-of-pam');

========================================
name: CIS Ubuntu 22.04 - 5.3.1.3 Ensure latest version of libpam -pwquality is installed (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM deb_packages WHERE name='latest-version-of-libpam--pwquality');

========================================
name: CIS Ubuntu 22.04 - 5.3.2.1 Ensure pam_unix module is enabled (Automated)

---- run to pass ----
sudo pam-auth-update --enable unix

---- run to fail ----
sudo sed -i.bak '/pam_unix\.so/d' /etc/pam.d/common-auth

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/etc/pam.d/common-auth' AND contents LIKE '%pam_unix.so%'
);

========================================
name: CIS Ubuntu 22.04 - 5.3.2.2 Ensure pam_faillock module is enabled (Automated)

---- run to pass ----
sudo pam-auth-update --enable faillock

---- run to fail ----
sudo sed -i.bak '/pam_faillock\.so/d' /etc/pam.d/common-auth

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/etc/pam.d/common-auth' AND contents LIKE '%pam_faillock.so%'
);

========================================
name: CIS Ubuntu 22.04 - 5.3.2.3 Ensure pam_pwquality module is enabled (Automated)

---- run to pass ----
sudo apt-get update -y && sudo apt-get install -y libpam-pwquality

---- run to fail ----
sudo sed -i.bak '/pam_pwquality\.so/d' /etc/pam.d/common-password

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/etc/pam.d/common-password' AND contents LIKE '%pam_pwquality.so%'
);

========================================
name: CIS Ubuntu 22.04 - 5.3.2.4 Ensure pam_pwhistory module is enabled (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.3.3.1.1 Ensure password failed attempts lockout is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/etc/security/faillock.conf'
    AND contents NOT LIKE '%#%'
    AND (
      contents LIKE 'deny=1%' OR contents LIKE 'deny = 1%'
      OR contents LIKE 'deny=2%' OR contents LIKE 'deny = 2%'
      OR contents LIKE 'deny=3%' OR contents LIKE 'deny = 3%'
      OR contents LIKE 'deny=4%' OR contents LIKE 'deny = 4%'
      OR contents LIKE 'deny=5%' OR contents LIKE 'deny = 5%'
    )
)
  AND NOT (EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/etc/pam.d/common-auth'
    AND contents NOT LIKE '%#%'
    AND contents LIKE '%pam_faillock.so%'
    AND (
      contents LIKE '%deny=1_%' OR contents LIKE '%deny = 1_%'
      OR contents LIKE '%deny=2_%' OR contents LIKE '%deny = 2_%'
      OR contents LIKE '%deny=3_%' OR contents LIKE '%deny = 3_%'
      OR contents LIKE '%deny=4_%' OR contents LIKE '%deny = 4_%'
      OR contents LIKE '%deny=5_%' OR contents LIKE '%deny = 5_%'
      OR contents LIKE '%deny=6_%' OR contents LIKE '%deny = 6_%'
      OR contents LIKE '%deny=7_%' OR contents LIKE '%deny = 7_%'
      OR contents LIKE '%deny=8_%' OR contents LIKE '%deny = 8_%'
      OR contents LIKE '%deny=9_%' OR contents LIKE '%deny = 9_%'
    )
) OR EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/etc/pam.d/common-auth'
    AND contents NOT LIKE '%#%'
    AND contents LIKE '%pam_faillock.so%'
    AND (
      contents LIKE '%deny=0%' OR contents LIKE '%deny = 0%'
      OR contents LIKE '%deny=6 %' OR contents LIKE '%deny = 6 %' OR contents LIKE '%deny=6' OR contents LIKE '%deny = 6'
      OR contents LIKE '%deny=7 %' OR contents LIKE '%deny = 7 %' OR contents LIKE '%deny=7' OR contents LIKE '%deny = 7'
      OR contents LIKE '%deny=8 %' OR contents LIKE '%deny = 8 %' OR contents LIKE '%deny=8' OR contents LIKE '%deny = 8'
      OR contents LIKE '%deny=9 %' OR contents LIKE '%deny = 9 %' OR contents LIKE '%deny=9' OR contents LIKE '%deny = 9'
    )
));

========================================
name: CIS Ubuntu 22.04 - 5.3.3.1.2 Ensure password unlock time is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/etc/security/faillock.conf'
    AND contents NOT LIKE '%#%'
    AND (
      contents LIKE 'unlock_time=0%' OR contents LIKE 'unlock_time = 0%'
      OR contents LIKE 'unlock_time=9__%' OR contents LIKE 'unlock_time = 9__%'
      OR contents LIKE 'unlock_time=____%' OR contents LIKE 'unlock_time = ____%'
      OR contents LIKE 'unlock_time=_____%' OR contents LIKE 'unlock_time = _____%'
    )
)
  AND NOT (EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/etc/pam.d/common-auth'
    AND contents NOT LIKE '%#%'
    AND contents LIKE '%pam_faillock.so%'
    AND (
      contents LIKE '%unlock_time=_%' OR contents LIKE '%unlock_time = _%'
      OR contents LIKE '%unlock_time=__%' OR contents LIKE '%unlock_time = __%'
      OR contents LIKE '%unlock_time=1__%' OR contents LIKE '%unlock_time = 1__%'
      OR contents LIKE '%unlock_time=2__%' OR contents LIKE '%unlock_time = 2__%'
      OR contents LIKE '%unlock_time=3__%' OR contents LIKE '%unlock_time = 3__%'
      OR contents LIKE '%unlock_time=4__%' OR contents LIKE '%unlock_time = 4__%'
      OR contents LIKE '%unlock_time=5__%' OR contents LIKE '%unlock_time = 5__%'
      OR contents LIKE '%unlock_time=6__%' OR contents LIKE '%unlock_time = 6__%'
      OR contents LIKE '%unlock_time=7__%' OR contents LIKE '%unlock_time = 7__%'
      OR contents LIKE '%unlock_time=8__%' OR contents LIKE '%unlock_time = 8__%'
    )
    AND contents NOT LIKE '%unlock_time=9__%'
    AND contents NOT LIKE '%unlock_time = 9__%'
));

========================================
name: CIS Ubuntu 22.04 - 5.3.3.1.3 Ensure password failed attempts lockout includes root account (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/etc/security/faillock.conf'
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'even_deny_root%' OR contents LIKE 'root_unlock_time=%' OR contents LIKE 'root_unlock_time = %')
)
  AND NOT (EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/etc/security/faillock.conf'
    AND contents NOT LIKE '%#%'
    AND (
      contents LIKE 'root_unlock_time=1%' OR contents LIKE 'root_unlock_time = 1%'
      OR contents LIKE 'root_unlock_time=2%' OR contents LIKE 'root_unlock_time = 2%'
      OR contents LIKE 'root_unlock_time=3%' OR contents LIKE 'root_unlock_time = 3%'
      OR contents LIKE 'root_unlock_time=4%' OR contents LIKE 'root_unlock_time = 4%'
      OR contents LIKE 'root_unlock_time=5%' OR contents LIKE 'root_unlock_time = 5%'
    )
    AND contents NOT LIKE 'root_unlock_time=6_%'
    AND contents NOT LIKE 'root_unlock_time = 6_%'
))
  AND NOT (EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/etc/pam.d/common-auth'
    AND contents NOT LIKE '%#%'
    AND contents LIKE '%pam_faillock.so%'
    AND (
      contents LIKE '%root_unlock_time=1%' OR contents LIKE '%root_unlock_time = 1%'
      OR contents LIKE '%root_unlock_time=2%' OR contents LIKE '%root_unlock_time = 2%'
      OR contents LIKE '%root_unlock_time=3%' OR contents LIKE '%root_unlock_time = 3%'
      OR contents LIKE '%root_unlock_time=4%' OR contents LIKE '%root_unlock_time = 4%'
      OR contents LIKE '%root_unlock_time=5%' OR contents LIKE '%root_unlock_time = 5%'
    )
    AND contents NOT LIKE '%root_unlock_time=6_%'
    AND contents NOT LIKE '%root_unlock_time = 6_%'
));

========================================
name: CIS Ubuntu 22.04 - 5.3.3.2.1 Ensure password number of changed characters is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.3.3.2.2 Ensure minimum password length is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.3.3.2.3 Ensure password complexity is configured (Manual)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.3.3.2.4 Ensure password same consecutive characters is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.3.3.2.5 Ensure password maximum sequential characters is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.3.3.2.6 Ensure password dictionary check is enabled (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.3.3.2.7 Ensure password quality checking is enforced (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.3.3.2.8 Ensure password quality is enforced for the root user (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.3.3.3.1 Ensure password history remember is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/etc/pam.d/common-password'
    AND contents NOT LIKE '%#%'
    AND contents LIKE '%pam_pwhistory.so%'
    AND ((contents LIKE '%remember=24%' OR contents LIKE '%remember = 24%') OR (contents LIKE '%remember=25%' OR contents LIKE '%remember = 25%') OR (contents LIKE '%remember=26%' OR contents LIKE '%remember = 26%') OR (contents LIKE '%remember=27%' OR contents LIKE '%remember = 27%') OR (contents LIKE '%remember=28%' OR contents LIKE '%remember = 28%') OR (contents LIKE '%remember=29%' OR contents LIKE '%remember = 29%') OR (contents LIKE '%remember=3_%' OR contents LIKE '%remember = 3_%') OR (contents LIKE '%remember=4_%' OR contents LIKE '%remember = 4_%') OR (contents LIKE '%remember=5_%' OR contents LIKE '%remember = 5_%') OR (contents LIKE '%remember=6_%' OR contents LIKE '%remember = 6_%') OR (contents LIKE '%remember=7_%' OR contents LIKE '%remember = 7_%') OR (contents LIKE '%remember=8_%' OR contents LIKE '%remember = 8_%') OR (contents LIKE '%remember=9_%' OR contents LIKE '%remember = 9_%') OR (contents LIKE '%remember=___%' OR contents LIKE '%remember = ___%'))
);

========================================
name: CIS Ubuntu 22.04 - 5.3.3.3.2 Ensure password history is enforced for the root user (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.3.3.3.3 Ensure pam_pwhistory includes use_authtok (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.3.3.4.1 Ensure pam_unix does not include nullok (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.3.3.4.2 Ensure pam_unix does not include remember (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.3.3.4.3 Ensure pam_unix includes a strong password hashing algorithm (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.3.3.4.4 Ensure pam_unix includes use_authtok (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.4.1.1 Ensure password expiration is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.4.1.2 Ensure minimum password days is configured (Manual)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.4.1.3 Ensure password expiration warning days is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.4.1.4 Ensure strong password hashing algorithm is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.4.1.5 Ensure inactive password lock is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.4.1.6 Ensure all users last password change date is in the past (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.4.2.1 Ensure root is the only UID 0 account (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM users
  WHERE uid=0 AND username != 'root'
);

========================================
name: CIS Ubuntu 22.04 - 5.4.2.2 Ensure root is the only GID 0 account (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM users
  WHERE gid=0 AND username != 'root'
);

========================================
name: CIS Ubuntu 22.04 - 5.4.2.3 Ensure group root is the only GID 0 group (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM groups
  WHERE gid=0 AND groupname != 'root'
);

========================================
name: CIS Ubuntu 22.04 - 5.4.2.4 Ensure root account access is controlled (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.4.2.5 Ensure root path integrity (Automated) ................................

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.4.2.6 Ensure root user umask is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.4.2.7 Ensure system accounts do not have a valid login shell (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.4.2.8 Ensure accounts without a valid login shell are locked (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.4.3.1 Ensure nologin is not listed in /etc/shells (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.4.3.2 Ensure default user shell timeout is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 5.4.3.3 Ensure default user umask is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.1.1.1.2 Ensure journald log file access is configured (Manual)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.1.1.1.3 Ensure journald log file rotation is configured (Manual)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.1.1.1.4 Ensure journald ForwardToSyslog is disabled (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/etc/systemd/journald.conf'
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'ForwardToSyslog=no%' OR contents LIKE 'ForwardToSyslog = no%')
);

========================================
name: CIS Ubuntu 22.04 - 6.1.1.1.5 Ensure journald Storage is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/etc/systemd/journald.conf'
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'Storage=persistent%' OR contents LIKE 'Storage = persistent%')
);

========================================
name: CIS Ubuntu 22.04 - 6.1.1.1.6 Ensure journald Compress is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/etc/systemd/journald.conf'
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'Compress=yes%' OR contents LIKE 'Compress = yes%')
);

========================================
name: CIS Ubuntu 22.04 - 6.1.1.2.1 Ensure systemd -journal -remote is installed (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM deb_packages WHERE name='systemd--journal--remote');

========================================
name: CIS Ubuntu 22.04 - 6.1.1.2.2 Ensure systemd -journal -upload authentication is configured (Manual)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.1.1.2.3 Ensure systemd -journal -upload is enabled and active (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (SELECT 1 FROM systemd_units WHERE name='systemd-journal-upload.service' AND enabled_state='enabled')
  AND EXISTS (SELECT 1 FROM systemd_units WHERE name='systemd-journal-upload.service' AND active_state='active');

========================================
name: CIS Ubuntu 22.04 - 6.1.1.2.4 Ensure systemd -journal -remote service is not in use (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name IN ('systemd-journal-remote.socket','systemd-journal-remote.service') AND enabled_state='enabled'
)
AND NOT EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name IN ('systemd-journal-remote.socket','systemd-journal-remote.service') AND active_state='active'
);

========================================
name: CIS Ubuntu 22.04 - 6.1.2.1 Ensure rsyslog is installed (Automated) ................................

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM deb_packages WHERE name='rsyslog');

========================================
name: CIS Ubuntu 22.04 - 6.1.2.2 Ensure rsyslog service is enabled and active (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name='rsyslog.service' AND enabled_state='enabled' AND active_state='active'
);

========================================
name: CIS Ubuntu 22.04 - 6.1.2.3 Ensure journald is configured to send logs to rsyslog (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/etc/systemd/journald.conf'
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'ForwardToSyslog=yes%' OR contents LIKE 'ForwardToSyslog = yes%')
);

========================================
name: CIS Ubuntu 22.04 - 6.1.2.4 Ensure rsyslog log file creation mode is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
WITH cfg AS (
  SELECT ltrim(replace(line, char(9), ' ')) AS l
  FROM file_contents
  WHERE (path='/etc/rsyslog.conf' OR path LIKE '/etc/rsyslog.d/%.conf')
    AND contents NOT LIKE '%#%'
),
tokens AS (
  SELECT
    CASE
      WHEN l LIKE '$FileCreateMode %' THEN
        trim(substr(l, length('$FileCreateMode ')+1))
      ELSE NULL
    END AS mode
  FROM cfg
  WHERE l LIKE '$FileCreateMode %'
),
m AS (
  SELECT substr(mode,1,4) AS m4
  FROM tokens
  WHERE mode IS NOT NULL AND length(mode) >= 4
)
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM m
  WHERE substr(m4,1,1)='0'
    AND substr(m4,2,1) IN ('0','2','4','6')
    AND substr(m4,3,1) IN ('0','2','4')
    AND substr(m4,4,1)='0'
);

========================================
name: CIS Ubuntu 22.04 - 6.1.2.5 Ensure rsyslog logging is configured (Manual)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.1.2.6 Ensure rsyslog is configured to send logs to a remote log host (Manual)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE (path='/etc/rsyslog.conf' OR path LIKE '/etc/rsyslog.d/%.conf')
    AND contents NOT LIKE '%#%'
    AND (contents LIKE '%@@%' OR contents LIKE '% @%' OR contents LIKE '%@%')
);

========================================
name: CIS Ubuntu 22.04 - 6.1.2.7 Ensure rsyslog is not configured to receive logs from a remote client (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM file_contents
  WHERE (path='/etc/rsyslog.conf' OR path LIKE '/etc/rsyslog.d/%.conf')
    AND contents NOT LIKE '%#%'
    AND (
      contents LIKE '%imtcp%' AND (contents LIKE '%module(%' OR contents LIKE '%input(%' OR contents LIKE '%$ModLoad %' OR contents LIKE '%$InputTCPServerRun%')
    )
);

========================================
name: CIS Ubuntu 22.04 - 6.1.2.8 Ensure logrotate is configured (Manual) ................................

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.1.3.1 Ensure access to all logfiles has been configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
WITH logfiles AS (
  SELECT path, type, mode
  FROM file
  WHERE path LIKE '/var/log/%'
    AND path NOT LIKE '/var/log/journal/%' -- journald binary logs handled separately
),
ww_files AS (
  SELECT 1 FROM logfiles
  WHERE type='regular'
    AND substr(mode,4,1) IN ('2','3','6','7') -- other has write
  LIMIT 1
),
ww_dirs_no_sticky AS (
  SELECT 1 FROM logfiles
  WHERE type='directory'
    AND substr(mode,4,1) IN ('2','3','6','7')
    AND (mode NOT LIKE '1%') -- sticky bit not set
  LIMIT 1
)
SELECT 1
WHERE NOT EXISTS (SELECT 1 FROM ww_files)
  AND NOT EXISTS (SELECT 1 FROM ww_dirs_no_sticky);

========================================
name: CIS Ubuntu 22.04 - 6.2.1.1 Ensure auditd packages are installed (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (SELECT 1 FROM deb_packages WHERE name='auditd')
  AND EXISTS (SELECT 1 FROM deb_packages WHERE name='audispd-plugins');

========================================
name: CIS Ubuntu 22.04 - 6.2.1.2 Ensure auditd service is enabled and active (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM systemd_units
  WHERE name='auditd.service' AND enabled_state='enabled'
);

========================================
name: CIS Ubuntu 22.04 - 6.2.1.3 Ensure auditing for processes that start prior to auditd is enabled (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/boot/grub/grub.cfg'
    AND contents LIKE 'linux %'
    AND contents LIKE '%audit=1%'
)
OR EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/etc/default/grub'
    AND contents NOT LIKE '%#%'
    AND contents LIKE 'GRUB_CMDLINE_LINUX%audit=1%'
);

========================================
name: CIS Ubuntu 22.04 - 6.2.1.4 Ensure audit_backlog_limit is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
WITH lines AS (
  SELECT contents AS l
  FROM file_contents
  WHERE path='/boot/grub/grub.cfg'
    AND l LIKE 'linux %'
    AND l LIKE '%audit_backlog_limit=%'
    AND l NOT LIKE '#%'
),
vals AS (
  SELECT
    CAST(
      CASE
        WHEN instr(substr(l, instr(l, 'audit_backlog_limit=') + 20), ' ') > 0
          THEN substr(substr(l, instr(l, 'audit_backlog_limit=') + 20), 1, instr(substr(l, instr(l, 'audit_backlog_limit=') + 20), ' ') - 1)
        ELSE substr(l, instr(l, 'audit_backlog_limit=') + 20)
      END
    AS INTEGER) AS v
  FROM lines
)
SELECT 1
WHERE EXISTS (SELECT 1 FROM vals WHERE v >= 8192);

========================================
name: CIS Ubuntu 22.04 - 6.2.2.1 Ensure audit log storage size is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.2.2 Ensure audit logs are not automatically deleted (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/etc/audit/auditd.conf'
    AND contents NOT LIKE '%#%'
    AND (
      contents LIKE 'max_log_file_action = keep_logs'
      OR contents LIKE 'max_log_file_action=keep_logs'
      OR contents LIKE 'max_log_file_action = keep_logs %'
      OR contents LIKE 'max_log_file_action=keep_logs %'
    )
);

========================================
name: CIS Ubuntu 22.04 - 6.2.2.3 Ensure system is disabled when audit logs are full (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/etc/audit/auditd.conf'
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'disk_full_action = halt%' OR contents LIKE 'disk_full_action=halt%' OR
         contents LIKE 'disk_full_action = single%' OR contents LIKE 'disk_full_action=single%')
)
AND EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/etc/audit/auditd.conf'
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'disk_error_action = syslog%' OR contents LIKE 'disk_error_action=syslog%' OR
         contents LIKE 'disk_error_action = single%' OR contents LIKE 'disk_error_action=single%' OR
         contents LIKE 'disk_error_action = halt%' OR contents LIKE 'disk_error_action=halt%')
);

========================================
name: CIS Ubuntu 22.04 - 6.2.2.4 Ensure system warns when audit logs are low on space (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/etc/audit/auditd.conf'
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'space_left_action = email%' OR contents LIKE 'space_left_action=email%' OR
         contents LIKE 'space_left_action = exec%' OR contents LIKE 'space_left_action=exec%' OR
         contents LIKE 'space_left_action = single%' OR contents LIKE 'space_left_action=single%' OR
         contents LIKE 'space_left_action = halt%' OR contents LIKE 'space_left_action=halt%')
)
AND EXISTS (
  SELECT 1 FROM file_contents
  WHERE path='/etc/audit/auditd.conf'
    AND contents NOT LIKE '%#%'
    AND (contents LIKE 'admin_space_left_action = single%' OR contents LIKE 'admin_space_left_action=single%' OR
         contents LIKE 'admin_space_left_action = halt%' OR contents LIKE 'admin_space_left_action=halt%')
);

========================================
name: CIS Ubuntu 22.04 - 6.2.3.1 Ensure changes to system administration scope (sudoers) is collected (Automated) 744

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.3.2 Ensure actions as another user are always logged (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.3.3 Ensure events that modify the sudo log file are collected (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.3.4 Ensure events that modify date and time information are collected (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.3.5 Ensure events that modify the system's network environment are collected

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.3.6 Ensure use of privileged commands are collected (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.3.7 Ensure unsuccessful file access attempts are collected (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.3.8 Ensure events that modify user/group information are collected (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.3.9 Ensure discretionary access control permission modification events are collected

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.3.10 Ensure successful file system mounts are collected (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.3.11 Ensure session initiation information is collected (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.3.12 Ensure login and logout events are collected (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.3.13 Ensure file deletion events by users are collected (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.3.14 Ensure events that modify the system's Mandatory Access Controls are collected

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.3.15 Ensure successful and unsuccessful attempts to use the chcon command are

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.3.16 Ensure successful and unsuccessful attempts to use the setfacl command are

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.3.18 Ensure successful and unsuccessful attempts to use the usermod command are

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.3.19 Ensure kernel module loading unloading and modification is collected (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.3.20 Ensure the audit configuration is immutable (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file_contents
  WHERE path LIKE '/etc/audit/rules.d/%.rules'
    AND contents NOT LIKE '%#%'
    AND (line = '-e 2' OR contents LIKE '-e 2 %' OR contents LIKE '-e 2	%')
);

========================================
name: CIS Ubuntu 22.04 - 6.2.3.21 Ensure the running and on disk configuration is the same (Manual)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.4.1 Ensure audit log files mode is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.4.2 Ensure audit log files owner is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.4.3 Ensure audit log files group owner is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.4.4 Ensure the audit log file directory mode is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.4.5 Ensure audit configuration files mode is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.4.6 Ensure audit configuration files owner is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.4.7 Ensure audit configuration files group owner is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.4.8 Ensure audit tools mode is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.4.9 Ensure audit tools owner is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.2.4.10 Ensure audit tools group owner is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.3.1 Ensure AIDE is installed (Automated) ................................

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE EXISTS (SELECT 1 FROM deb_packages WHERE name='aide');

========================================
name: CIS Ubuntu 22.04 - 6.3.2 Ensure filesystem integrity is regularly checked (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 6.3.3 Ensure cryptographic mechanisms are used to protect the integrity of audit tools

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 7.1.1 Ensure access to /etc/passwd is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file
  WHERE path='/etc/passwd' AND mode='0644' AND uid=0 AND gid=0
);

========================================
name: CIS Ubuntu 22.04 - 7.1.2 Ensure access to /etc/passwd - is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file
  WHERE path='/etc/passwd-' AND mode='0644' AND uid=0 AND gid=0
);

========================================
name: CIS Ubuntu 22.04 - 7.1.3 Ensure access to /etc/group is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file
  WHERE path='/etc/group' AND mode='0644' AND uid=0 AND gid=0
);

========================================
name: CIS Ubuntu 22.04 - 7.1.4 Ensure access to /etc/group - is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file
  WHERE path='/etc/group-' AND mode='0644' AND uid=0 AND gid=0
);

========================================
name: CIS Ubuntu 22.04 - 7.1.5 Ensure access to /etc/shadow is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file
  WHERE path='/etc/shadow' AND mode='0640' AND uid=0 AND gid=0
);

========================================
name: CIS Ubuntu 22.04 - 7.1.6 Ensure access to /etc/shadow - is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file
  WHERE path='/etc/shadow-' AND mode='0640' AND uid=0 AND gid=0
);

========================================
name: CIS Ubuntu 22.04 - 7.1.7 Ensure access to /etc/gshadow is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file
  WHERE path='/etc/gshadow' AND mode='0640' AND uid=0 AND gid=0
);

========================================
name: CIS Ubuntu 22.04 - 7.1.8 Ensure access to /etc/gshadow - is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file
  WHERE path='/etc/gshadow-' AND mode='0640' AND uid=0 AND gid=0
);

========================================
name: CIS Ubuntu 22.04 - 7.1.9 Ensure access to /etc/shells is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 7.1.10 Ensure access to /etc/security/opasswd is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE EXISTS (
  SELECT 1 FROM file
  WHERE path='/etc/passwd' AND mode='0644' AND uid=0 AND gid=0
);

========================================
name: CIS Ubuntu 22.04 - 7.1.11 Ensure world writable files and directories are secured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 7.1.12 Ensure no files or directories without an owner and a group exist (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 7.1.13 Ensure SUID and SGID files are reviewed (Manual)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

========================================
name: CIS Ubuntu 22.04 - 7.2.1 Ensure accounts in /etc/passwd use shadowed passwords (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM users
  WHERE password != 'x'
    AND password != '*'
    AND password != '!'
);

========================================
name: CIS Ubuntu 22.04 - 7.2.2 Ensure /etc/shadow password fields are not empty (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM shadow
  WHERE password = '' OR password IS NULL
);

========================================
name: CIS Ubuntu 22.04 - 7.2.3 Ensure all groups in /etc/passwd exist in /etc/group (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1
  FROM users u
  LEFT JOIN groups g ON u.gid = g.gid
  WHERE g.gid IS NULL
);

========================================
name: CIS Ubuntu 22.04 - 7.2.4 Ensure shadow group is empty (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT 1 FROM user_groups
  WHERE groupname='shadow'
);

========================================
name: CIS Ubuntu 22.04 - 7.2.5 Ensure no duplicate UIDs exist (Automated) ................................

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT uid FROM users GROUP BY uid HAVING COUNT(*) > 1
);

========================================
name: CIS Ubuntu 22.04 - 7.2.6 Ensure no duplicate GIDs exist (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT gid FROM groups GROUP BY gid HAVING COUNT(*) > 1
);

========================================
name: CIS Ubuntu 22.04 - 7.2.7 Ensure no duplicate user names exist (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT username FROM users GROUP BY username HAVING COUNT(*) > 1
);

========================================
name: CIS Ubuntu 22.04 - 7.2.8 Ensure no duplicate group names exist (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1
WHERE NOT EXISTS (
  SELECT groupname FROM groups GROUP BY groupname HAVING COUNT(*) > 1
);

========================================
name: CIS Ubuntu 22.04 - 7.2.9 Ensure local interactive user home directories are configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
WITH interactive AS (
  SELECT username, directory AS home
  FROM users
  WHERE uid >= 1000 AND uid < 65534
    AND shell NOT IN ('/usr/sbin/nologin','/bin/false')
),
missing_home AS (
  SELECT i.username, i.home
  FROM interactive i
  LEFT JOIN file f ON f.path = i.home
  WHERE f.path IS NULL OR f.type != 'directory'
),
wrong_owner AS (
  SELECT i.username, i.home
  FROM interactive i
  JOIN file f ON f.path = i.home
  WHERE f.type='directory' AND f.uid != (SELECT uid FROM users WHERE username=i.username LIMIT 1)
)
SELECT 1
WHERE NOT EXISTS (SELECT 1 FROM missing_home)
  AND NOT EXISTS (SELECT 1 FROM wrong_owner);

========================================
name: CIS Ubuntu 22.04 - 7.2.10 Ensure local interactive user dot files access is configured (Automated)

---- run to pass ----
(manual) follow CIS Audit steps; capture evidence (command output, config snippet, screenshot)

---- run to fail ----
(manual) change config on a disposable VM to violate the control; re-run audit to confirm fail

---- osquery ----
SELECT 1 WHERE 0;

