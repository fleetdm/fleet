name: Integration test updates

on:
  
  pull_request: #TODO Delete

  workflow_dispatch: # Manual
  schedule:
  - cron: '0 2 * * *' # Nightly 2AM UTC

env:
  EMAIL: admin@example.com
  PASSWORD: admin123#

jobs:
  gen:
    runs-on: ubuntu-latest
    outputs:
      subdomain: ${{ steps.gen.outputs.subdomain }}
      address: ${{ steps.gen.outputs.address }}
    steps:
    - id: gen
      run: |
        UUID=$(uuidgen)
        echo "::set-output name=subdomain::fleet-preview-$UUID"
        echo "::set-output name=address::https://fleet-preview-$UUID.loca.lt"
  
  run-server:
    runs-on: ubuntu-latest
    needs: gen
    steps:
    # Download fleet and fleetctl binaries from last successful build on main
    - name: Download binaries
      uses: dawidd6/action-download-artifact@09385b76de790122f4da9c82b17bccf858b9557c #v2.16.0
      with:
        workflow: build-binaries.yaml
        branch: main
        name: build
        path: build
        check_artifacts: true

    - name: Start tunnel
      run: |
        npm install -g localtunnel
        lt --port 1337 --subdomain ${{ needs.gen.outputs.subdomain }} &

    - name: Start Fleet server
      timeout-minutes: 15
      run: |
        chmod +x ./build/fleetctl
        ./build/fleetctl preview --no-hosts
        ./build/fleetctl config set --address ${{ needs.gen.outputs.address }}
        ./build/fleetctl get enroll-secret
        sleep 3600

  wait-server:
   runs-on: ubuntu-latest
   needs: gen
   steps:
        # Download fleet and fleetctl binaries from last successful build on main
    - name: Download binaries
      uses: dawidd6/action-download-artifact@09385b76de790122f4da9c82b17bccf858b9557c #v2.16.0
      with:
        workflow: build-binaries.yaml
        branch: main
        name: build
        path: build
        check_artifacts: true
    
    - name: Attempt login
      timeout-minutes: 5
      run: |
        chmod +x ./build/fleetctl
        ./build/fleetctl config set --address ${{ needs.gen.outputs.address }}
        until ./build/fleetctl login
        do
          echo "Retrying in 5s..."
          sleep 5
        done
      
  orbit-macos:
    runs-on: macos-latest
    needs: [gen, wait-server]
    steps:
    - name: Install dependencies
      run: |
        npm install -g fleetctl
    - name: Install Orbit
      run: |
        fleetctl config set --address ${{ needs.gen.outputs.address }}
        fleetctl login
        SECRET=$(fleetctl get enroll_secret --json | jq -r '.spec.secrets[0].secret')
        echo "Secret: $SECRET"
        echo "Hostname: $(hostname -s)"
        fleetctl package --type pkg --fleet-url=${{ needs.gen.outputs.address }} --enroll-secret=$SECRET
        sudo installer -pkg fleet-osquery.pkg -target /
        until fleetctl get hosts | grep -iF $(hostname -s);
        do
          echo "Awaiting enrollment..."
          sleep 1
        done

  orbit-ubuntu:
    runs-on: ubuntu-latest
    needs: [gen, wait-server]
    steps:
    - name: Install dependencies
      run: |
        npm install -g fleetctl
    - name: Install Orbit
      run: |
        fleetctl config set --address ${{ needs.gen.outputs.address }}
        fleetctl login
        SECRET=$(fleetctl get enroll_secret --json | jq -r '.spec.secrets[0].secret')
        echo "Secret: $SECRET"
        echo "Hostname: $(hostname -s)"
        fleetctl package --type deb --fleet-url=${{ needs.gen.outputs.address }} --enroll-secret=$SECRET
        sudo dpkg -i fleet-osquery*
        until fleetctl get hosts | grep -iF $(hostname -s);
        do
          echo "Awaiting enrollment..."
          sudo systemctl status orbit.service || true
          tail /var/log/orbit/orbit.stderr.log || true
          sleep 1
        done