name: Check QA test plan confirmation

# This action runs when an issue is moved on a GitHub Project board.
# When an item is moved into the "✔️Awaiting QA" column, it checks if the
# QA test plan confirmation checklist item is checked. If not, it adds a
# comment to remind the engineer to check it before QA begins.

on:
  projects_v2_item:
    types: [edited]

permissions:
  contents: read

jobs:
  check-testplan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Check test plan confirmation when moved to Awaiting QA
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const awaitingQAColumn = "✔️Awaiting QA";
            const checkText = "Engineer: Added comment to user story confirming successful completion of test plan.";

            // Get the project item details
            const projectItemNodeId = context.payload.projects_v2_item.node_id;

            // Check if this is a status field change to "Awaiting QA"
            const changes = context.payload.changes;
            if (!changes || !changes.field_value) {
              console.log("Not a field value change, skipping");
              return;
            }

            // Log the change details for debugging
            console.log("Field value changed from:", changes.field_value.from, "to:", changes.field_value.to);

            // Query the project item to get current status
            const query = `query($nodeId: ID!) {
              node(id: $nodeId) {
                ... on ProjectV2Item {
                  id
                  fieldValues(first: 20) {
                    nodes {
                      ... on ProjectV2ItemFieldSingleSelectValue {
                        name
                        field {
                          ... on ProjectV2SingleSelectField {
                            name
                          }
                        }
                      }
                    }
                  }
                  content {
                    ... on Issue {
                      number
                      title
                      body
                    }
                  }
                }
              }
            }`;

            const result = await github.graphql(query, {
              nodeId: projectItemNodeId
            });

            if (!result.node) {
              console.log("Could not fetch project item details");
              return;
            }

            const item = result.node;

            // Check if the item is now in "Awaiting QA" column
            // This check ensures we only act when an item has been moved TO Awaiting QA
            // (The event triggers when field_value changes, so if it's now in Awaiting QA
            //  and wasn't before, this is a move into the column)
            let isInAwaitingQA = false;
            if (item.fieldValues && item.fieldValues.nodes) {
              for (const fieldValue of item.fieldValues.nodes) {
                if (fieldValue.name === awaitingQAColumn) {
                  isInAwaitingQA = true;
                  break;
                }
              }
            }

            if (!isInAwaitingQA) {
              console.log("Item is not in Awaiting QA column, skipping");
              return;
            }

            console.log("Item has been moved to Awaiting QA column");

            // Get the issue body
            let body = "";
            let number = 0;
            let title = "";

            if (item.content && item.content.number) {
              number = item.content.number;
              title = item.content.title;
              body = item.content.body || "";
            } else {
              console.log("Could not retrieve issue details, skipping (item may be a PR or draft)");
              return;
            }

            console.log(`Checking issue #${number}: ${title}`);

            // Check for unchecked test plan line
            const unchecked1 = "- [ ] " + checkText;
            const unchecked2 = "[ ] " + checkText;
            const checked = [
              "- [x] " + checkText,
              "- [X] " + checkText,
              "[x] " + checkText,
              "[X] " + checkText,
            ];

            // If checkbox is checked, we're good
            for (const checkedVariant of checked) {
              if (body.includes(checkedVariant)) {
                console.log("✅ Test plan confirmation is checked");
                return;
              }
            }

            // If unchecked checkbox exists, add a comment
            if (body.includes(unchecked1) || body.includes(unchecked2)) {
              console.log("❌ Test plan confirmation is UNCHECKED");

              const commentBody = "⚠️ This issue has been moved to **" + awaitingQAColumn + "** but the QA test plan confirmation checklist item is not checked.\n\n" +
                "Please ensure the following checklist item is checked before QA begins:\n\n" +
                "* " + checkText;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: number,
                body: commentBody
              });

              console.log("Added comment to issue #" + number);
            } else {
              console.log("⚠️ Test plan confirmation checklist not found in body");
            }
