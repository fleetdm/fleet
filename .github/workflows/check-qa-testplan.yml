name: Check QA test plan confirmation

on:
  projects_v2_item:
    types: [edited]

permissions:
  contents: read

jobs:
  check-testplan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Check test plan confirmation when moved to Awaiting QA
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const awaitingQAColumn = "✔️Awaiting QA";
            const checkText = "Engineer: Added comment to user story confirming successful completion of test plan.";

            // Get the project item details
            const projectItemNodeId = context.payload.projects_v2_item.node_id;
            
            // Check if this is a status field change to "Awaiting QA"
            const changes = context.payload.changes;
            if (!changes || !changes.field_value) {
              console.log("Not a field value change, skipping");
              return;
            }

            // Query the project item to get current status
            const query = `query($nodeId: ID!) {
              node(id: $nodeId) {
                ... on ProjectV2Item {
                  id
                  fieldValues(first: 20) {
                    nodes {
                      ... on ProjectV2ItemFieldSingleSelectValue {
                        name
                        field {
                          ... on ProjectV2SingleSelectField {
                            name
                          }
                        }
                      }
                    }
                  }
                  content {
                    ... on Issue {
                      number
                      title
                      body
                      url
                    }
                    ... on PullRequest {
                      number
                      title
                      body
                      url
                    }
                  }
                }
              }
            }`;

            const result = await github.graphql(query, {
              nodeId: projectItemNodeId
            });

            if (!result.node) {
              console.log("Could not fetch project item details");
              return;
            }

            const item = result.node;
            
            // Check if the item is now in "Awaiting QA" column
            let isInAwaitingQA = false;
            if (item.fieldValues && item.fieldValues.nodes) {
              for (const fieldValue of item.fieldValues.nodes) {
                if (fieldValue.name === awaitingQAColumn) {
                  isInAwaitingQA = true;
                  break;
                }
              }
            }

            if (!isInAwaitingQA) {
              console.log("Item is not in Awaiting QA column, skipping");
              return;
            }

            // Get the issue/PR body
            let body = "";
            let number = 0;
            let title = "";
            let itemType = "";

            if (item.content) {
              if (item.content.number) {
                number = item.content.number;
                title = item.content.title;
                body = item.content.body || "";
                // Determine if it's an issue or PR based on URL
                itemType = item.content.url.includes("/pull/") ? "pull_request" : "issue";
              }
            }

            if (!number) {
              console.log("Could not determine issue/PR number");
              return;
            }

            console.log(`Checking ${itemType} #${number}: ${title}`);

            // Check for unchecked test plan line
            const unchecked1 = "- [ ] " + checkText;
            const unchecked2 = "[ ] " + checkText;
            const checked = [
              "- [x] " + checkText,
              "- [X] " + checkText,
              "[x] " + checkText,
              "[X] " + checkText,
            ];

            // If checkbox is checked, we're good
            for (const checkedVariant of checked) {
              if (body.includes(checkedVariant)) {
                console.log("✅ Test plan confirmation is checked");
                return;
              }
            }

            // If unchecked checkbox exists, add a comment
            if (body.includes(unchecked1) || body.includes(unchecked2)) {
              console.log("❌ Test plan confirmation is UNCHECKED");

              const commentBody = "⚠️ This " + itemType + " has been moved to **" + awaitingQAColumn + "** but the QA test plan confirmation checklist item is not checked.\n\n" +
                "Please ensure the following checklist item is checked before QA begins:\n\n" +
                "- [x] " + checkText;

              if (itemType === "issue") {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: number,
                  body: commentBody
                });
              } else {
                await github.rest.pulls.createReview({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: number,
                  body: commentBody,
                  event: "COMMENT"
                });
              }

              console.log("Added comment to " + itemType + " #" + number);
            } else {
              console.log("⚠️ Test plan confirmation checklist not found in body");
            }
